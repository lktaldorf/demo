<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LKT Tracker 2026</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent-yellow: #f5c518;
            --accent-gold: #ffd700;
            --accent-green: #4ade80;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Open Sans', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent-yellow); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 1rem; color: var(--text-secondary); }
        .header { background: linear-gradient(135deg, var(--bg-card) 0%, #0f0f23 100%); padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 3px solid var(--accent-yellow); }
        .header h1 { font-family: 'Bangers', cursive; font-size: 1.6rem; color: var(--accent-yellow); letter-spacing: 2px; }
        .header .user-info { display: inline-block; background: var(--accent-yellow); color: var(--bg-dark); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; margin-top: 0.5rem; }
        .header .user-info.gericht { background: var(--accent-gold); }
        .header .user-info.chef { background: var(--accent-blue); }
        .nav-tabs { display: flex; background: var(--bg-card); border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .nav-tab { flex: 1; min-width: max-content; padding: 0.75rem 0.5rem; text-align: center; cursor: pointer; transition: all 0.3s; border: none; background: none; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
        .nav-tab.active { color: var(--accent-yellow); border-bottom: 3px solid var(--accent-yellow); }
        .screen { display: none; padding: 1rem; }
        .screen.active { display: block; }
        .setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; text-align: center; }
        .setup-screen h1 { font-family: 'Bangers', cursive; font-size: 2.5rem; color: var(--accent-yellow); margin-bottom: 0.5rem; }
        .setup-screen .subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .setup-box { background: var(--bg-card); padding: 2rem; border-radius: 16px; width: 100%; max-width: 400px; }
        .role-buttons { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .role-btn { padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; background: transparent; color: var(--text-primary); cursor: pointer; transition: all 0.3s; text-align: left; }
        .role-btn:hover, .role-btn.selected { border-color: var(--accent-yellow); background: rgba(255, 215, 0, 0.1); }
        .role-btn .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .role-btn .title { font-weight: 700; font-size: 1.1rem; }
        .role-btn .desc { font-size: 0.85rem; color: var(--text-secondary); }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-dark); color: var(--text-primary); font-size: 1rem; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: var(--accent-yellow); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
        .btn-primary { background: var(--accent-yellow); color: var(--bg-dark); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-success { background: var(--accent-green); color: var(--bg-dark); }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; }
        .event-card { border-left: 4px solid var(--border-color); }
        .event-card.attended { border-left-color: var(--accent-green); }
        .event-card.absent { border-left-color: var(--accent-red); }
        .event-card.planned { border-left-color: var(--accent-blue); }
        .event-card .date { font-size: 0.8rem; color: var(--text-secondary); }
        .event-card .title { font-weight: 700; margin: 0.25rem 0; }
        .event-card .location { font-size: 0.85rem; color: var(--text-secondary); }
        .event-card .status { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem; }
        .event-card .status.present { background: rgba(74, 222, 128, 0.2); color: var(--accent-green); }
        .event-card .status.absent { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .event-card .status.planned { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .event-card .actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .event-card .actions .btn { flex: 1; padding: 0.5rem; font-size: 0.8rem; min-width: 80px; }
        .week-header { background: linear-gradient(90deg, var(--accent-yellow), transparent); color: var(--bg-dark); font-weight: 700; padding: 0.5rem 1rem; border-radius: 8px; margin: 1rem 0 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-card); padding: 1rem; border-radius: 12px; text-align: center; }
        .stat-card .number { font-size: 2rem; font-weight: 700; color: var(--accent-yellow); }
        .stat-card .label { font-size: 0.85rem; color: var(--text-secondary); }
        .leaderboard-item { display: flex; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .leaderboard-item .rank { width: 30px; height: 30px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 1rem; }
        .leaderboard-item:nth-child(1) .rank { background: gold; color: #000; }
        .leaderboard-item:nth-child(2) .rank { background: silver; color: #000; }
        .leaderboard-item:nth-child(3) .rank { background: #cd7f32; color: #fff; }
        .leaderboard-item .name { flex: 1; }
        .leaderboard-item .score { font-weight: 700; color: var(--accent-green); }
        .leaderboard-item .score.bad { color: var(--accent-red); }
        .anzeige-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid var(--accent-red); }
        .anzeige-card .header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .anzeige-card .vs { font-weight: 700; color: var(--accent-yellow); }
        .anzeige-card .date { font-size: 0.8rem; color: var(--text-secondary); }
        .anzeige-card .tatbestand { font-size: 0.9rem; color: var(--text-secondary); padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 0.5rem 0; }
        .anzeige-card .strafe { font-size: 0.85rem; color: var(--accent-red); font-weight: 600; }
        .info-box { background: rgba(245, 197, 24, 0.1); border: 1px solid var(--accent-yellow); border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .info-box p { font-size: 0.9rem; color: var(--text-secondary); }
        .section-header { margin: 1.5rem 0 1rem; }
        .section-header h2 { font-size: 1.1rem; color: var(--accent-yellow); border-bottom: 2px solid var(--accent-yellow); padding-bottom: 0.5rem; }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent-green); color: white; padding: 1rem 2rem; border-radius: 8px; opacity: 0; transition: opacity 0.3s; z-index: 9999; font-weight: 600; }
        .toast.show { opacity: 1; }
        .toast.error { background: var(--accent-red); }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--accent-red); color: white; text-align: center; padding: 0.5rem; font-size: 0.8rem; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s; }
        .offline-banner.show { transform: translateY(0); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 500; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 1rem; color: var(--accent-yellow); }
        .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .modal-actions .btn { flex: 1; }
        .config-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; z-index: 100; }
        .hidden { display: none !important; }
        #qr-reader { border: 2px solid var(--accent-yellow); border-radius: 12px; overflow: hidden; }
        .attendance-row { display: flex; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; gap: 0.75rem; }
        .attendance-row .member-name { flex: 1; font-weight: 600; font-size: 0.95rem; }
        .attendance-buttons { display: flex; gap: 0.5rem; }
        .att-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color); background: transparent; color: var(--text-secondary); font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
        .att-btn:hover { border-color: var(--accent-yellow); }
        .att-btn.present { background: var(--accent-green); border-color: var(--accent-green); color: white; }
        .att-btn.absent { background: var(--accent-red); border-color: var(--accent-red); color: white; }
        .filter-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filter-row select { flex: 1; min-width: 120px; }
        .tag { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; }
        .tag.bus { background: var(--accent-blue); color: white; }
        .tag.register { background: var(--accent-purple); color: white; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .list-item .name { font-weight: 600; }
        .list-item .actions { display: flex; gap: 0.5rem; }
        .plan-btn { padding: 0.3rem 0.6rem; font-size: 0.75rem; border-radius: 4px; }
        .plan-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .brett-post { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid var(--accent-green); }
        .brett-post .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .brett-post .post-title { font-weight: 700; font-size: 1.1rem; color: var(--accent-yellow); }
        .brett-post .post-meta { font-size: 0.75rem; color: var(--text-secondary); }
        .brett-post .post-content { color: var(--text-primary); line-height: 1.5; margin: 0.75rem 0; white-space: pre-wrap; }
        .brett-post .post-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .kommentar { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; margin-left: 1rem; border-left: 2px solid var(--border-color); }
        .kommentar .kom-header { display: flex; justify-content: space-between; font-size: 0.8rem; }
        .kommentar .kom-autor { font-weight: 600; color: var(--accent-blue); }
        .kommentar .kom-date { color: var(--text-secondary); }
        .kommentar .kom-text { margin-top: 0.25rem; font-size: 0.9rem; }
        .kommentare-section { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); position: relative; }
        .kommentar-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; position: relative; z-index: 10; }
        .kommentar-input input { flex: 1; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-dark); color: var(--text-primary); -webkit-appearance: none; appearance: none; }
        .kommentar-input input:focus { outline: none; border-color: var(--accent-yellow); background: var(--bg-card); }
        .kommentar-input input::placeholder { color: var(--text-secondary); }
        .setting-item { margin-bottom: 1rem; }
        .setting-desc { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; margin-left: 0.5rem; }
        .toggle-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .toggle-label input { display: none; }
        .toggle-slider { width: 50px; height: 26px; background: var(--border-color); border-radius: 13px; position: relative; transition: 0.3s; }
        .toggle-slider::before { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-label input:checked + .toggle-slider { background: var(--accent-green); }
        .toggle-label input:checked + .toggle-slider::before { transform: translateX(24px); }
        .zusage-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: 2px solid var(--accent-green); background: transparent; color: var(--accent-green); transition: all 0.2s; }
        .zusage-btn.active { background: var(--accent-green); color: white; }
        .zusage-btn:hover { opacity: 0.8; }
        .register-member { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .register-member .status { font-size: 1.2rem; }
        .register-member.zugesagt { border-left: 3px solid var(--accent-green); }
        .register-member.nicht-zugesagt { border-left: 3px solid var(--border-color); opacity: 0.7; }
        .badge { background: var(--accent-red); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.5rem; }
        .rolle-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid var(--accent-purple); }
        .rolle-item .rolle-name { font-weight: 600; }
        .rolle-item .rolle-perms { font-size: 0.75rem; color: var(--text-secondary); }
        .rolle-item.system-rolle { border-left-color: var(--accent-yellow); }
        .anfrage-item { padding: 1rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--accent-orange); }
        .anfrage-item .anfrage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .anfrage-item .anfrage-change { color: var(--text-secondary); font-size: 0.9rem; }
        .anfrage-item .anfrage-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .bereich-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .bereich-item .bereich-typ { font-size: 0.75rem; color: var(--text-secondary); }
        .forum-tabs { display: flex; overflow-x: auto; gap: 0.5rem; padding: 0.5rem 0; margin-bottom: 1rem; }
        .forum-tab { padding: 0.5rem 1rem; border-radius: 20px; background: var(--bg-card); border: none; color: var(--text-primary); cursor: pointer; white-space: nowrap; font-size: 0.9rem; }
        .forum-tab.active { background: var(--accent-blue); color: white; }
        .forum-tab.register-tab { border-left: 3px solid var(--accent-purple); }
        .weekend-event-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; border-left: 4px solid var(--accent-blue); transition: transform 0.2s; }
        .weekend-event-card:hover { transform: translateX(5px); }
        .weekend-event-card .event-name { font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; }
        .weekend-event-card .event-info { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .weekend-event-card .register-bars { display: flex; flex-direction: column; gap: 0.25rem; }
        .register-bar { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
        .register-bar .bar-label { width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .register-bar .bar-container { flex: 1; height: 16px; background: var(--bg-input); border-radius: 8px; overflow: hidden; }
        .register-bar .bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); border-radius: 8px; transition: width 0.3s; }
        .register-bar .bar-count { width: 50px; text-align: right; font-weight: 600; }
        .weekend-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .weekend-summary .stat-box { background: var(--bg-card); padding: 0.75rem; border-radius: 8px; text-align: center; }
        .weekend-summary .stat-box .number { font-size: 1.5rem; font-weight: 700; }
        .weekend-summary .stat-box .label { font-size: 0.75rem; color: var(--text-secondary); }
        .member-attendance-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .member-attendance-row .status-icon { font-size: 1.2rem; }
        .member-attendance-row.anwesend { border-left: 3px solid var(--accent-green); }
        .member-attendance-row.abwesend { border-left: 3px solid var(--accent-red); opacity: 0.8; }
        .member-attendance-row.unknown { border-left: 3px solid var(--border-color); opacity: 0.6; }
        --accent-orange: #f97316;
        --accent-red: #ef4444;
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading"><div class="spinner"></div><div class="loading-text">Laden...</div></div>
    <div class="offline-banner" id="offline-banner">âš ï¸ Offline - Daten werden lokal gespeichert</div>
    
    <!-- Setup Screen -->
    <div class="setup-screen" id="setup-screen">
        <h1>ğŸº LKT TRACKER</h1>
        <p class="subtitle">Saison 2026</p>
        <div class="setup-box">
            <div id="setup-step-1" class="hidden"></div>
            <div id="setup-step-2" class="hidden">
                <h3 style="margin-bottom: 1rem;">Wer bist du?</h3>
                <div class="role-buttons">
                    <button class="role-btn" onclick="selectRole('member')">
                        <div class="icon">ğŸº</div>
                        <div class="title">Mitglied</div>
                        <div class="desc">Anwesenheit tracken & Strafanzeigen erstellen</div>
                    </button>
                    <button class="role-btn" onclick="selectRole('gericht')">
                        <div class="icon">âš–ï¸</div>
                        <div class="title">Admin</div>
                        <div class="desc">Admin-Zugang mit speziellem PIN</div>
                    </button>
                </div>
            </div>
            <div id="setup-step-3" class="hidden">
                <h3 style="margin-bottom: 1rem;">ğŸº Mitglied Login</h3>
                <div class="input-group"><label>Dein Name</label><input type="text" id="member-name-input" placeholder="Max Mustermann"></div>
                <div class="input-group"><label>Deine PIN (4 Ziffern)</label><input type="number" id="member-pin-input" placeholder="1234" maxlength="4"></div>
                <button class="btn btn-primary btn-block" onclick="loginMember()">Einloggen</button>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem; text-align: center;">
                    Noch nicht registriert? <a href="#" onclick="showStep(4); return false;" style="color: var(--accent-yellow);">Hier registrieren</a>
                </p>
            </div>
            <div id="setup-step-4" class="hidden">
                <h3 style="margin-bottom: 1rem;">ğŸº Neu registrieren</h3>
                <div class="input-group"><label>Dein Name</label><input type="text" id="register-name-input" placeholder="Max Mustermann"></div>
                <div class="input-group"><label>WÃ¤hle eine PIN (4 Ziffern)</label><input type="number" id="register-pin-input" placeholder="1234" maxlength="4"></div>
                <button class="btn btn-primary btn-block" onclick="registerMember()">Registrieren</button>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem; text-align: center;">
                    Bereits registriert? <a href="#" onclick="showStep(3); return false;" style="color: var(--accent-yellow);">Zum Login</a>
                </p>
            </div>
            <div id="setup-step-5" class="hidden">
                <h3 style="margin-bottom: 1rem;">âš–ï¸ Admin Login</h3>
                <div class="input-group"><label>Gericht-PIN</label><input type="password" id="gericht-pin-input" placeholder="****"></div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">Nur fÃ¼r das Hohe Gericht</p>
                <button class="btn btn-primary btn-block" onclick="loginGericht()">Einloggen</button>
                <button class="btn btn-secondary btn-block" style="margin-top: 0.5rem;" onclick="showStep(2)">ZurÃ¼ck</button>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="main-app" class="hidden">
        <div class="header">
            <h1>ğŸº LKT TRACKER 2026</h1>
            <div class="user-info" id="user-info">Mitglied</div>
        </div>
        
        <!-- Member Navigation -->
        <nav class="nav-tabs" id="member-nav">
            <button class="nav-tab active" data-tab="events">ğŸ“… Auftritte</button>
            <button class="nav-tab" data-tab="brett">ğŸ“‹ Brett</button>
            <button class="nav-tab" data-tab="register-view">ğŸµ Register</button>
            <button class="nav-tab hidden" data-tab="scanner" id="nav-scanner">ğŸ“· Scannen</button>
            <button class="nav-tab" data-tab="profile">ğŸ‘¤ Profil</button>
            <button class="nav-tab hidden" data-tab="anzeige" id="nav-anzeige">âš–ï¸ Anzeige</button>
            <button class="nav-tab" data-tab="stats">ğŸ“Š Stats</button>
        </nav>
        
        <!-- Gericht Navigation -->
        <nav class="nav-tabs hidden" id="gericht-nav">
            <button class="nav-tab active" data-tab="overview">ğŸ“Š Ãœbersicht</button>
            <button class="nav-tab" data-tab="my-events">ğŸ“… Meine Auftritte</button>
            <button class="nav-tab" data-tab="attendance">âœ… Anwesenheit</button>
            <button class="nav-tab" data-tab="qr-codes" id="nav-qr-codes">ğŸ“± QR-Codes</button>
            <button class="nav-tab" data-tab="brett-gericht">ğŸ“‹ Brett</button>
            <button class="nav-tab" data-tab="members">ğŸ‘¥ Mitglieder</button>
            <button class="nav-tab" data-tab="anzeigen">âš–ï¸ Anzeigen</button>
            <button class="nav-tab" data-tab="rankings">ğŸ† Ranglisten</button>
            <button class="nav-tab" data-tab="settings">âš™ï¸ Einstellungen</button>
        </nav>
        
        <!-- Member Screens -->
        <div id="member-screens">
            <!-- Events Tab -->
            <div id="events-tab" class="screen active">
                <div class="section-header"><h2>Deine Auftritte</h2></div>
                <div id="events-list"></div>
            </div>
            
            <!-- Schwarzes Brett Tab -->
            <div id="brett-tab" class="screen">
                <div class="section-header"><h2>ğŸ“‹ Schwarzes Brett</h2></div>
                <div class="forum-tabs" id="forum-tabs-member"></div>
                <div class="card" id="new-post-form">
                    <h3 style="margin-bottom: 0.75rem; color: var(--accent-yellow);">âœï¸ Neuer Beitrag</h3>
                    <div class="input-group"><input type="text" id="post-titel" placeholder="Titel"></div>
                    <div class="input-group"><textarea id="post-inhalt" rows="3" placeholder="Was gibt's Neues?"></textarea></div>
                    <button class="btn btn-primary btn-block" onclick="submitBrettPost()">ğŸ“¤ VerÃ¶ffentlichen</button>
                </div>
                <div id="brett-posts-member"></div>
            </div>
            
            <!-- Register View Tab -->
            <div id="register-view-tab" class="screen">
                <div class="section-header"><h2>ğŸµ Mein Register</h2></div>
                <div class="input-group">
                    <label>Auftritt auswÃ¤hlen</label>
                    <select id="register-event-select" onchange="loadRegisterZusagen()">
                        <option value="">-- Auftritt wÃ¤hlen --</option>
                    </select>
                </div>
                <div id="register-zusagen-info" class="info-box hidden">
                    <p><strong id="register-name-display">-</strong></p>
                    <p id="register-zusagen-count">0 / 0 haben zugesagt</p>
                </div>
                <div id="register-members-list"></div>
            </div>
            
            <!-- Scanner Tab -->
            <div id="scanner-tab" class="screen">
                <div class="section-header"><h2>ğŸ“· QR-Code Scannen</h2></div>
                <div class="info-box"><p>ğŸ“± Scanne den QR-Code beim Auftritt!</p></div>
                <div id="qr-reader" style="width: 100%; max-width: 400px; margin: 1rem auto;"></div>
                <button class="btn btn-primary btn-block" id="start-scan-btn" onclick="startScanner()">ğŸ“· Scanner starten</button>
                <button class="btn btn-secondary btn-block hidden" id="stop-scan-btn" onclick="stopScanner()">â¹ Scanner stoppen</button>
                <div id="scan-success" class="hidden" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem;">âœ…</div>
                    <p style="font-size: 1.2rem; font-weight: 700; margin-top: 1rem;" id="success-text">Eingecheckt!</p>
                </div>
                <!-- Bus Selection Modal for Scan -->
                <div class="modal-overlay" id="bus-select-modal">
                    <div class="modal">
                        <h3>ğŸšŒ Bus auswÃ¤hlen</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">WÃ¤hle deinen Bus fÃ¼r diesen Auftritt:</p>
                        <div class="input-group">
                            <select id="checkin-bus-select"><option value="">-- Kein Bus --</option></select>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="cancelBusSelect()">Abbrechen</button>
                            <button class="btn btn-primary" onclick="confirmBusSelect()">Einchecken</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Tab (NEW) -->
            <div id="profile-tab" class="screen">
                <div class="section-header"><h2>ğŸ‘¤ Mein Profil</h2></div>
                <div class="card">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">ğŸº</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="profile-name">-</div>
                    </div>
                    <div class="input-group">
                        <label>Mein fester Bus</label>
                        <select id="profile-bus"><option value="">-- Kein fester Bus --</option></select>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Optional - wird beim Einchecken vorausgefÃ¼llt</p>
                    </div>
                    <div class="input-group">
                        <label>Mein Register</label>
                        <select id="profile-register"><option value="">-- Register wÃ¤hlen --</option></select>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="saveProfile()">ğŸ’¾ Profil speichern</button>
                </div>
                
                <!-- Push-Benachrichtigungen -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ”” Benachrichtigungen</h3>
                    <div id="push-not-supported" class="hidden">
                        <p style="color: var(--accent-red);">Push-Benachrichtigungen werden in diesem Browser nicht unterstÃ¼tzt.</p>
                    </div>
                    <div id="push-settings-container">
                        <button class="btn btn-secondary btn-block" id="push-enable-btn" onclick="enablePushNotifications()">ğŸ”” Benachrichtigungen aktivieren</button>
                        <div id="push-settings" class="hidden" style="margin-top: 1rem;">
                            <div class="setting-item">
                                <label class="toggle-label">
                                    <span>ğŸ“… Event-Erinnerungen</span>
                                    <input type="checkbox" id="push-event-reminder" onchange="savePushSettingsLocal()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="input-group" id="reminder-time-group">
                                <label>Erinnerungszeit vor Event</label>
                                <select id="push-reminder-time" onchange="savePushSettingsLocal()">
                                    <option value="30">30 Minuten vorher</option>
                                    <option value="60">1 Stunde vorher</option>
                                    <option value="120">2 Stunden vorher</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label class="toggle-label">
                                    <span>ğŸ’¬ Neue Forum-BeitrÃ¤ge</span>
                                    <input type="checkbox" id="push-forum-posts" onchange="savePushSettingsLocal()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label class="toggle-label">
                                    <span>ğŸµ BeitrÃ¤ge in meinem Register</span>
                                    <input type="checkbox" id="push-register-posts" onchange="savePushSettingsLocal()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-danger btn-block" style="margin-top: 1rem;" onclick="logout()">ğŸšª Ausloggen</button>
            </div>
            
            <!-- Anzeige Tab -->
            <div id="anzeige-tab" class="screen">
                <div class="section-header"><h2>âš–ï¸ Strafanzeige erstatten</h2></div>
                <div class="info-box" style="background: rgba(239,68,68,0.1); border-color: var(--accent-red);">
                    <p>ğŸš¨ Entsprechend der Satzung des Vereins wird es dem Anzeigenden ermÃ¶glicht, einen Vorschlag fÃ¼r ein angemessenes StrafmaÃŸ vorzuschlagen.</p>
                </div>
                <div class="input-group"><label>Name des Beschuldigten *</label><input type="text" id="anzeige-beschuldigter" placeholder="Wer hat was verbrochen?"></div>
                <div class="input-group"><label>Tatbestand *</label><textarea id="anzeige-tatbestand" rows="3" placeholder="Was ist passiert? Wann, wo?"></textarea></div>
                <div class="input-group"><label>Zeugen</label><input type="text" id="anzeige-zeugen" placeholder="Namen der Zeugen (optional)"></div>
                <div class="input-group"><label>Strafvorschlag *</label><input type="text" id="anzeige-strafe" placeholder="z.B. 1 Kasten Bier"></div>
                <button class="btn btn-danger btn-block" onclick="submitAnzeige()">âš–ï¸ Anzeige einreichen</button>
            </div>
            
            <!-- Stats Tab -->
            <div id="stats-tab" class="screen">
                <div class="section-header"><h2>Deine Statistik</h2></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="number" id="my-attended">0</div><div class="label">Teilgenommen</div></div>
                    <div class="stat-card"><div class="number" id="my-missed">0</div><div class="label">Verpasst</div></div>
                </div>
                <div class="stat-card" style="text-align: center;">
                    <div class="number" id="my-rate">0%</div><div class="label">Anwesenheitsquote</div>
                </div>
            </div>
        </div>
        
        <!-- Gericht Screens -->
        <div id="gericht-screens" class="hidden">
            <!-- Overview Tab -->
            <div id="overview-tab" class="screen active">
                <div class="section-header"><h2>ğŸ“Š Ãœbersicht</h2></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="number" id="total-members">0</div><div class="label">Mitglieder</div></div>
                    <div class="stat-card"><div class="number" id="total-events">0</div><div class="label">Auftritte</div></div>
                    <div class="stat-card"><div class="number" id="total-checkins">0</div><div class="label">Check-ins</div></div>
                    <div class="stat-card"><div class="number" id="total-anzeigen">0</div><div class="label">Anzeigen</div></div>
                </div>
                <div class="stat-card" style="text-align: center;">
                    <div class="number" id="overall-rate">0%</div><div class="label">Gesamte Anwesenheitsquote</div>
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="refreshData()">ğŸ”„ Daten aktualisieren</button>
                <button class="btn btn-secondary btn-block" style="margin-top: 0.5rem;" onclick="exportReportPDF()">ğŸ“„ Saison-Report PDF</button>
                <div class="section-header"><h2>ğŸšŒ Bus-Statistik</h2></div>
                <div id="bus-stats-list"></div>
                <button class="btn btn-secondary btn-block" onclick="exportBusStatsPDF()">ğŸ“„ Bus-Statistik PDF</button>
                <div class="section-header"><h2>ğŸµ Register-Statistik</h2></div>
                <div id="register-stats-list"></div>
                <button class="btn btn-secondary btn-block" onclick="exportRegisterStatsPDF()">ğŸ“„ Register-Statistik PDF</button>
            </div>
            
            <!-- Meine Auftritte Tab (fÃ¼r Admin/Chef zum selbst anmelden) -->
            <div id="my-events-tab" class="screen">
                <div class="section-header"><h2>ğŸ“… Meine Auftritte</h2></div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">Hier kannst du dich selbst zu Auftritten anmelden.</p>
                <div id="my-events-list"></div>
            </div>
            
            <!-- QR-Codes Tab -->
            <div id="qr-codes-tab" class="screen">
                <div class="section-header"><h2>ğŸ“± Auftritts-QR-Codes</h2></div>
                <div class="info-box" style="background: rgba(234,179,8,0.1); border-color: var(--accent-yellow);">
                    <p>Zeige den QR-Code beim Auftritt - Mitglieder kÃ¶nnen ihn scannen um einzuchecken.</p>
                </div>
                <div class="input-group">
                    <label>Auftritt auswÃ¤hlen</label>
                    <select id="qr-event-select" onchange="showEventQR()"><option value="">-- Auftritt wÃ¤hlen --</option></select>
                </div>
                <div id="event-qr-display" class="hidden" style="text-align: center; padding: 1rem;">
                    <div id="event-qr-canvas" style="display: inline-block; background: white; padding: 1rem; border-radius: 12px;"></div>
                    <p style="margin-top: 1rem; font-weight: 700; font-size: 1.2rem;" id="event-qr-label"></p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);" id="event-qr-sublabel"></p>
                    <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="downloadEventQRPDF()">ğŸ“„ QR-Code als PDF</button>
                    <button class="btn btn-secondary btn-block" style="margin-top: 0.5rem;" onclick="downloadEventQR()">ğŸ“¥ QR als Bild</button>
                </div>
            </div>
            
            <!-- Schwarzes Brett Tab (Gericht) -->
            <div id="brett-gericht-tab" class="screen">
                <div class="section-header"><h2>ğŸ“‹ Schwarzes Brett</h2></div>
                <div class="forum-tabs" id="forum-tabs-admin"></div>
                <div class="card">
                    <h3 style="margin-bottom: 0.75rem; color: var(--accent-yellow);">âœï¸ Neuer Beitrag</h3>
                    <div class="input-group"><input type="text" id="post-titel-gericht" placeholder="Titel"></div>
                    <div class="input-group"><textarea id="post-inhalt-gericht" rows="3" placeholder="Wichtige Mitteilung..."></textarea></div>
                    <button class="btn btn-primary btn-block" onclick="submitBrettPostGericht()">ğŸ“¤ VerÃ¶ffentlichen</button>
                </div>
                <div id="brett-posts-gericht"></div>
            </div>
            
            <!-- Attendance Tab -->
            <div id="attendance-tab" class="screen">
                <div class="section-header"><h2>âœ… Anwesenheitsverwaltung</h2></div>
                <div class="input-group">
                    <label>Auftritt auswÃ¤hlen</label>
                    <select id="attendance-event-select" onchange="loadEventAttendance()"><option value="">-- Auftritt wÃ¤hlen --</option></select>
                </div>
                <div class="filter-row">
                    <select id="att-filter-register" onchange="renderAttendanceTable()"><option value="">Alle Register</option></select>
                    <select id="att-filter-week" onchange="renderAttendanceTable()"><option value="">Alle Wochenenden</option></select>
                </div>
                <div id="attendance-table-container" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                        <div>
                            <span style="color: var(--accent-green);">âœ“ <span id="att-count-present">0</span></span> | 
                            <span style="color: var(--accent-red);">âœ— <span id="att-count-absent">0</span></span> | 
                            <span style="color: var(--accent-blue);">ğŸ“… <span id="att-count-planned">0</span></span> |
                            <span style="color: var(--text-secondary);">? <span id="att-count-unknown">0</span></span>
                        </div>
                        <button class="btn btn-secondary" onclick="saveAllAttendance()" style="padding: 0.5rem 1rem;">ğŸ’¾ Speichern</button>
                    </div>
                    <div id="attendance-table" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
                
                <!-- Wochenend-Ãœbersicht -->
                <div class="section-header" style="margin-top: 2rem;"><h2>ğŸ“… Wochenend-Ãœbersicht</h2></div>
                <div class="input-group">
                    <label>Wochenende auswÃ¤hlen</label>
                    <select id="weekend-select" onchange="loadWeekendOverview()">
                        <option value="">-- Wochenende wÃ¤hlen --</option>
                    </select>
                </div>
                <button class="btn btn-secondary btn-block hidden" id="weekend-export-btn" onclick="exportWeekendPDF()" style="margin-bottom: 1rem;">ğŸ“„ Wochenend-Ãœbersicht als PDF</button>
                <div id="weekend-overview"></div>
                
                <!-- Event-Detail Modal fÃ¼r Wochenende -->
                <div class="modal-overlay" id="weekend-event-modal">
                    <div class="modal">
                        <h3 id="weekend-event-title">Event Details</h3>
                        <div id="weekend-event-stats" style="margin: 1rem 0;"></div>
                        <div class="section-header"><h4>Nach Register</h4></div>
                        <div id="weekend-event-registers"></div>
                        <div class="section-header" style="margin-top: 1rem;"><h4>Teilnehmer</h4></div>
                        <div id="weekend-event-members" style="max-height: 300px; overflow-y: auto;"></div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeWeekendEventModal()">SchlieÃŸen</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Members Tab -->
            <div id="members-tab" class="screen">
                <div class="section-header"><h2>ğŸ‘¥ Mitglieder</h2></div>
                <div class="filter-row">
                    <select id="member-filter-register" onchange="filterMembersList()"><option value="">Alle Register</option></select>
                    <select id="member-filter-bus" onchange="filterMembersList()"><option value="">Alle Busse</option></select>
                </div>
                <button class="btn btn-secondary btn-block" style="margin-bottom: 1rem;" onclick="exportAllMembersPDF()">ğŸ“„ Alle Mitglieder als PDF</button>
                <div id="members-list"></div>
            </div>
            
            <!-- Anzeigen Tab -->
            <div id="anzeigen-tab" class="screen">
                <div class="section-header"><h2>âš–ï¸ Strafanzeigen</h2></div>
                <button class="btn btn-secondary btn-block" style="margin-bottom: 1rem;" onclick="exportAnzeigenPDF()">ğŸ“„ Anzeigen als PDF</button>
                <div id="anzeigen-list"></div>
            </div>
            
            <!-- Rankings Tab -->
            <div id="rankings-tab" class="screen">
                <div class="section-header"><h2>ğŸ† Top 10 FleiÃŸigste</h2></div>
                <div id="top-attenders"></div>
                <div class="section-header"><h2>ğŸ˜´ Top 10 Faulste</h2></div>
                <div id="top-absent"></div>
            </div>
            
            <!-- Settings Tab (NEW) -->
            <div id="settings-tab" class="screen">
                <div class="section-header"><h2>âš™ï¸ Vereinseinstellungen</h2></div>
                
                <!-- API-URL Konfiguration - nur fÃ¼r Admin -->
                <div class="card" id="api-url-section">
                    <h3 style="color: var(--accent-blue); margin-bottom: 1rem;">ğŸ”— API-Verbindung</h3>
                    <div class="input-group">
                        <label>Google Apps Script URL</label>
                        <input type="text" id="setting-api-url" placeholder="https://script.google.com/...">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="saveApiUrl()">ğŸ’¾ URL speichern</button>
                    <p class="setting-desc" style="margin-top: 0.5rem;">Die Web-App URL deines Google Apps Script Deployments</p>
                </div>
                
                <!-- App-Modi - nur fÃ¼r Admin -->
                <div class="card" id="app-modi-section" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-green); margin-bottom: 1rem;">ğŸ“± App-Modi</h3>
                    <div class="setting-item">
                        <label class="toggle-label">
                            <span>ğŸ“· QR-Scanner aktiviert</span>
                            <input type="checkbox" id="setting-qr-scanner" onchange="saveAppSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                        <p class="setting-desc">Wenn deaktiviert, kÃ¶nnen Mitglieder direkt "Ich bin dabei" klicken</p>
                    </div>
                    <div class="setting-item">
                        <label class="toggle-label">
                            <span>âš–ï¸ Strafen-System aktiviert</span>
                            <input type="checkbox" id="setting-strafen" onchange="saveAppSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                        <p class="setting-desc">Wenn deaktiviert, werden Anzeigen-Funktionen ausgeblendet</p>
                    </div>
                </div>
                
                <!-- Register-Anfragen -->
                <div class="card" id="register-anfragen-section" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-orange); margin-bottom: 1rem;">ğŸ“‹ Register-Wechsel Anfragen <span class="badge" id="anfragen-count">0</span></h3>
                    <div id="register-anfragen-list"></div>
                </div>
                
                <!-- Rollen verwalten - nur fÃ¼r Admin -->
                <div class="card" id="rollen-section" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-red); margin-bottom: 1rem;">ğŸ‘‘ Rollen verwalten</h3>
                    <div id="rollen-list"></div>
                    <button class="btn btn-secondary btn-block" style="margin-top: 1rem;" onclick="showAddRolleModal()">+ Neue Rolle erstellen</button>
                </div>
                
                <!-- Forum-Bereiche verwalten -->
                <div class="card" id="forum-bereiche-section" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-green); margin-bottom: 1rem;">ğŸ’¬ Forum-Bereiche</h3>
                    <div id="forum-bereiche-list"></div>
                    <div class="input-group" style="margin-top: 1rem;">
                        <input type="text" id="new-bereich-name" placeholder="Neuer Bereich-Name">
                    </div>
                    <div class="input-group">
                        <select id="new-bereich-typ">
                            <option value="custom">Allgemeiner Bereich</option>
                            <option value="register">Register-Bereich (fÃ¼r alle Register)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addNewForumBereich()">+ Bereich hinzufÃ¼gen</button>
                </div>
                
                <!-- Busse verwalten -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-blue); margin-bottom: 1rem;">ğŸšŒ Busse verwalten</h3>
                    <div id="busse-list"></div>
                    <div class="input-group" style="margin-top: 1rem;">
                        <input type="text" id="new-bus-name" placeholder="Neuer Bus-Name (z.B. Bus 1)">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addNewBus()">+ Bus hinzufÃ¼gen</button>
                </div>
                
                <!-- Register verwalten -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸµ Register verwalten</h3>
                    <div id="register-list"></div>
                    <div class="input-group" style="margin-top: 1rem;">
                        <input type="text" id="new-register-name" placeholder="Neues Register (z.B. Klarinette)">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addNewRegister()">+ Register hinzufÃ¼gen</button>
                </div>
                
                <!-- Events verwalten -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 1rem;">ğŸ“… Veranstaltungen verwalten</h3>
                    
                    <!-- Bestehende Events -->
                    <div class="section-header"><h4>Bestehende Events</h4></div>
                    <div id="events-manage-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;"></div>
                    
                    <div class="section-header"><h4>Neues Event</h4></div>
                    <div class="input-group"><label>Name *</label><input type="text" id="new-event-name" placeholder="z.B. Extraauftritt"></div>
                    <div class="input-group"><label>Woche</label><input type="text" id="new-event-week" placeholder="z.B. WE 3 oder Extra"></div>
                    <div class="input-group"><label>Datum</label><input type="text" id="new-event-date" placeholder="TT.MM.JJJJ"></div>
                    <div class="input-group"><label>Ort</label><input type="text" id="new-event-location" placeholder="z.B. Vereinsheim"></div>
                    <div class="input-group"><label>Uhrzeit</label><input type="text" id="new-event-time" placeholder="z.B. 20:00"></div>
                    <button class="btn btn-primary btn-block" onclick="addNewEvent()">+ Event hinzufÃ¼gen</button>
                </div>
                
                <button class="btn btn-danger btn-block" style="margin-top: 2rem;" onclick="logout()">ğŸšª Ausloggen</button>
            </div>
            
            <!-- Event bearbeiten Modal -->
            <div class="modal-overlay" id="event-edit-modal">
                <div class="modal">
                    <h3>Event bearbeiten</h3>
                    <input type="hidden" id="edit-event-id">
                    <div class="input-group"><label>Name *</label><input type="text" id="edit-event-name"></div>
                    <div class="input-group"><label>Woche</label><input type="text" id="edit-event-week"></div>
                    <div class="input-group"><label>Datum</label><input type="text" id="edit-event-date"></div>
                    <div class="input-group"><label>Ort</label><input type="text" id="edit-event-location"></div>
                    <div class="input-group"><label>Uhrzeit</label><input type="text" id="edit-event-time"></div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeEventEditModal()">Abbrechen</button>
                        <button class="btn btn-danger" onclick="deleteEventFromModal()">ğŸ—‘ï¸ LÃ¶schen</button>
                        <button class="btn btn-primary" onclick="saveEventEdit()">ğŸ’¾ Speichern</button>
                    </div>
                </div>
            </div>
            
            <!-- Rolle bearbeiten Modal -->
            <div class="modal-overlay" id="rolle-modal">
                <div class="modal" style="max-height: 90vh; overflow-y: auto;">
                    <h3 id="rolle-modal-title">Rolle bearbeiten</h3>
                    <div class="input-group"><label>Rollenname</label><input type="text" id="rolle-name-input" placeholder="z.B. Registerleiter"></div>
                    <div class="section-header"><h4>Berechtigungen</h4></div>
                    <div class="setting-item"><label class="toggle-label"><span>Alle Mitglieder sehen</span><input type="checkbox" id="perm-viewAllMembers"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Alle Anwesenheiten sehen</span><input type="checkbox" id="perm-viewAllAttendance"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Eigenes Register sehen</span><input type="checkbox" id="perm-viewOwnRegister"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Events verwalten</span><input type="checkbox" id="perm-manageEvents"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Mitglieder verwalten</span><input type="checkbox" id="perm-manageMembers"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Rollen verwalten</span><input type="checkbox" id="perm-manageRoles"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Anzeigen verwalten</span><input type="checkbox" id="perm-manageAnzeigen"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>Forum-Bereiche erstellen</span><input type="checkbox" id="perm-createForumCategories"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>ğŸ”§ Admin-Rechte</span><input type="checkbox" id="perm-isAdmin"><span class="toggle-slider"></span></label></div>
                    <div class="setting-item"><label class="toggle-label"><span>ğŸµ Registerleiter</span><input type="checkbox" id="perm-isRegisterleiter"><span class="toggle-slider"></span></label></div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeRolleModal()">Abbrechen</button>
                        <button class="btn btn-primary" onclick="saveRolle()">Speichern</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comment Modal -->
    <div class="modal-overlay" id="comment-modal">
        <div class="modal">
            <h3>Grund fÃ¼r Abwesenheit</h3>
            <div class="input-group"><textarea id="comment-input" rows="3" placeholder="Optional: Warum kannst du nicht?"></textarea></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveAbsent()">Speichern</button>
            </div>
        </div>
    </div>
    
    <!-- Teilnehmer Modal (Wer ist dabei?) -->
    <div class="modal-overlay" id="participants-modal">
        <div class="modal" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 id="participants-modal-title">Wer ist dabei?</h3>
            <div id="participants-loading" style="text-align: center; padding: 2rem;">
                <div class="loading-spinner"></div>
                <p>Lade Teilnehmer...</p>
            </div>
            <div id="participants-content" class="hidden">
                <div id="participants-stats" style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;"></div>
                <div class="section-header"><h4>Nach Register</h4></div>
                <div id="participants-by-register"></div>
                <div class="section-header" style="margin-top: 1rem;"><h4>Teilnehmerliste</h4></div>
                <div id="participants-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-secondary btn-block" onclick="closeParticipantsModal()">SchlieÃŸen</button>
            </div>
        </div>
    </div>
    
    <!-- Member Detail Modal -->
    <div class="modal-overlay" id="member-detail-modal">
        <div class="modal" style="max-width: 500px;">
            <h3 id="member-detail-name">Mitglied</h3>
            <div style="margin: 0.5rem 0;">
                <span class="tag bus" id="member-detail-bus"></span>
                <span class="tag register" id="member-detail-register"></span>
            </div>
            <div class="stats-grid" style="margin: 1rem 0;">
                <div class="stat-card"><div class="number" id="member-detail-present">0</div><div class="label">Dabei</div></div>
                <div class="stat-card"><div class="number" id="member-detail-absent">0</div><div class="label">Gefehlt</div></div>
            </div>
            <div class="stat-card" style="text-align: center; margin-bottom: 1rem;">
                <div class="number" id="member-detail-rate">0%</div><div class="label">Anwesenheitsquote</div>
            </div>
            <div class="input-group" id="member-role-group">
                <label>Rolle Ã¤ndern</label>
                <select id="member-detail-role">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </select>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveMemberRole()" id="save-role-btn">Rolle speichern</button>
            <div class="section-header"><h2>Auftritte</h2></div>
            <div id="member-detail-events" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeMemberDetail()">SchlieÃŸen</button>
                <button class="btn btn-primary" onclick="exportMemberPDF()">ğŸ“„ PDF</button>
            </div>
        </div>
    </div>
    
    <button class="config-btn" id="config-btn" onclick="showConfig()">ğŸ”„</button>
    <div class="toast" id="toast"></div>

    <script>
        // ============================================================
        // CONFIG & STATE
        // ============================================================
        const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbwxD6P2S4diBwI5etPTHHpuxhHj675TYENqRhPTj4EXXOAs9XI7BMuRa0T9BBkMu4hM/exec';
        let API_URL = localStorage.getItem('lkt-api-url') || DEFAULT_API_URL;
        let currentUser = JSON.parse(localStorage.getItem('lkt-user') || 'null');
        let isOfflineMode = localStorage.getItem('lkt-offline') === 'true';
        
        // Data cache
        let eventsData = [];
        let attendanceData = {};
        let commentsData = {};
        let statsData = {};
        let busseData = [];
        let registerData = [];
        let zusagenData = {};
        let allMembersData = [];
        let allMemberStats = {};
        let allAnzeigenData = [];
        let brettPostsData = [];
        let kommentareData = {};
        
        // App Settings
        let appSettings = {
            qrScannerEnabled: true,
            strafenEnabled: true
        };
        
        let currentAbsentEventId = null;
        let currentAttendanceEventId = null;
        let attendanceByMember = {};
        let zusagenByMember = {};
        let pendingScanEventId = null;
        let currentDetailMember = null;
        
        let offlineQueue = JSON.parse(localStorage.getItem('lkt-offline-queue') || '[]');
        
        // ============================================================
        // LOKALER CACHE
        // ============================================================
        const CACHE_KEY = 'lkt-data-cache';
        const CACHE_EXPIRY = 5 * 60 * 1000; // 5 Minuten
        
        function saveToCache(key, data) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                cache[key] = { data: data, timestamp: Date.now() };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) { console.log('Cache save error:', e); }
        }
        
        function getFromCache(key) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                if (cache[key] && (Date.now() - cache[key].timestamp) < CACHE_EXPIRY) {
                    return cache[key].data;
                }
            } catch (e) { console.log('Cache read error:', e); }
            return null;
        }
        
        function loadCachedData() {
            // Sofort lokale Daten laden
            const cached = {
                events: getFromCache('events'),
                busse: getFromCache('busse'),
                register: getFromCache('register'),
                members: getFromCache('members'),
                stats: getFromCache('stats'),
                settings: getFromCache('settings'),
                brett: getFromCache('brett'),
                forumBereiche: getFromCache('forumBereiche')
            };
            
            if (cached.events) eventsData = cached.events;
            if (cached.busse) busseData = cached.busse;
            if (cached.register) registerData = cached.register;
            if (cached.members) allMembersData = cached.members;
            if (cached.stats) statsData = cached.stats;
            if (cached.settings) {
                appSettings.qrScannerEnabled = cached.settings.qrScannerEnabled !== 'false';
                appSettings.strafenEnabled = cached.settings.strafenEnabled !== 'false';
            }
            if (cached.brett) brettPostsData = cached.brett;
            if (cached.forumBereiche) forumBereicheData = cached.forumBereiche;
            
            return cached;
        }
        
        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            updateOnlineStatus();
            window.addEventListener('online', onOnline);
            window.addEventListener('offline', updateOnlineStatus);
            
            if (currentUser) {
                showMainApp();
            } else {
                hideLoading();
                showStep(2);
            }
        }
        
        function onOnline() {
            updateOnlineStatus();
            if (offlineQueue.length > 0 && navigator.onLine) syncOfflineQueue();
        }
        
        function updateOnlineStatus() {
            const banner = document.getElementById('offline-banner');
            if (!navigator.onLine) {
                banner.classList.add('show');
                banner.innerHTML = 'âš ï¸ Offline - ' + offlineQueue.length + ' Aktion(en) warten';
            } else {
                if (offlineQueue.length > 0) {
                    banner.classList.add('show');
                    banner.innerHTML = 'ğŸ”„ Synchronisiere...';
                    banner.style.background = '#4ade80';
                } else {
                    banner.classList.remove('show');
                    banner.style.background = '#ef4444';
                }
            }
        }
        
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
        
        // ============================================================
        // OFFLINE QUEUE
        // ============================================================
        function addToOfflineQueue(actionData) {
            const queueItem = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                timestamp: Date.now(),
                data: actionData
            };
            offlineQueue.push(queueItem);
            localStorage.setItem('lkt-offline-queue', JSON.stringify(offlineQueue));
            updateOnlineStatus();
        }
        
        async function syncOfflineQueue() {
            if (offlineQueue.length === 0 || !navigator.onLine) return;
            showToast('Synchronisiere ' + offlineQueue.length + ' Aktion(en)...');
            const queue = [...offlineQueue];
            let successCount = 0;
            for (const item of queue) {
                try {
                    const result = await apiPost(item.data);
                    if (!result.error) {
                        offlineQueue = offlineQueue.filter(q => q.id !== item.id);
                        successCount++;
                    }
                } catch (e) { console.error('Sync error:', e); }
            }
            localStorage.setItem('lkt-offline-queue', JSON.stringify(offlineQueue));
            updateOnlineStatus();
            if (successCount > 0) { showToast('âœ“ ' + successCount + ' synchronisiert!'); loadData(); }
        }
        
        // ============================================================
        // API FUNCTIONS
        // ============================================================
        async function apiGet(action, params = {}) {
            let url = API_URL + '?action=' + action;
            for (const [key, value] of Object.entries(params)) {
                url += '&' + key + '=' + encodeURIComponent(value);
            }
            const response = await fetch(url);
            return await response.json();
        }
        
        async function apiPost(data) {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
            return await response.json();
        }
        
        // ============================================================
        // SETUP & LOGIN
        // ============================================================
        function showStep(step) {
            for (let i = 1; i <= 5; i++) document.getElementById('setup-step-' + i).classList.add('hidden');
            document.getElementById('setup-step-' + step).classList.remove('hidden');
        }
        
        function selectRole(role) { showStep(role === 'member' ? 3 : 5); }
        
        async function registerMember() {
            const name = document.getElementById('register-name-input').value.trim();
            const pin = document.getElementById('register-pin-input').value.trim();
            if (!name || !pin || pin.length !== 4) { showToast('Name und 4-stellige PIN erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'registerMember', name: name, pin: pin });
                if (result.error) { showToast(result.error, true); hideLoading(); return; }
                currentUser = { role: 'member', name: name, pin: pin };
                localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                showToast('Erfolgreich registriert!');
                showMainApp();
            } catch (e) { showToast('Fehler: ' + e.message, true); hideLoading(); }
        }
        
        async function loginMember() {
            const name = document.getElementById('member-name-input').value.trim();
            const pin = document.getElementById('member-pin-input').value.trim();
            if (!name || !pin || pin.length !== 4) { showToast('Name und 4-stellige PIN erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiGet('getMemberAttendance', { name: name });
                if (result.error) { showToast('Name nicht gefunden', true); hideLoading(); return; }
                if (String(result.pin) !== String(pin)) { showToast('Falscher PIN', true); hideLoading(); return; }
                
                // Berechtigungen laden
                const permResult = await apiGet('getMemberPermissions', { name: name });
                const permissions = permResult.permissions || {};
                const rollenId = result.rollenId || permResult.rollenId || 'ROLE-MITGLIED';
                
                // Admin-Rollen bekommen gericht-View, andere member-View
                if (permissions.isAdmin || permissions.canManageMembers || permissions.canManageEvents) {
                    currentUser = { 
                        role: 'gericht', name: result.name, pin: pin, 
                        rollenId: rollenId, permissions: permissions,
                        busId: result.busId, registerId: result.registerId, memberId: result.memberId
                    };
                } else {
                    currentUser = { 
                        role: 'member', name: result.name, pin: pin, 
                        rollenId: rollenId, permissions: permissions,
                        busId: result.busId, registerId: result.registerId, memberId: result.memberId
                    };
                }
                
                localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                showToast('Willkommen, ' + result.name + '!');
                showMainApp();
            } catch (e) { showToast('Fehler: ' + e.message, true); hideLoading(); }
        }
        
        function loginGericht() {
            const pin = document.getElementById('gericht-pin-input').value.trim();
            
            if (pin === '8356') {
                currentUser = { 
                    role: 'gericht', name: 'Admin', 
                    rollenId: 'ROLE-ADMIN', 
                    permissions: {
                        isAdmin: true, canViewAllMembers: true, canViewAllAttendance: true,
                        canViewOwnRegister: true, canManageEvents: true, canManageMembers: true,
                        canManageRoles: true, canManageAnzeigen: true, canCreateForumCategories: true
                    }
                };
            } else {
                showToast('Falscher PIN', true); return;
            }
            localStorage.setItem('lkt-user', JSON.stringify(currentUser));
            showToast('Willkommen, Admin!');
            showMainApp();
        }
        
        function logout() {
            if (!confirm('Wirklich ausloggen?')) return;
            localStorage.removeItem('lkt-user');
            currentUser = null;
            location.reload();
        }
        
        // ============================================================
        // MAIN APP
        // ============================================================
        async function showMainApp() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            attendanceData = {};
            commentsData = {};
            
            const userInfo = document.getElementById('user-info');
            const permissions = currentUser.permissions || {};
            
            if (currentUser.role === 'gericht') {
                // Admin/Verwaltung-Ansicht
                if (permissions.isAdmin) {
                    userInfo.textContent = 'ğŸ”§ ' + currentUser.name + ' (Admin)';
                    userInfo.classList.add('gericht');
                } else {
                    userInfo.textContent = 'ğŸ‘” ' + currentUser.name;
                    userInfo.classList.add('chef');
                }
                document.getElementById('member-nav').classList.add('hidden');
                document.getElementById('gericht-nav').classList.remove('hidden');
                document.getElementById('member-screens').classList.add('hidden');
                document.getElementById('gericht-screens').classList.remove('hidden');
                document.getElementById('config-btn').textContent = 'ğŸ”„'; // Auch fÃ¼r Admin: Aktualisierung
                
                // Tabs basierend auf Berechtigungen ein/ausblenden
                if (!permissions.canManageAnzeigen) {
                    const anzeigenTab = document.querySelector('[data-tab="anzeigen"]');
                    if (anzeigenTab) anzeigenTab.classList.add('hidden');
                }
                
                initGerichtNav();
            } else {
                document.getElementById('config-btn').textContent = 'ğŸ”„';
                userInfo.textContent = 'ğŸ‘¤ ' + currentUser.name;
                initMemberNav();
                eventsData = getOfflineEvents();
                loadLocalAttendance();
                renderMemberView();
            }
            
            hideLoading();
            loadData();
        }
        
        function initMemberNav() {
            const tabs = document.querySelectorAll('#member-nav .nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('#member-screens .screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                    
                    // Scanner-Handling bei Tab-Wechsel
                    if (tab.dataset.tab === 'scanner') {
                        if (scannerRunning) {
                            resumeScanner();
                        } else {
                            // Automatisch starten beim ersten Besuch
                            setTimeout(initScanner, 300);
                        }
                    } else {
                        pauseScanner();
                    }
                });
            });
        }
        
        function initGerichtNav() {
            const tabs = document.querySelectorAll('#gericht-nav .nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('#gericht-screens .screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });
        }
        
        // ============================================================
        // DATA LOADING
        // ============================================================
        async function loadData() {
            try {
                // SOFORT: Cached Daten laden und anzeigen
                loadCachedData();
                if (eventsData.length === 0) eventsData = getOfflineEvents();
                
                // Sofort UI rendern mit gecachten Daten
                if (currentUser.role === 'member') {
                    loadLocalAttendance();
                    renderMemberView();
                    populateProfileSelects();
                    populateRegisterEventSelect();
                    renderForumTabs();
                    renderBrettPostsFromCache();
                } else {
                    renderGerichtView();
                }
                
                // DANN: Im Hintergrund frische Daten laden
                if (navigator.onLine && !isOfflineMode) {
                    loadFreshDataInBackground();
                }
            } catch (e) {
                console.error('loadData error:', e);
                if (eventsData.length === 0) eventsData = getOfflineEvents();
            }
        }
        
        async function loadFreshDataInBackground() {
            try {
                // Parallel laden fÃ¼r bessere Performance
                const promises = [
                    apiGet('getSettings').catch(e => null),
                    apiGet('getBusse').catch(e => null),
                    apiGet('getRegister').catch(e => null),
                    apiGet('getEvents').catch(e => null)
                ];
                
                const [settingsResult, busseResult, registerResult, eventsResult] = await Promise.all(promises);
                
                // Settings
                if (settingsResult?.settings) {
                    appSettings.qrScannerEnabled = settingsResult.settings.qrScannerEnabled !== 'false';
                    appSettings.strafenEnabled = settingsResult.settings.strafenEnabled !== 'false';
                    saveToCache('settings', settingsResult.settings);
                    applyAppSettings();
                }
                
                // Busse
                if (busseResult?.busse) {
                    busseData = busseResult.busse;
                    saveToCache('busse', busseData);
                }
                
                // Register
                if (registerResult?.register) {
                    registerData = registerResult.register;
                    saveToCache('register', registerData);
                }
                
                // Events
                if (eventsResult?.events) {
                    eventsData = eventsResult.events;
                    saveToCache('events', eventsData);
                }
                
                // Aktualisiere UI mit frischen Daten
                if (currentUser.role === 'member') {
                    // Member-spezifische Daten laden
                    try {
                        const attResult = await apiGet('getMemberAttendance', { name: currentUser.name });
                        if (!attResult.error) {
                            attendanceData = attResult.attendance || {};
                            commentsData = attResult.comments || {};
                            currentUser.busId = attResult.busId;
                            currentUser.registerId = attResult.registerId;
                            localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                            saveLocalAttendance();
                        }
                        const zusagenResult = await apiGet('getZusagen');
                        zusagenData = zusagenResult.zusagen || {};
                    } catch (e) { console.log('Member data error:', e); }
                    
                    if (offlineQueue.length > 0) syncOfflineQueue();
                    renderMemberView();
                    populateProfileSelects();
                    populateRegisterEventSelect();
                    
                    // Forum laden
                    try { await loadForumBereiche(); } catch (e) {}
                    loadBrettPosts('member');
                    initPushNotifications();
                } else {
                    // Gericht-spezifische Daten - AUCH eigene Anwesenheit laden!
                    try { statsData = await apiGet('getStats'); saveToCache('stats', statsData); } catch (e) {}
                    
                    // Eigene Anwesenheit fÃ¼r "Meine Auftritte" Tab laden
                    try {
                        const attResult = await apiGet('getMemberAttendance', { name: currentUser.name });
                        if (!attResult.error) {
                            attendanceData = attResult.attendance || {};
                            currentUser.busId = attResult.busId;
                            currentUser.registerId = attResult.registerId;
                        }
                        const zusagenResult = await apiGet('getZusagen');
                        zusagenData = zusagenResult.zusagen || {};
                    } catch (e) { console.log('Gericht attendance error:', e); }
                    
                    renderGerichtView();
                }
            } catch (e) {
                console.error('Background load error:', e);
            }
        }
        
        function renderBrettPostsFromCache() {
            // Zeige cached Brett-Posts sofort an
            if (brettPostsData.length > 0) {
                renderBrettPosts(currentUser.role === 'gericht' ? 'gericht' : 'member');
            }
        }
        
        function applyAppSettings() {
            const permissions = currentUser ? currentUser.permissions || {} : {};
            
            // Scanner Tab anzeigen/verstecken (fÃ¼r Mitglieder)
            const scannerNav = document.getElementById('nav-scanner');
            if (scannerNav) {
                if (appSettings.qrScannerEnabled) {
                    scannerNav.classList.remove('hidden');
                } else {
                    scannerNav.classList.add('hidden');
                }
            }
            
            // QR-Codes Tab anzeigen/verstecken (fÃ¼r Gericht/Admin)
            const qrCodesNav = document.getElementById('nav-qr-codes');
            if (qrCodesNav) {
                if (appSettings.qrScannerEnabled) {
                    qrCodesNav.classList.remove('hidden');
                } else {
                    qrCodesNav.classList.add('hidden');
                }
            }
            
            // Anzeige Tab anzeigen/verstecken
            const anzeigeNav = document.getElementById('nav-anzeige');
            if (anzeigeNav) {
                if (appSettings.strafenEnabled) {
                    anzeigeNav.classList.remove('hidden');
                } else {
                    anzeigeNav.classList.add('hidden');
                }
            }
            
            // Anzeigen-Tab in Gericht Navigation
            const gerichtAnzeigenNav = document.querySelector('#gericht-nav [data-tab="anzeigen"]');
            if (gerichtAnzeigenNav) {
                if (appSettings.strafenEnabled && permissions.canManageAnzeigen) {
                    gerichtAnzeigenNav.classList.remove('hidden');
                } else {
                    gerichtAnzeigenNav.classList.add('hidden');
                }
            }
            
            // API-URL Section nur fÃ¼r Admin
            const apiUrlSection = document.getElementById('api-url-section');
            if (apiUrlSection) {
                if (permissions.isAdmin) {
                    apiUrlSection.classList.remove('hidden');
                    document.getElementById('setting-api-url').value = API_URL;
                } else {
                    apiUrlSection.classList.add('hidden');
                }
            }
            
            // App-Modi Section nur fÃ¼r Admin
            const appModiSection = document.getElementById('app-modi-section');
            if (appModiSection) {
                if (permissions.isAdmin) {
                    appModiSection.classList.remove('hidden');
                } else {
                    appModiSection.classList.add('hidden');
                }
            }
            
            // Register-Anfragen Section nur fÃ¼r Admin
            const anfragenSection = document.getElementById('register-anfragen-section');
            if (anfragenSection) {
                if (permissions.isAdmin || permissions.canManageMembers) {
                    anfragenSection.classList.remove('hidden');
                } else {
                    anfragenSection.classList.add('hidden');
                }
            }
            
            // Rollen Section nur fÃ¼r Admin
            const rollenSection = document.getElementById('rollen-section');
            if (rollenSection) {
                if (permissions.isAdmin || permissions.canManageRoles) {
                    rollenSection.classList.remove('hidden');
                } else {
                    rollenSection.classList.add('hidden');
                }
            }
            
            // Forum-Bereiche Section nur fÃ¼r Admin
            const forumBereicheSection = document.getElementById('forum-bereiche-section');
            if (forumBereicheSection) {
                if (permissions.isAdmin || permissions.canCreateForumCategories) {
                    forumBereicheSection.classList.remove('hidden');
                } else {
                    forumBereicheSection.classList.add('hidden');
                }
            }
            
            // Settings-Checkboxen aktualisieren
            const qrCheckbox = document.getElementById('setting-qr-scanner');
            const strafenCheckbox = document.getElementById('setting-strafen');
            if (qrCheckbox) qrCheckbox.checked = appSettings.qrScannerEnabled;
            if (strafenCheckbox) strafenCheckbox.checked = appSettings.strafenEnabled;
        }
        
        function saveApiUrl() {
            const newUrl = document.getElementById('setting-api-url').value.trim();
            if (newUrl) {
                API_URL = newUrl;
                localStorage.setItem('lkt-api-url', API_URL);
                showToast('API URL gespeichert!');
            } else {
                API_URL = DEFAULT_API_URL;
                localStorage.removeItem('lkt-api-url');
                showToast('API URL zurÃ¼ckgesetzt');
            }
        }
        
        async function saveAppSettings() {
            const qrEnabled = document.getElementById('setting-qr-scanner').checked;
            const strafenEnabled = document.getElementById('setting-strafen').checked;
            
            appSettings.qrScannerEnabled = qrEnabled;
            appSettings.strafenEnabled = strafenEnabled;
            
            try {
                await apiPost({
                    action: 'updateSettings',
                    settings: {
                        qrScannerEnabled: qrEnabled ? 'true' : 'false',
                        strafenEnabled: strafenEnabled ? 'true' : 'false'
                    }
                });
                applyAppSettings();
                showToast('Einstellungen gespeichert!');
            } catch (e) {
                showToast('Fehler beim Speichern', true);
            }
        }
        
        async function refreshData() { showLoading(); await loadData(); hideLoading(); showToast('Daten aktualisiert'); }
        
        // ============================================================
        // MEMBER VIEW
        // ============================================================
        function renderMemberView() {
            renderEventsList();
            updateMemberStats();
            document.getElementById('profile-name').textContent = currentUser.name;
        }
        
        function renderEventsList() {
            const container = document.getElementById('events-list');
            let html = '';
            let currentWeek = '';
            
            eventsData.forEach(event => {
                if (event.week !== currentWeek) {
                    currentWeek = event.week;
                    html += '<div class="week-header">' + currentWeek + '</div>';
                }
                
                const status = attendanceData[event.id];
                const isAttended = status === true;
                const isAbsent = status === false;
                const hasZugesagt = zusagenData[event.id] && zusagenData[event.id][currentUser.name];
                
                // ZÃ¤hle Zusagen fÃ¼r diesen Event
                const zusagenCount = zusagenData[event.id] ? Object.keys(zusagenData[event.id]).filter(k => zusagenData[event.id][k]).length : 0;
                
                let cardClass = 'card event-card';
                if (isAttended) cardClass += ' attended';
                else if (isAbsent) cardClass += ' absent';
                else if (hasZugesagt) cardClass += ' planned';
                
                html += '<div class="' + cardClass + '">';
                html += '<div class="date">' + (event.date || '') + ' â€¢ ' + (event.time || '') + '</div>';
                html += '<div class="title">' + event.name + '</div>';
                html += '<div class="location">ğŸ“ ' + (event.location || 'TBA') + '</div>';
                
                // Zeige Zusagen-Anzahl - klickbar um Teilnehmer zu sehen
                if (zusagenCount > 0) {
                    html += '<div style="margin: 0.5rem 0;"><a href="#" onclick="showEventParticipants(\'' + event.id + '\'); return false;" style="color: var(--accent-blue); text-decoration: none;">ğŸ‘¥ ' + zusagenCount + ' haben zugesagt</a></div>';
                }
                
                if (isAttended) html += '<span class="status present">âœ“ Teilgenommen</span>';
                if (isAbsent) html += '<span class="status absent">âœ— Nicht dabei</span>';
                if (hasZugesagt && !isAttended && !isAbsent) html += '<span class="status planned">âœ“ Zugesagt</span>';
                
                html += '<div class="actions">';
                if (!isAttended && !isAbsent) {
                    // Wenn Scanner deaktiviert: "Ich bin dabei" Button zeigen
                    if (!appSettings.qrScannerEnabled) {
                        html += '<button class="btn btn-primary" onclick="directCheckIn(\'' + event.id + '\')">âœ“ Ich bin dabei</button>';
                    } else {
                        // Zusagen-Button
                        html += '<button class="btn zusage-btn ' + (hasZugesagt ? 'active' : '') + '" onclick="toggleZusage(\'' + event.id + '\')">' + (hasZugesagt ? 'âœ“ Zugesagt' : '+ Zusagen') + '</button>';
                    }
                    html += '<button class="btn btn-danger" onclick="markAbsentEvent(\'' + event.id + '\')">âœ— Absagen</button>';
                } else {
                    html += '<button class="btn btn-secondary" onclick="resetEvent(\'' + event.id + '\')">â†© ZurÃ¼cksetzen</button>';
                }
                html += '</div></div>';
            });
            
            container.innerHTML = html || '<div class="empty-state">Keine Auftritte</div>';
        }
        
        async function directCheckIn(eventId) {
            // Direkt einchecken ohne QR-Code
            if (currentUser.busId) {
                await checkInEvent(eventId, currentUser.busId);
            } else {
                // Bus-Auswahl zeigen
                pendingScanEventId = eventId;
                document.getElementById('checkin-bus-select').value = '';
                document.getElementById('bus-select-modal').classList.add('active');
            }
        }
        
        function updateMemberStats() {
            const attended = Object.values(attendanceData).filter(v => v === true).length;
            const absent = Object.values(attendanceData).filter(v => v === false).length;
            const total = attended + absent;
            const rate = total > 0 ? Math.round(attended / total * 100) : 0;
            document.getElementById('my-attended').textContent = attended;
            document.getElementById('my-missed').textContent = absent;
            document.getElementById('my-rate').textContent = rate + '%';
        }
        
        // "Meine Auftritte" fÃ¼r Admin/Chef - gleiche FunktionalitÃ¤t wie fÃ¼r Mitglieder
        function renderMyEventsForGericht() {
            const container = document.getElementById('my-events-list');
            if (!container) return;
            
            let html = '';
            let currentWeek = '';
            
            eventsData.forEach(event => {
                if (event.week !== currentWeek) {
                    currentWeek = event.week;
                    html += '<div class="week-header">' + currentWeek + '</div>';
                }
                
                const status = attendanceData[event.id];
                const isAttended = status === true;
                const isAbsent = status === false;
                const hasZugesagt = zusagenData[event.id] && zusagenData[event.id][currentUser.name];
                
                let cardClass = 'card event-card';
                if (isAttended) cardClass += ' attended';
                else if (isAbsent) cardClass += ' absent';
                else if (hasZugesagt) cardClass += ' planned';
                
                html += '<div class="' + cardClass + '">';
                html += '<div class="date">' + (event.date || '') + ' â€¢ ' + (event.time || '') + '</div>';
                html += '<div class="title">' + event.name + '</div>';
                html += '<div class="location">ğŸ“ ' + (event.location || 'TBA') + '</div>';
                
                if (isAttended) html += '<span class="status present">âœ“ Teilgenommen</span>';
                if (isAbsent) html += '<span class="status absent">âœ— Nicht dabei</span>';
                if (hasZugesagt && !isAttended && !isAbsent) html += '<span class="status planned">âœ“ Zugesagt</span>';
                
                html += '<div class="actions">';
                if (!isAttended && !isAbsent) {
                    // FÃ¼r Admin/Chef: immer "Ich bin dabei" Button, da sie selbst einchecken kÃ¶nnen
                    html += '<button class="btn btn-primary" onclick="directCheckInGericht(\'' + event.id + '\')">âœ“ Ich bin dabei</button>';
                    html += '<button class="btn zusage-btn ' + (hasZugesagt ? 'active' : '') + '" onclick="toggleZusage(\'' + event.id + '\')">' + (hasZugesagt ? 'âœ“ Zugesagt' : '+ Zusagen') + '</button>';
                    html += '<button class="btn btn-danger" onclick="markAbsentEventGericht(\'' + event.id + '\')">âœ— Absagen</button>';
                } else {
                    html += '<button class="btn btn-secondary" onclick="resetEventGericht(\'' + event.id + '\')">â†© ZurÃ¼cksetzen</button>';
                }
                html += '</div></div>';
            });
            
            container.innerHTML = html || '<div class="empty-state">Keine Auftritte</div>';
        }
        
        async function directCheckInGericht(eventId) {
            showLoading();
            try {
                const result = await apiPost({ action: 'checkIn', name: currentUser.name, eventId: eventId, busId: currentUser.busId || '' });
                if (result.error) { showToast(result.error, true); }
                else {
                    attendanceData[eventId] = true;
                    showToast('âœ“ Eingecheckt!');
                    renderMyEventsForGericht();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function markAbsentEventGericht(eventId) {
            const comment = prompt('Grund fÃ¼r Abwesenheit (optional):');
            showLoading();
            try {
                const result = await apiPost({ action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment || '' });
                if (result.error) { showToast(result.error, true); }
                else {
                    attendanceData[eventId] = false;
                    showToast('Abwesenheit vermerkt');
                    renderMyEventsForGericht();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function resetEventGericht(eventId) {
            showLoading();
            try {
                const result = await apiPost({ action: 'resetAttendance', name: currentUser.name, eventId: eventId });
                if (result.error) { showToast(result.error, true); }
                else {
                    delete attendanceData[eventId];
                    showToast('Status zurÃ¼ckgesetzt');
                    renderMyEventsForGericht();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // WER IST DABEI? (Teilnehmer-Modal fÃ¼r alle Mitglieder)
        // ============================================================
        async function showEventParticipants(eventId) {
            const event = eventsData.find(e => e.id === eventId);
            if (!event) return;
            
            document.getElementById('participants-modal-title').textContent = event.name + ' - Wer ist dabei?';
            document.getElementById('participants-loading').classList.remove('hidden');
            document.getElementById('participants-content').classList.add('hidden');
            document.getElementById('participants-modal').classList.add('active');
            
            try {
                // Lade Zusagen fÃ¼r dieses Event (aus lokalem Cache oder API)
                let zusagen = zusagenData[eventId] || {};
                
                // Parallel laden: Attendance, Members, Register
                const [attendanceResult, membersResult, registerResult] = await Promise.all([
                    apiGet('getEventAttendance', { eventId: eventId }).catch(e => ({ attendance: {} })),
                    allMembersData.length === 0 ? apiGet('getMembers').catch(e => ({ members: [] })) : Promise.resolve({ members: allMembersData }),
                    registerData.length === 0 ? apiGet('getRegister').catch(e => ({ register: [] })) : Promise.resolve({ register: registerData })
                ]);
                
                const eventAttendance = attendanceResult.attendance || {};
                
                // Aktualisiere globale Daten
                if (membersResult.members && membersResult.members.length > 0) {
                    allMembersData = membersResult.members;
                }
                if (registerResult.register && registerResult.register.length > 0) {
                    registerData = registerResult.register;
                }
                
                renderParticipantsModal(event, zusagen, eventAttendance);
                
            } catch (e) {
                console.error('Participants error:', e);
                showToast('Fehler beim Laden', true);
            }
            
            document.getElementById('participants-loading').classList.add('hidden');
            document.getElementById('participants-content').classList.remove('hidden');
        }
        
        function renderParticipantsModal(event, zusagen, eventAttendance) {
            // Kategorisieren
            const zugesagt = [];
            const anwesend = [];
            const abgesagt = [];
            
            // PrÃ¼fe ob User alle sehen darf oder nur eigenes Register
            const permissions = currentUser.permissions || {};
            const canViewAll = permissions.isAdmin || permissions.canViewAllMembers || permissions.canViewAllAttendance;
            const userRegisterId = currentUser.registerId;
            
            // Aus Zusagen
            for (const name in zusagen) {
                if (zusagen[name]) {
                    // Filter nach Register wenn nÃ¶tig
                    if (!canViewAll) {
                        const member = allMembersData.find(m => m.name.toLowerCase() === name.toLowerCase());
                        if (member && member.registerId !== userRegisterId) continue;
                    }
                    zugesagt.push(name);
                }
            }
            
            // Aus Attendance (Ã¼berschreibt Zusagen)
            for (const name in eventAttendance) {
                // Filter nach Register wenn nÃ¶tig
                if (!canViewAll) {
                    const member = allMembersData.find(m => m.name.toLowerCase() === name.toLowerCase());
                    if (member && member.registerId !== userRegisterId) continue;
                }
                
                if (eventAttendance[name] === true) {
                    anwesend.push(name);
                    // Entferne aus zugesagt wenn anwesend
                    const idx = zugesagt.indexOf(name);
                    if (idx > -1) zugesagt.splice(idx, 1);
                } else if (eventAttendance[name] === false) {
                    abgesagt.push(name);
                    const idx = zugesagt.indexOf(name);
                    if (idx > -1) zugesagt.splice(idx, 1);
                }
            }
            
            // Header mit Register-Info wenn gefiltert
            const registerName = userRegisterId ? (registerData.find(r => r.id === userRegisterId)?.name || '') : '';
            const filterInfo = !canViewAll && registerName ? ' <small style="color: var(--text-secondary);">(' + registerName + ')</small>' : '';
            
            // Stats
            document.getElementById('participants-stats').innerHTML = 
                '<span style="color: var(--accent-green);">âœ“ ' + anwesend.length + ' dabei</span>' +
                '<span style="color: var(--accent-blue);">ğŸ“… ' + zugesagt.length + ' zugesagt</span>' +
                '<span style="color: var(--accent-red);">âœ— ' + abgesagt.length + ' abgesagt</span>' +
                filterInfo;
            
            // Register-Gruppierung nur fÃ¼r Admins anzeigen
            const byRegisterDiv = document.getElementById('participants-by-register');
            if (canViewAll) {
                // Nach Register gruppieren
                const byRegister = {};
                registerData.forEach(r => { byRegister[r.id] = { name: r.name, members: [] }; });
                byRegister['none'] = { name: 'Ohne Register', members: [] };
                
                [...anwesend, ...zugesagt].forEach(name => {
                    const member = allMembersData.find(m => m.name.toLowerCase() === name.toLowerCase());
                    const regId = member?.registerId || 'none';
                    if (byRegister[regId]) {
                        const status = anwesend.includes(name) ? 'anwesend' : 'zugesagt';
                        byRegister[regId].members.push({ name, status });
                    }
                });
                
                let regHtml = '';
                Object.values(byRegister).filter(r => r.members.length > 0).forEach(r => {
                    regHtml += '<div style="background: var(--bg-input); padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                    regHtml += '<strong>' + r.name + '</strong>: ' + r.members.length + ' Personen';
                    regHtml += '</div>';
                });
                byRegisterDiv.innerHTML = regHtml || '<p style="color: var(--text-secondary);">Keine Daten</p>';
                byRegisterDiv.parentElement.style.display = 'block';
            } else {
                // Verstecke Register-Gruppierung fÃ¼r normale Mitglieder
                byRegisterDiv.parentElement.style.display = 'none';
            }
            
            // Teilnehmerliste
            let listHtml = '';
            
            anwesend.forEach(name => {
                listHtml += '<div class="member-attendance-row anwesend">';
                listHtml += '<div><strong>' + name + '</strong></div>';
                listHtml += '<div style="color: var(--accent-green);">âœ“ dabei</div>';
                listHtml += '</div>';
            });
            
            zugesagt.forEach(name => {
                listHtml += '<div class="member-attendance-row" style="border-left: 3px solid var(--accent-blue);">';
                listHtml += '<div><strong>' + name + '</strong></div>';
                listHtml += '<div style="color: var(--accent-blue);">ğŸ“… zugesagt</div>';
                listHtml += '</div>';
            });
            
            abgesagt.forEach(name => {
                listHtml += '<div class="member-attendance-row abwesend">';
                listHtml += '<div><strong>' + name + '</strong></div>';
                listHtml += '<div style="color: var(--accent-red);">âœ— abgesagt</div>';
                listHtml += '</div>';
            });
            
            document.getElementById('participants-list').innerHTML = listHtml || '<p style="color: var(--text-secondary);">Noch keine Anmeldungen</p>';
        }
        
        function closeParticipantsModal() {
            document.getElementById('participants-modal').classList.remove('active');
        }
        
        // ============================================================
        // ZUSAGEN
        // ============================================================
        async function toggleZusage(eventId) {
            const current = zusagenData[eventId] && zusagenData[eventId][currentUser.name];
            const newValue = !current;
            
            if (!zusagenData[eventId]) zusagenData[eventId] = {};
            zusagenData[eventId][currentUser.name] = newValue;
            renderEventsList();
            
            if (navigator.onLine && !isOfflineMode) {
                try {
                    await apiPost({ action: 'setZusage', name: currentUser.name, eventId: eventId, zugesagt: newValue });
                } catch (e) { console.error('Zusage error:', e); }
            }
        }
        
        // ============================================================
        // REGISTER ZUSAGEN VIEW
        // ============================================================
        function populateRegisterEventSelect() {
            const select = document.getElementById('register-event-select');
            if (!select) return;
            let html = '<option value="">-- Auftritt wÃ¤hlen --</option>';
            eventsData.forEach(e => {
                html += '<option value="' + e.id + '">' + e.name + ' (' + (e.date || '') + ')</option>';
            });
            select.innerHTML = html;
        }
        
        async function loadRegisterZusagen() {
            const eventId = document.getElementById('register-event-select').value;
            const infoBox = document.getElementById('register-zusagen-info');
            const listContainer = document.getElementById('register-members-list');
            
            if (!eventId) {
                infoBox.classList.add('hidden');
                listContainer.innerHTML = '';
                return;
            }
            
            if (!currentUser.registerId) {
                listContainer.innerHTML = '<div class="empty-state">Du hast noch kein Register in deinem Profil ausgewÃ¤hlt.</div>';
                infoBox.classList.add('hidden');
                return;
            }
            
            // Finde Register-Name
            const register = registerData.find(r => r.id === currentUser.registerId);
            document.getElementById('register-name-display').textContent = register ? 'ğŸµ ' + register.name : 'Mein Register';
            
            showLoading();
            try {
                const result = await apiGet('getRegisterZusagen', { eventId: eventId, registerId: currentUser.registerId });
                
                if (result.error) {
                    listContainer.innerHTML = '<div class="empty-state">' + result.error + '</div>';
                    infoBox.classList.add('hidden');
                } else {
                    const members = result.members || [];
                    document.getElementById('register-zusagen-count').textContent = result.zugesagt + ' / ' + result.total + ' haben zugesagt';
                    infoBox.classList.remove('hidden');
                    
                    let html = '';
                    // Erst die zugesagten
                    members.filter(m => m.zugesagt).forEach(m => {
                        html += '<div class="register-member zugesagt"><span>' + m.name + '</span><span class="status">âœ“</span></div>';
                    });
                    // Dann die nicht zugesagten
                    members.filter(m => !m.zugesagt).forEach(m => {
                        html += '<div class="register-member nicht-zugesagt"><span>' + m.name + '</span><span class="status">â€”</span></div>';
                    });
                    listContainer.innerHTML = html || '<div class="empty-state">Keine Mitglieder in diesem Register</div>';
                }
            } catch (e) {
                listContainer.innerHTML = '<div class="empty-state">Fehler beim Laden</div>';
                infoBox.classList.add('hidden');
            }
            hideLoading();
        }
        
        // ============================================================
        // PROFILE
        // ============================================================
        function populateProfileSelects() {
            const busSelect = document.getElementById('profile-bus');
            const regSelect = document.getElementById('profile-register');
            const checkinBusSelect = document.getElementById('checkin-bus-select');
            
            busSelect.innerHTML = '<option value="">-- Kein fester Bus --</option>';
            checkinBusSelect.innerHTML = '<option value="">-- Kein Bus --</option>';
            busseData.forEach(b => {
                busSelect.innerHTML += '<option value="' + b.id + '">' + b.name + '</option>';
                checkinBusSelect.innerHTML += '<option value="' + b.id + '">' + b.name + '</option>';
            });
            
            regSelect.innerHTML = '<option value="">-- Register wÃ¤hlen --</option>';
            registerData.forEach(r => {
                regSelect.innerHTML += '<option value="' + r.id + '">' + r.name + '</option>';
            });
            
            if (currentUser.busId) busSelect.value = currentUser.busId;
            if (currentUser.registerId) regSelect.value = currentUser.registerId;
        }
        
        async function saveProfile() {
            const busId = document.getElementById('profile-bus').value;
            const registerId = document.getElementById('profile-register').value;
            showLoading();
            try {
                const result = await apiPost({ action: 'updateMemberProfile', name: currentUser.name, busId: busId, registerId: registerId });
                if (result.error) { showToast(result.error, true); }
                else {
                    currentUser.busId = busId;
                    currentUser.registerId = registerId;
                    localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                    showToast('Profil gespeichert!');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // MEMBER ACTIONS
        // ============================================================
        function saveLocalAttendance() {
            if (!currentUser || !currentUser.name) return;
            localStorage.setItem('lkt-attendance-' + currentUser.name, JSON.stringify(attendanceData));
            localStorage.setItem('lkt-comments-' + currentUser.name, JSON.stringify(commentsData));
        }
        
        function loadLocalAttendance() {
            if (!currentUser || !currentUser.name) return;
            const local = localStorage.getItem('lkt-attendance-' + currentUser.name);
            const localComments = localStorage.getItem('lkt-comments-' + currentUser.name);
            if (local) attendanceData = { ...attendanceData, ...JSON.parse(local) };
            if (localComments) commentsData = { ...commentsData, ...JSON.parse(localComments) };
        }
        
        function markAbsentEvent(eventId) {
            currentAbsentEventId = eventId;
            document.getElementById('comment-input').value = '';
            document.getElementById('comment-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('comment-modal').classList.remove('active');
            currentAbsentEventId = null;
        }
        
        async function saveAbsent() {
            if (!currentAbsentEventId) return;
            const comment = document.getElementById('comment-input').value.trim();
            const eventId = currentAbsentEventId;
            closeModal();
            
            attendanceData[eventId] = false;
            commentsData[eventId] = comment;
            saveLocalAttendance();
            renderMemberView();
            
            if (navigator.onLine && !isOfflineMode) {
                try {
                    await apiPost({ action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment });
                    showToast('Als abwesend markiert');
                } catch (e) {
                    addToOfflineQueue({ action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment });
                    showToast('ğŸ“´ Offline gespeichert - wird spÃ¤ter synchronisiert');
                }
            } else {
                addToOfflineQueue({ action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment });
                showToast('ğŸ“´ Offline gespeichert - wird spÃ¤ter synchronisiert');
            }
        }
        
        async function resetEvent(eventId) {
            if (!confirm('Status zurÃ¼cksetzen?')) return;
            delete attendanceData[eventId];
            delete commentsData[eventId];
            saveLocalAttendance();
            renderMemberView();
            showToast('ZurÃ¼ckgesetzt');
            
            if (navigator.onLine && !isOfflineMode) {
                try { await apiPost({ action: 'resetAttendance', name: currentUser.name, eventId: eventId }); }
                catch (e) { 
                    addToOfflineQueue({ action: 'resetAttendance', name: currentUser.name, eventId: eventId }); 
                    showToast('ğŸ“´ Wird spÃ¤ter synchronisiert');
                }
            } else {
                addToOfflineQueue({ action: 'resetAttendance', name: currentUser.name, eventId: eventId });
                showToast('ğŸ“´ Wird spÃ¤ter synchronisiert');
            }
        }
        
        // ============================================================
        // QR SCANNER
        // ============================================================
        let html5QrCode = null;
        let scannerRunning = false;
        
        function initScanner() {
            // Scanner beim ersten Mal automatisch starten
            if (!html5QrCode && !scannerRunning) {
                startScanner();
            }
        }
        
        function startScanner() {
            if (scannerRunning) return;
            
            document.getElementById('start-scan-btn').classList.add('hidden');
            document.getElementById('stop-scan-btn').classList.remove('hidden');
            document.getElementById('scan-success').classList.add('hidden');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                () => {}
            ).then(() => {
                scannerRunning = true;
            }).catch(err => {
                console.error('Scanner error:', err);
                showToast('Kamera-Zugriff fehlgeschlagen', true);
                stopScanner();
            });
        }
        
        function stopScanner() {
            if (html5QrCode && scannerRunning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    scannerRunning = false;
                }).catch(() => {
                    scannerRunning = false;
                });
            }
            document.getElementById('start-scan-btn').classList.remove('hidden');
            document.getElementById('stop-scan-btn').classList.add('hidden');
        }
        
        function pauseScanner() {
            // Scanner nur pausieren, nicht komplett stoppen
            if (html5QrCode && scannerRunning) {
                try {
                    html5QrCode.pause(true);
                } catch (e) {}
            }
        }
        
        function resumeScanner() {
            // Scanner fortsetzen wenn er lÃ¤uft
            if (html5QrCode && scannerRunning) {
                try {
                    html5QrCode.resume();
                } catch (e) {}
            }
        }
        
        async function onScanSuccess(decodedText) {
            if (decodedText.startsWith('LKT-EVENT:')) {
                const eventId = decodedText.replace('LKT-EVENT:', '');
                const event = eventsData.find(e => e.id === eventId);
                
                if (event) {
                    if (attendanceData[eventId] === true) {
                        showToast('Bereits eingecheckt!', true);
                        return;
                    }
                    
                    pauseScanner();
                    
                    // Check if member has fixed bus
                    if (currentUser.busId) {
                        await checkInEvent(eventId, currentUser.busId);
                        showScanSuccess(event.name);
                    } else {
                        pendingScanEventId = eventId;
                        document.getElementById('checkin-bus-select').value = '';
                        document.getElementById('bus-select-modal').classList.add('active');
                    }
                } else {
                    showToast('Unbekannter Auftritt', true);
                }
            }
        }
        
        function cancelBusSelect() {
            document.getElementById('bus-select-modal').classList.remove('active');
            pendingScanEventId = null;
            resumeScanner();
        }
        
        async function confirmBusSelect() {
            const busId = document.getElementById('checkin-bus-select').value;
            const eventId = pendingScanEventId;
            document.getElementById('bus-select-modal').classList.remove('active');
            
            if (eventId) {
                const event = eventsData.find(e => e.id === eventId);
                await checkInEvent(eventId, busId);
                showScanSuccess(event ? event.name : 'Auftritt');
            }
            pendingScanEventId = null;
        }
        
        async function checkInEvent(eventId, busId) {
            attendanceData[eventId] = true;
            delete commentsData[eventId];
            saveLocalAttendance();
            renderMemberView();
            
            if (navigator.onLine && !isOfflineMode) {
                try {
                    const result = await apiPost({ action: 'checkIn', name: currentUser.name, eventId: eventId, busId: busId || '' });
                    if (result.error) {
                        showToast('âŒ ' + result.error, true);
                        return;
                    }
                    showToast('âœ“ Eingecheckt!');
                } catch (e) {
                    addToOfflineQueue({ action: 'checkIn', name: currentUser.name, eventId: eventId, busId: busId || '' });
                    showToast('ğŸ“´ Offline gespeichert - wird spÃ¤ter synchronisiert');
                }
            } else {
                addToOfflineQueue({ action: 'checkIn', name: currentUser.name, eventId: eventId, busId: busId || '' });
                showToast('ğŸ“´ Offline gespeichert - wird spÃ¤ter synchronisiert');
            }
        }
        
        function showScanSuccess(eventName) {
            document.getElementById('success-text').textContent = eventName + ' - Eingecheckt!';
            document.getElementById('scan-success').classList.remove('hidden');
            pauseScanner(); // Nur pausieren
            
            setTimeout(() => {
                document.getElementById('scan-success').classList.add('hidden');
                document.querySelectorAll('#member-nav .nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-tab="events"]').classList.add('active');
                document.querySelectorAll('#member-screens .screen').forEach(s => s.classList.remove('active'));
                document.getElementById('events-tab').classList.add('active');
            }, 2000);
        }
        
        // ============================================================
        // ANZEIGEN
        // ============================================================
        async function submitAnzeige() {
            const beschuldigter = document.getElementById('anzeige-beschuldigter').value.trim();
            const tatbestand = document.getElementById('anzeige-tatbestand').value.trim();
            const zeugen = document.getElementById('anzeige-zeugen').value.trim();
            const strafe = document.getElementById('anzeige-strafe').value.trim();
            
            if (!beschuldigter || !tatbestand || !strafe) { showToast('Pflichtfelder ausfÃ¼llen!', true); return; }
            showLoading();
            try {
                const result = await apiPost({
                    action: 'submitAnzeige', melder: currentUser.name, beschuldigter: beschuldigter,
                    tatbestand: tatbestand, zeugen: zeugen, strafe: strafe
                });
                if (result.error) { showToast(result.error, true); }
                else {
                    showToast('Anzeige eingereicht!');
                    document.getElementById('anzeige-beschuldigter').value = '';
                    document.getElementById('anzeige-tatbestand').value = '';
                    document.getElementById('anzeige-zeugen').value = '';
                    document.getElementById('anzeige-strafe').value = '';
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // GERICHT VIEW
        // ============================================================
        async function renderGerichtView() {
            populateAttendanceEventSelect();
            populateQREventSelect();
            populateFilters();
            populateWeekendSelect();
            renderBusseList();
            renderRegisterList();
            renderEventsManageList();
            renderMyEventsForGericht(); // NEU: Eigene Auftritte fÃ¼r Admin/Chef
            
            // Settings Checkboxen initialisieren
            applyAppSettings();
            
            document.getElementById('total-members').textContent = statsData.totalMembers || 0;
            document.getElementById('total-events').textContent = statsData.totalEvents || 0;
            document.getElementById('total-checkins').textContent = statsData.totalAttended || 0;
            document.getElementById('total-anzeigen').textContent = statsData.totalAnzeigen || 0;
            document.getElementById('overall-rate').textContent = (statsData.attendanceRate || 0) + '%';
            
            try {
                const membersResult = await apiGet('getMembers');
                allMembersData = membersResult.members || [];
                allMemberStats = statsData.memberStats || {};
                allMembersData.forEach(m => { if (!allMemberStats[m.name]) allMemberStats[m.name] = { attended: 0, absent: 0 }; });
                renderMembersList(allMembersData);
                
                const permissions = currentUser.permissions || {};
                if (permissions.canManageAnzeigen && appSettings.strafenEnabled) {
                    const anzeigeResult = await apiGet('getAnzeigen');
                    allAnzeigenData = anzeigeResult.anzeigen || [];
                    renderAnzeigenList(allAnzeigenData);
                }
                
                renderRankings(statsData.topAttenders || [], statsData.topAbsent || []);
                
                // Load bus and register stats
                try {
                    const busStatsResult = await apiGet('getBusStats');
                    renderBusStats(busStatsResult.busStats || []);
                } catch (e) { console.log('Bus stats error:', e); }
                
                try {
                    const regStatsResult = await apiGet('getRegisterStats');
                    renderRegisterStats(regStatsResult.registerStats || []);
                } catch (e) { console.log('Register stats error:', e); }
                
                // Load Brett - always try this
                try {
                    await loadForumBereiche();
                    await loadBrettPosts('gericht');
                } catch (e) { console.log('Brett load error:', e); }
                
                // Load Rollen und Anfragen - nur fÃ¼r Admin
                if (permissions.isAdmin || permissions.canManageRoles) {
                    try { await loadRollen(); } catch (e) { console.log('Rollen load error:', e); }
                    try { await loadRegisterAnfragen(); } catch (e) { console.log('Anfragen load error:', e); }
                }
                
            } catch (e) { console.error('Gericht view error:', e); }
        }
        
        function populateFilters() {
            const regFilter = document.getElementById('att-filter-register');
            const memberRegFilter = document.getElementById('member-filter-register');
            const memberBusFilter = document.getElementById('member-filter-bus');
            const weekFilter = document.getElementById('att-filter-week');
            
            let regHtml = '<option value="">Alle Register</option>';
            registerData.forEach(r => { regHtml += '<option value="' + r.id + '">' + r.name + '</option>'; });
            regFilter.innerHTML = regHtml;
            memberRegFilter.innerHTML = regHtml;
            
            let busHtml = '<option value="">Alle Busse</option>';
            busseData.forEach(b => { busHtml += '<option value="' + b.id + '">' + b.name + '</option>'; });
            memberBusFilter.innerHTML = busHtml;
            
            const weeks = [...new Set(eventsData.map(e => e.week))];
            let weekHtml = '<option value="">Alle Wochenenden</option>';
            weeks.forEach(w => { weekHtml += '<option value="' + w + '">' + w + '</option>'; });
            weekFilter.innerHTML = weekHtml;
        }
        
        function populateAttendanceEventSelect() {
            const select = document.getElementById('attendance-event-select');
            let html = '<option value="">-- Auftritt wÃ¤hlen --</option>';
            let currentWeek = '';
            eventsData.forEach(event => {
                if (event.week !== currentWeek) {
                    if (currentWeek !== '') html += '</optgroup>';
                    currentWeek = event.week;
                    html += '<optgroup label="' + currentWeek + '">';
                }
                html += '<option value="' + event.id + '">' + (event.date || '') + ' - ' + event.name + '</option>';
            });
            if (currentWeek !== '') html += '</optgroup>';
            select.innerHTML = html;
        }
        
        function populateQREventSelect() {
            const select = document.getElementById('qr-event-select');
            let html = '<option value="">-- Event wÃ¤hlen --</option>';
            eventsData.forEach(e => { html += '<option value="' + e.id + '">' + (e.date || '') + ' - ' + e.name + '</option>'; });
            select.innerHTML = html;
        }
        
        // ============================================================
        // ATTENDANCE MANAGEMENT
        // ============================================================
        async function loadEventAttendance() {
            const eventId = document.getElementById('attendance-event-select').value;
            const container = document.getElementById('attendance-table-container');
            
            if (!eventId) { container.classList.add('hidden'); return; }
            
            currentAttendanceEventId = eventId;
            container.classList.remove('hidden');
            document.getElementById('attendance-table').innerHTML = '<div style="text-align: center; padding: 2rem;">Laden...</div>';
            
            attendanceByMember = {};
            geplantByMember = {};
            
            try {
                const result = await apiGet('getEventAttendance', { eventId: eventId });
                if (result.attendance) attendanceByMember = result.attendance;
                
                const geplantResult = await apiGet('getGeplanteTeilnahme', { eventId: eventId });
                geplantByMember = geplantResult.geplant || {};
            } catch (e) { console.log('Could not load attendance'); }
            
            renderAttendanceTable();
        }
        
        function renderAttendanceTable() {
            const container = document.getElementById('attendance-table');
            const regFilter = document.getElementById('att-filter-register').value;
            
            let filteredMembers = allMembersData;
            if (regFilter) filteredMembers = filteredMembers.filter(m => m.registerId === regFilter);
            
            let html = '';
            filteredMembers.forEach(member => {
                const isPresent = attendanceByMember[member.name] === true;
                const isAbsent = attendanceByMember[member.name] === false;
                const isPlanned = geplantByMember[member.name] === true;
                
                let tags = '';
                if (member.busId) {
                    const bus = busseData.find(b => b.id === member.busId);
                    if (bus) tags += '<span class="tag bus">' + bus.name + '</span>';
                }
                if (member.registerId) {
                    const reg = registerData.find(r => r.id === member.registerId);
                    if (reg) tags += '<span class="tag register">' + reg.name + '</span>';
                }
                
                let statusText = '';
                if (isPlanned && !isPresent && !isAbsent) statusText = '<span style="color: var(--accent-blue); font-size: 0.75rem; margin-left: 0.5rem;">ğŸ“… Geplant</span>';
                
                html += '<div class="attendance-row">';
                html += '<div class="member-name">' + member.name + tags + statusText + '</div>';
                html += '<div class="attendance-buttons">';
                html += '<button class="att-btn ' + (isPresent ? 'present' : '') + '" onclick="setMemberAttendance(\'' + member.name.replace(/'/g, "\\'") + '\', true)">âœ“</button>';
                html += '<button class="att-btn ' + (isAbsent ? 'absent' : '') + '" onclick="setMemberAttendance(\'' + member.name.replace(/'/g, "\\'") + '\', false)">âœ—</button>';
                html += '</div></div>';
            });
            
            container.innerHTML = html || '<div class="empty-state">Keine Mitglieder</div>';
            updateAttendanceCounts();
        }
        
        function setMemberAttendance(memberName, isPresent) {
            const current = attendanceByMember[memberName];
            if ((isPresent && current === true) || (!isPresent && current === false)) {
                delete attendanceByMember[memberName];
            } else {
                attendanceByMember[memberName] = isPresent;
            }
            renderAttendanceTable();
        }
        
        function updateAttendanceCounts() {
            let present = 0, absent = 0, planned = 0, unknown = 0;
            allMembersData.forEach(member => {
                const status = attendanceByMember[member.name];
                if (status === true) present++;
                else if (status === false) absent++;
                else {
                    if (geplantByMember[member.name]) planned++;
                    else unknown++;
                }
            });
            document.getElementById('att-count-present').textContent = present;
            document.getElementById('att-count-absent').textContent = absent;
            document.getElementById('att-count-planned').textContent = planned;
            document.getElementById('att-count-unknown').textContent = unknown;
        }
        
        async function saveAllAttendance() {
            if (!currentAttendanceEventId) { showToast('Kein Auftritt ausgewÃ¤hlt', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'saveEventAttendance', eventId: currentAttendanceEventId, attendance: attendanceByMember });
                if (result.error) showToast(result.error, true);
                else showToast('âœ“ Anwesenheit gespeichert!');
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // MEMBERS LIST
        // ============================================================
        function renderMembersList(members) {
            const container = document.getElementById('members-list');
            if (members.length === 0) { container.innerHTML = '<div class="empty-state">Keine Mitglieder</div>'; return; }
            
            let html = '';
            members.forEach(m => {
                const stats = allMemberStats[m.name] || { attended: 0, absent: 0 };
                const total = stats.attended + stats.absent;
                const rate = total > 0 ? Math.round(stats.attended / total * 100) : 0;
                
                let tags = '';
                if (m.busId) {
                    const bus = busseData.find(b => b.id === m.busId);
                    if (bus) tags += '<span class="tag bus">' + bus.name + '</span>';
                }
                if (m.registerId) {
                    const reg = registerData.find(r => r.id === m.registerId);
                    if (reg) tags += '<span class="tag register">' + reg.name + '</span>';
                }
                
                html += '<div class="card" style="cursor: pointer;" onclick="showMemberDetail(\'' + m.name.replace(/'/g, "\\'") + '\')">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 700;">' + m.name + tags + '</div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary);">âœ“ ' + stats.attended + ' | âœ— ' + stats.absent + ' | ' + rate + '%</div></div>';
                html += '<div style="display: flex; gap: 0.5rem;">';
                html += '<button class="btn btn-danger" style="padding: 0.5rem 0.75rem;" onclick="event.stopPropagation(); deleteMember(\'' + m.name.replace(/'/g, "\\'") + '\')">ğŸ—‘ï¸</button>';
                html += '</div></div></div>';
            });
            container.innerHTML = html;
        }
        
        function filterMembersList() {
            const regFilter = document.getElementById('member-filter-register').value;
            const busFilter = document.getElementById('member-filter-bus').value;
            
            let filtered = allMembersData;
            if (regFilter) filtered = filtered.filter(m => m.registerId === regFilter);
            if (busFilter) filtered = filtered.filter(m => m.busId === busFilter);
            
            renderMembersList(filtered);
        }
        
        async function showMemberDetail(name) {
            currentDetailMember = name;
            showLoading();
            try {
                const result = await apiGet('getMemberAttendance', { name: name });
                if (result.error) { showToast(result.error, true); hideLoading(); return; }
                
                const attendance = result.attendance || {};
                let present = 0, absent = 0;
                Object.values(attendance).forEach(s => { if (s === true) present++; else if (s === false) absent++; });
                
                const member = allMembersData.find(m => m.name === name);
                let busTag = '', regTag = '';
                if (member && member.busId) {
                    const bus = busseData.find(b => b.id === member.busId);
                    if (bus) busTag = 'ğŸšŒ ' + bus.name;
                }
                if (member && member.registerId) {
                    const reg = registerData.find(r => r.id === member.registerId);
                    if (reg) regTag = 'ğŸµ ' + reg.name;
                }
                
                let eventsHtml = '';
                eventsData.forEach(event => {
                    const status = attendance[event.id];
                    if (status === true) {
                        eventsHtml += '<div class="card event-card attended" style="padding: 0.5rem; margin-bottom: 0.5rem;">';
                        eventsHtml += '<div style="font-size: 0.8rem; color: var(--text-secondary);">' + (event.date || '') + '</div>';
                        eventsHtml += '<div style="font-weight: 600;">' + event.name + '</div>';
                        eventsHtml += '<span class="status present">âœ“ Dabei</span></div>';
                    } else if (status === false) {
                        eventsHtml += '<div class="card event-card absent" style="padding: 0.5rem; margin-bottom: 0.5rem;">';
                        eventsHtml += '<div style="font-size: 0.8rem; color: var(--text-secondary);">' + (event.date || '') + '</div>';
                        eventsHtml += '<div style="font-weight: 600;">' + event.name + '</div>';
                        eventsHtml += '<span class="status absent">âœ— Gefehlt</span></div>';
                    }
                });
                
                const total = present + absent;
                const rate = total > 0 ? Math.round(present / total * 100) : 0;
                
                document.getElementById('member-detail-name').textContent = name;
                document.getElementById('member-detail-bus').textContent = busTag;
                document.getElementById('member-detail-bus').style.display = busTag ? 'inline-block' : 'none';
                document.getElementById('member-detail-register').textContent = regTag;
                document.getElementById('member-detail-register').style.display = regTag ? 'inline-block' : 'none';
                document.getElementById('member-detail-present').textContent = present;
                document.getElementById('member-detail-absent').textContent = absent;
                document.getElementById('member-detail-rate').textContent = rate + '%';
                document.getElementById('member-detail-events').innerHTML = eventsHtml || '<div class="empty-state">Keine EintrÃ¤ge</div>';
                
                // Rollen-Dropdown dynamisch fÃ¼llen
                const roleSelect = document.getElementById('member-detail-role');
                let roleHtml = '';
                rollenData.forEach(r => {
                    roleHtml += '<option value="' + r.id + '">' + r.name + '</option>';
                });
                roleSelect.innerHTML = roleHtml;
                
                // Set current role
                if (member) roleSelect.value = member.rollenId || 'ROLE-MITGLIED';
                
                // Show/hide role editing based on permissions
                const permissions = currentUser.permissions || {};
                const canEditRole = permissions.isAdmin || permissions.canManageRoles;
                document.getElementById('member-role-group').style.display = canEditRole ? 'block' : 'none';
                document.getElementById('save-role-btn').style.display = canEditRole ? 'block' : 'none';
                
                document.getElementById('member-detail-modal').classList.add('active');
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        function closeMemberDetail() {
            document.getElementById('member-detail-modal').classList.remove('active');
            currentDetailMember = null;
        }
        
        async function saveMemberRole() {
            if (!currentDetailMember) return;
            const rollenId = document.getElementById('member-detail-role').value;
            showLoading();
            try {
                const result = await apiPost({ action: 'updateMemberRole', name: currentDetailMember, rollenId: rollenId });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Rolle aktualisiert!');
                    const member = allMembersData.find(m => m.name === currentDetailMember);
                    if (member) member.rollenId = rollenId;
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteMember(name) {
            if (!confirm(name + ' wirklich lÃ¶schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteMember', name: name });
                if (result.error) showToast(result.error, true);
                else { showToast(result.message); await refreshData(); }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // BUSSE & REGISTER MANAGEMENT
        // ============================================================
        function renderBusseList() {
            const container = document.getElementById('busse-list');
            if (busseData.length === 0) { container.innerHTML = '<div class="empty-state">Keine Busse</div>'; return; }
            let html = '';
            busseData.forEach(b => {
                html += '<div class="list-item"><span class="name">ğŸšŒ ' + b.name + '</span>';
                html += '<button class="btn btn-danger" style="padding: 0.3rem 0.5rem; font-size: 0.8rem;" onclick="deleteBus(\'' + b.id + '\')">ğŸ—‘ï¸</button></div>';
            });
            container.innerHTML = html;
        }
        
        function renderRegisterList() {
            const container = document.getElementById('register-list');
            if (registerData.length === 0) { container.innerHTML = '<div class="empty-state">Keine Register</div>'; return; }
            let html = '';
            registerData.forEach(r => {
                html += '<div class="list-item"><span class="name">ğŸµ ' + r.name + '</span>';
                html += '<button class="btn btn-danger" style="padding: 0.3rem 0.5rem; font-size: 0.8rem;" onclick="deleteRegister(\'' + r.id + '\')">ğŸ—‘ï¸</button></div>';
            });
            container.innerHTML = html;
        }
        
        async function addNewBus() {
            const name = document.getElementById('new-bus-name').value.trim();
            if (!name) { showToast('Bus-Name erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'addBus', name: name });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Bus hinzugefÃ¼gt!');
                    document.getElementById('new-bus-name').value = '';
                    const busseResult = await apiGet('getBusse');
                    busseData = busseResult.busse || [];
                    renderBusseList();
                    populateFilters();
                    populateProfileSelects();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteBus(id) {
            if (!confirm('Bus wirklich lÃ¶schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteBus', id: id });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Bus gelÃ¶scht!');
                    busseData = busseData.filter(b => b.id !== id);
                    renderBusseList();
                    populateFilters();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function addNewRegister() {
            const name = document.getElementById('new-register-name').value.trim();
            if (!name) { showToast('Register-Name erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'addRegister', name: name });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Register hinzugefÃ¼gt!');
                    document.getElementById('new-register-name').value = '';
                    const regResult = await apiGet('getRegister');
                    registerData = regResult.register || [];
                    renderRegisterList();
                    populateFilters();
                    populateProfileSelects();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteRegister(id) {
            if (!confirm('Register wirklich lÃ¶schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteRegister', id: id });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Register gelÃ¶scht!');
                    registerData = registerData.filter(r => r.id !== id);
                    renderRegisterList();
                    populateFilters();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // EVENTS MANAGEMENT
        // ============================================================
        async function addNewEvent() {
            const name = document.getElementById('new-event-name').value.trim();
            if (!name) { showToast('Event-Name erforderlich', true); return; }
            
            const eventData = {
                name: name,
                week: document.getElementById('new-event-week').value.trim(),
                date: document.getElementById('new-event-date').value.trim(),
                location: document.getElementById('new-event-location').value.trim(),
                time: document.getElementById('new-event-time').value.trim()
            };
            
            showLoading();
            try {
                const result = await apiPost({ action: 'addEvent', event: eventData });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Event hinzugefÃ¼gt!');
                    document.getElementById('new-event-name').value = '';
                    document.getElementById('new-event-week').value = '';
                    document.getElementById('new-event-date').value = '';
                    document.getElementById('new-event-location').value = '';
                    document.getElementById('new-event-time').value = '';
                    await refreshData();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // STATISTICS DISPLAY
        // ============================================================
        function renderBusStats(stats) {
            const container = document.getElementById('bus-stats-list');
            if (stats.length === 0) { container.innerHTML = '<div class="empty-state">Keine Bus-Statistiken</div>'; return; }
            let html = '';
            stats.forEach(s => {
                const total = s.attended + s.absent;
                const rate = total > 0 ? Math.round(s.attended / total * 100) : 0;
                html += '<div class="card"><div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 700;">ğŸšŒ ' + s.name + '</div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary);">âœ“ ' + s.attended + ' | âœ— ' + s.absent + '</div></div>';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-yellow);">' + rate + '%</div>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function renderRegisterStats(stats) {
            const container = document.getElementById('register-stats-list');
            if (stats.length === 0) { container.innerHTML = '<div class="empty-state">Keine Register-Statistiken</div>'; return; }
            let html = '';
            stats.forEach(s => {
                const total = s.attended + s.absent;
                const rate = total > 0 ? Math.round(s.attended / total * 100) : 0;
                html += '<div class="card"><div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 700;">ğŸµ ' + s.name + ' <span style="font-size: 0.8rem; color: var(--text-secondary);">(' + s.memberCount + ' Mitglieder)</span></div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary);">âœ“ ' + s.attended + ' | âœ— ' + s.absent + '</div></div>';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-yellow);">' + rate + '%</div>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function renderAnzeigenList(anzeigen) {
            const container = document.getElementById('anzeigen-list');
            if (anzeigen.length === 0) { container.innerHTML = '<div class="empty-state">Keine Anzeigen</div>'; return; }
            let html = '';
            anzeigen.forEach(a => {
                html += '<div class="anzeige-card"><div class="header">';
                html += '<span class="vs">' + a.melder + ' âš”ï¸ ' + a.beschuldigter + '</span>';
                html += '<span class="date">' + a.datum + '</span></div>';
                html += '<div class="tatbestand">' + a.tatbestand + '</div>';
                if (a.zeugen) html += '<div style="font-size: 0.8rem; color: var(--text-secondary);">Zeugen: ' + a.zeugen + '</div>';
                html += '<div class="strafe">Strafvorschlag: ' + a.strafe + '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function renderRankings(topAttenders, topAbsent) {
            const attendersContainer = document.getElementById('top-attenders');
            const absentContainer = document.getElementById('top-absent');
            
            if (topAttenders.length === 0) {
                attendersContainer.innerHTML = '<div class="empty-state">Keine Daten</div>';
            } else {
                attendersContainer.innerHTML = topAttenders.map((m, i) => 
                    '<div class="leaderboard-item"><div class="rank">' + (i + 1) + '</div><div class="name">' + m.name + '</div><div class="score">' + m.attended + ' âœ“</div></div>'
                ).join('');
            }
            
            if (topAbsent.length === 0) {
                absentContainer.innerHTML = '<div class="empty-state">Keine Daten</div>';
            } else {
                absentContainer.innerHTML = topAbsent.map((m, i) => 
                    '<div class="leaderboard-item"><div class="rank">' + (i + 1) + '</div><div class="name">' + m.name + '</div><div class="score bad">' + m.absent + ' âœ—</div></div>'
                ).join('');
            }
        }
        
        // ============================================================
        // QR CODE GENERATION
        // ============================================================
        function showEventQR() {
            const eventId = document.getElementById('qr-event-select').value;
            if (!eventId) { document.getElementById('event-qr-display').classList.add('hidden'); return; }
            
            const event = eventsData.find(e => e.id === eventId);
            if (!event) return;
            
            const qrData = 'LKT-EVENT:' + eventId;
            const container = document.getElementById('event-qr-canvas');
            
            try {
                const qr = qrcode(0, 'M');
                qr.addData(qrData);
                qr.make();
                container.innerHTML = qr.createImgTag(6, 8);
                
                document.getElementById('event-qr-display').classList.remove('hidden');
                document.getElementById('event-qr-label').textContent = event.name;
                document.getElementById('event-qr-sublabel').textContent = (event.date || '') + ' â€¢ ' + (event.time || '') + ' â€¢ ' + (event.location || '');
            } catch (e) { showToast('QR-Fehler', true); }
        }
        
        function downloadEventQR() {
            const img = document.querySelector('#event-qr-canvas img');
            if (!img) return;
            const link = document.createElement('a');
            link.download = 'LKT_QR_' + document.getElementById('qr-event-select').value + '.png';
            link.href = img.src;
            link.click();
        }
        
        // ============================================================
        // SCHWARZES BRETT
        // ============================================================
        async function loadBrettPosts(view) {
            try {
                // Lade Posts fÃ¼r aktuellen Bereich
                const result = await apiGet('getBrettPosts', { bereichId: currentForumBereichId });
                brettPostsData = result.posts || [];
                
                // Load all comments
                const komResult = await apiGet('getKommentare');
                kommentareData = {};
                (komResult.kommentare || []).forEach(k => {
                    if (!kommentareData[k.postId]) kommentareData[k.postId] = [];
                    kommentareData[k.postId].push(k);
                });
                
                renderBrettPosts(view);
            } catch (e) { console.error('Brett load error:', e); }
        }
        
        function renderBrettPosts(view) {
            const container = document.getElementById(view === 'gericht' ? 'brett-posts-gericht' : 'brett-posts-member');
            if (!container) {
                console.error('Brett container not found for view:', view);
                return;
            }
            
            if (brettPostsData.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine BeitrÃ¤ge in diesem Bereich</div>';
                return;
            }
            
            const permissions = currentUser.permissions || {};
            const canDelete = permissions.isAdmin || permissions.canManageMembers;
            let html = '';
            
            brettPostsData.forEach(post => {
                const date = new Date(post.erstelltAm);
                const dateStr = date.toLocaleDateString('de-DE') + ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const kommentare = kommentareData[post.id] || [];
                
                html += '<div class="brett-post" id="post-' + post.id + '">';
                html += '<div class="post-header">';
                html += '<div class="post-title">' + escapeHtml(post.titel) + '</div>';
                if (canDelete) {
                    html += '<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deletePost(\'' + post.id + '\')">ğŸ—‘ï¸</button>';
                }
                html += '</div>';
                html += '<div class="post-meta">ğŸ‘¤ ' + escapeHtml(post.autor) + ' â€¢ ' + dateStr + '</div>';
                html += '<div class="post-content">' + escapeHtml(post.inhalt) + '</div>';
                
                // Kommentare
                html += '<div class="kommentare-section">';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ğŸ’¬ ' + kommentare.length + ' Kommentar' + (kommentare.length !== 1 ? 'e' : '') + '</div>';
                
                kommentare.forEach(k => {
                    const kDate = new Date(k.erstelltAm);
                    const kDateStr = kDate.toLocaleDateString('de-DE') + ' ' + kDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    html += '<div class="kommentar">';
                    html += '<div class="kom-header"><span class="kom-autor">' + escapeHtml(k.autor) + '</span><span class="kom-date">' + kDateStr + '</span></div>';
                    html += '<div class="kom-text">' + escapeHtml(k.text) + '</div>';
                    html += '</div>';
                });
                
                // Kommentar-Eingabe
                html += '<div class="kommentar-input">';
                html += '<input type="text" id="kom-input-' + post.id + '" placeholder="Kommentar schreiben..." onkeypress="if(event.key===\'Enter\')addComment(\'' + post.id + '\')">';
                html += '<button class="btn btn-primary" style="padding: 0.5rem 0.75rem;" onclick="addComment(\'' + post.id + '\')">ğŸ’¬</button>';
                html += '</div>';
                html += '</div>'; // kommentare-section
                html += '</div>'; // brett-post
            });
            
            container.innerHTML = html;
        }
        
        async function submitBrettPost() {
            const titel = document.getElementById('post-titel').value.trim();
            const inhalt = document.getElementById('post-inhalt').value.trim();
            if (!titel || !inhalt) { showToast('Titel und Inhalt erforderlich', true); return; }
            
            // Optimistisches Update - sofort anzeigen
            const tempPost = {
                id: 'temp-' + Date.now(),
                autor: currentUser.name,
                titel: titel,
                inhalt: inhalt,
                erstelltAm: new Date().toISOString(),
                bereichId: currentForumBereichId
            };
            brettPostsData.unshift(tempPost);
            renderBrettPosts('member');
            document.getElementById('post-titel').value = '';
            document.getElementById('post-inhalt').value = '';
            showToast('Beitrag verÃ¶ffentlicht!');
            
            // Im Hintergrund speichern
            try {
                const result = await apiPost({ action: 'addBrettPost', autor: currentUser.name, titel: titel, inhalt: inhalt, bereichId: currentForumBereichId });
                if (result.error) { 
                    showToast(result.error, true);
                    // Entferne temp Post bei Fehler
                    brettPostsData = brettPostsData.filter(p => p.id !== tempPost.id);
                    renderBrettPosts('member');
                } else {
                    // Lade frische Daten im Hintergrund
                    loadBrettPosts('member');
                }
            } catch (e) { 
                showToast('Fehler beim Speichern', true);
            }
        }
        
        async function submitBrettPostGericht() {
            const titel = document.getElementById('post-titel-gericht').value.trim();
            const inhalt = document.getElementById('post-inhalt-gericht').value.trim();
            if (!titel || !inhalt) { showToast('Titel und Inhalt erforderlich', true); return; }
            
            // Optimistisches Update
            const tempPost = {
                id: 'temp-' + Date.now(),
                autor: currentUser.name,
                titel: titel,
                inhalt: inhalt,
                erstelltAm: new Date().toISOString(),
                bereichId: currentForumBereichId
            };
            brettPostsData.unshift(tempPost);
            renderBrettPosts('gericht');
            document.getElementById('post-titel-gericht').value = '';
            document.getElementById('post-inhalt-gericht').value = '';
            showToast('Beitrag verÃ¶ffentlicht!');
            
            // Im Hintergrund speichern
            try {
                const result = await apiPost({ action: 'addBrettPost', autor: currentUser.name, titel: titel, inhalt: inhalt, bereichId: currentForumBereichId });
                if (result.error) { 
                    showToast(result.error, true);
                    brettPostsData = brettPostsData.filter(p => p.id !== tempPost.id);
                    renderBrettPosts('gericht');
                } else {
                    loadBrettPosts('gericht');
                }
            } catch (e) { 
                showToast('Fehler beim Speichern', true);
            }
        }
        
        async function deletePost(postId) {
            if (!confirm('Beitrag wirklich lÃ¶schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteBrettPost', postId: postId });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Beitrag gelÃ¶scht');
                    await loadBrettPosts(currentUser.role === 'gericht' ? 'gericht' : 'member');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function addComment(postId) {
            const input = document.getElementById('kom-input-' + postId);
            const text = input.value.trim();
            if (!text) return;
            
            try {
                const result = await apiPost({ action: 'addKommentar', postId: postId, autor: currentUser.name, text: text });
                if (result.error) { showToast(result.error, true); }
                else {
                    input.value = '';
                    // Kommentar lokal hinzufÃ¼gen fÃ¼r schnelle Anzeige
                    if (!kommentareData[postId]) kommentareData[postId] = [];
                    kommentareData[postId].push({ id: result.id, postId: postId, autor: currentUser.name, text: text, erstelltAm: new Date().toISOString() });
                    renderBrettPosts(currentUser.role === 'gericht' ? 'gericht' : 'member');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============================================================
        // PDF EXPORTS
        // ============================================================
        function exportReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Saison-Report 2026', 105, 30, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let y = 55;
            doc.text('Mitglieder: ' + (statsData.totalMembers || 0), 20, y);
            doc.text('Auftritte: ' + (statsData.totalEvents || 0), 105, y);
            y += 10;
            doc.text('Check-ins: ' + (statsData.totalAttended || 0), 20, y);
            doc.text('Abwesenheiten: ' + (statsData.totalAbsent || 0), 105, y);
            y += 10;
            doc.text('Anwesenheitsquote: ' + (statsData.attendanceRate || 0) + '%', 20, y);
            
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('LKT Tracker 2026 - Erstellt: ' + new Date().toLocaleDateString('de-DE'), 105, 285, { align: 'center' });
            
            doc.save('LKT_Saison_Report_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportBusStatsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Bus-Statistik 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            doc.setFillColor(59, 130, 246);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('Bus', 20, y);
            doc.text('Dabei', 100, y);
            doc.text('Gefehlt', 130, y);
            doc.text('Quote', 165, y);
            
            y += 15;
            doc.setTextColor(0, 0, 0);
            
            busseData.forEach(bus => {
                const total = bus.attended + bus.absent;
                const rate = total > 0 ? Math.round(bus.attended / total * 100) : 0;
                doc.text(bus.name, 20, y);
                doc.text(String(bus.attended || 0), 105, y);
                doc.text(String(bus.absent || 0), 135, y);
                doc.text(rate + '%', 167, y);
                y += 8;
            });
            
            doc.save('LKT_Bus_Statistik_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportRegisterStatsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Register-Statistik 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            doc.setFillColor(139, 92, 246);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('Register', 20, y);
            doc.text('Mitglieder', 80, y);
            doc.text('Dabei', 115, y);
            doc.text('Gefehlt', 145, y);
            doc.text('Quote', 175, y);
            
            y += 15;
            doc.setTextColor(0, 0, 0);
            
            registerData.forEach(reg => {
                const total = reg.attended + reg.absent;
                const rate = total > 0 ? Math.round(reg.attended / total * 100) : 0;
                doc.text(reg.name, 20, y);
                doc.text(String(reg.memberCount || 0), 90, y);
                doc.text(String(reg.attended || 0), 120, y);
                doc.text(String(reg.absent || 0), 150, y);
                doc.text(rate + '%', 177, y);
                y += 8;
            });
            
            doc.save('LKT_Register_Statistik_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportAllMembersPDF() {
            if (allMembersData.length === 0) { showToast('Keine Mitglieder', true); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Mitglieder-Ãœbersicht 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            doc.setFillColor(26, 26, 46);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(10);
            doc.text('Name', 20, y);
            doc.text('Dabei', 100, y);
            doc.text('Gefehlt', 130, y);
            doc.text('Quote', 165, y);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            const sortedMembers = allMembersData.map(m => {
                const stats = allMemberStats[m.name] || { attended: 0, absent: 0 };
                const total = stats.attended + stats.absent;
                const rate = total > 0 ? Math.round(stats.attended / total * 100) : 0;
                return { ...m, ...stats, rate };
            }).sort((a, b) => b.attended - a.attended);
            
            sortedMembers.forEach((m, i) => {
                if (y > 270) { doc.addPage(); y = 20; }
                if (i % 2 === 0) { doc.setFillColor(245, 245, 245); doc.rect(15, y - 4, 180, 8, 'F'); }
                doc.setTextColor(0, 0, 0);
                doc.text(m.name.substring(0, 30), 20, y);
                doc.setTextColor(74, 222, 128);
                doc.text(String(m.attended), 105, y);
                doc.setTextColor(239, 68, 68);
                doc.text(String(m.absent), 135, y);
                doc.setTextColor(0, 0, 0);
                doc.text(m.rate + '%', 167, y);
                y += 8;
            });
            
            doc.save('LKT_Alle_Mitglieder_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportMemberPDF() {
            if (!currentDetailMember) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text(currentDetailMember, 105, 30, { align: 'center' });
            
            const present = parseInt(document.getElementById('member-detail-present').textContent);
            const absent = parseInt(document.getElementById('member-detail-absent').textContent);
            const rate = document.getElementById('member-detail-rate').textContent;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let y = 55;
            doc.text('Dabei: ' + present + '  |  Gefehlt: ' + absent + '  |  Quote: ' + rate, 105, y, { align: 'center' });
            
            doc.save('LKT_' + currentDetailMember.replace(/\s/g, '_') + '_Report.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportAnzeigenPDF() {
            if (allAnzeigenData.length === 0) { showToast('Keine Anzeigen', true); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Strafanzeigen 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            allAnzeigenData.forEach((a, i) => {
                if (y > 240) { doc.addPage(); y = 20; }
                doc.setFillColor(255, 240, 240);
                doc.setDrawColor(239, 68, 68);
                doc.rect(15, y - 5, 180, 40, 'FD');
                doc.setTextColor(239, 68, 68);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Anzeige #' + (i + 1), 20, y + 2);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(a.melder + ' vs. ' + a.beschuldigter, 20, y + 12);
                doc.setFontSize(9);
                doc.text('Tatbestand: ' + (a.tatbestand || '').substring(0, 70), 20, y + 22);
                doc.setTextColor(239, 68, 68);
                doc.setFont(undefined, 'bold');
                doc.text('Strafe: ' + a.strafe, 20, y + 32);
                y += 50;
            });
            
            doc.save('LKT_Strafanzeigen_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + (isError ? 'error' : 'success');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        
        function showConfig() {
            // FÃ¼r alle: Daten aktualisieren
            if (currentUser && currentUser.role === 'member') {
                if (offlineQueue.length > 0) {
                    if (navigator.onLine) {
                        syncOfflineQueue();
                    } else {
                        showToast('Keine Internetverbindung - ' + offlineQueue.length + ' Aktion(en) warten', true);
                    }
                } else {
                    refreshData();
                    showToast('Daten synchronisiert!');
                }
            } else {
                // FÃ¼r Admin/Chef: auch nur Daten aktualisieren
                refreshData();
                showToast('Daten synchronisiert!');
            }
        }
        
        function getOfflineEvents() {
            return [
                { id: 'WE1-1', week: 'WE 1', date: '09.01.2026', name: 'Narrenbaumstellen Taldorf', location: 'LK Taldorf', time: '' },
                { id: 'WE1-2', week: 'WE 1', date: '10.01.2026', name: 'Narrenbaumstellen Taldorf', location: 'LK Taldorf', time: '' },
                { id: 'WE1-3', week: 'WE 1', date: '11.01.2026', name: 'Narrenbaumstellen Taldorf', location: 'LK Taldorf', time: '' },
                { id: 'WE2-1', week: 'WE 2', date: '16.01.2026', name: 'Jugendball Bitzenhofen', location: 'NZ Bitzenhofen', time: '21:00' },
                { id: 'WE2-2', week: 'WE 2', date: '16.01.2026', name: 'Elchball', location: 'MV Ettenkirch', time: '00:30' },
                { id: 'WE2-3', week: 'WE 2', date: '17.01.2026', name: 'Umzug Neuravensburg', location: 'NZ Neuravensburg BÃ¤ren', time: '13:30' },
                { id: 'WE2-4', week: 'WE 2', date: '17.01.2026', name: 'Butzlumpa-Ball', location: 'LaJu KO/LK Butzlumpa', time: '21:00' },
                { id: 'WE2-5', week: 'WE 2', date: '17.01.2026', name: 'MÃ¤dla-Ball', location: 'LK Leupolz', time: '23:00' },
                { id: 'WE2-6', week: 'WE 2', date: '18.01.2026', name: 'Umzug Langenargen', location: 'NZ Dammglonker', time: '13:00' },
                { id: 'WE3-1', week: 'WE 3', date: '23.01.2026', name: 'Urknall-Ball', location: 'LK Allgaier Urband', time: '20:00' },
                { id: 'WE3-2', week: 'WE 3', date: '23.01.2026', name: 'Interne Veranstaltung', location: 'LK FÃ¶tzlesbrass', time: '00:00' },
                { id: 'WE3-3', week: 'WE 3', date: '24.01.2026', name: 'JubilÃ¤umsumzug Erbisreute', location: 'Erbisreuter Dorfnarren', time: '13:00' },
                { id: 'WE3-4', week: 'WE 3', date: '25.01.2026', name: 'Narrensprung Kluftern', location: 'NZ Kluftern', time: '13:30' },
                { id: 'WE4-1', week: 'WE 4', date: '30.01.2026', name: 'Zirkusball', location: 'LK Mecka', time: '23:30' },
                { id: 'WE4-2', week: 'WE 4', date: '31.01.2026', name: 'Narrenbaumstellen Bitzenhofen', location: 'NZ Bitzenhofen', time: '13:00' },
                { id: 'WE5-1', week: 'WE 5', date: '07.02.2026', name: 'DÃ¤mmerumzug Hergensweiler', location: 'NZ Federfuxer', time: '16:00' },
                { id: 'WE5-2', week: 'WE 5', date: '07.02.2026', name: 'AprÃ©s-Ski Ball', location: 'NZ Ettenkirch', time: '23:30' },
                { id: 'WE5-3', week: 'WE 5', date: '08.02.2026', name: 'Umzug Meersburg', location: 'NZ Meersburg', time: '13:00' },
                { id: 'HF-1', week: 'Hauptfasnet', date: '11.02.2026', name: 'Weiberball', location: 'LÃ¶wen Urnau', time: '22:00' },
                { id: 'HF-2', week: 'Hauptfasnet', date: '12.02.2026', name: 'Golm', location: 'Berggasthof Golm', time: '11:00' },
                { id: 'HF-3', week: 'Hauptfasnet', date: '13.02.2026', name: 'Kindergartenbefreiung', location: 'Taldorf', time: '09:00' },
                { id: 'HF-4', week: 'Hauptfasnet', date: '13.02.2026', name: 'SchÃ¼lerbefreiung', location: 'Wilhelmsschule RV', time: '10:00' },
                { id: 'HF-5', week: 'Hauptfasnet', date: '13.02.2026', name: 'OWB', location: 'OWB Ravensburg', time: '11:30' },
                { id: 'HF-6', week: 'Hauptfasnet', date: '13.02.2026', name: 'Narrenbaumstellen Bavendorf', location: 'NV Bavendorf', time: '14:00' },
                { id: 'HF-7', week: 'Hauptfasnet', date: '14.02.2026', name: 'Narrensprung Aitrach', location: 'NZ Aitrach', time: '13:30' },
                { id: 'HF-8', week: 'Hauptfasnet', date: '14.02.2026', name: 'Ball Aitrach', location: 'NZ Aitrach', time: '23:30' },
                { id: 'HF-9', week: 'Hauptfasnet', date: '15.02.2026', name: 'Narrensprung Brochenzell', location: 'NZ Brochenzell', time: '14:00' },
                { id: 'HF-10', week: 'Hauptfasnet', date: '16.02.2026', name: 'Rosenmontagssprung Fulda', location: 'Wolkenkratzer Fulda', time: '13:30' },
                { id: 'HF-11', week: 'Hauptfasnet', date: '17.02.2026', name: 'Heimfahrt Fulda', location: '', time: '' },
            ];
        }
        
        // ============================================================
        // ROLLEN VERWALTUNG
        // ============================================================
        let rollenData = [];
        let currentEditRolleId = null;
        
        async function loadRollen() {
            try {
                const result = await apiGet('getRollen');
                rollenData = result.rollen || [];
                renderRollenList();
            } catch (e) { console.log('Rollen laden Fehler:', e); }
        }
        
        function renderRollenList() {
            const container = document.getElementById('rollen-list');
            if (!container) return;
            
            if (rollenData.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Rollen definiert</div>';
                return;
            }
            
            let html = '';
            rollenData.forEach(rolle => {
                const isSystem = ['ROLE-ADMIN', 'ROLE-MITGLIED'].includes(rolle.id);
                const perms = [];
                if (rolle.isAdmin) perms.push('Admin');
                if (rolle.canManageMembers) perms.push('Mitglieder');
                if (rolle.canManageEvents) perms.push('Events');
                if (rolle.canManageAnzeigen) perms.push('Anzeigen');
                
                html += '<div class="rolle-item ' + (isSystem ? 'system-rolle' : '') + '">';
                html += '<div><div class="rolle-name">' + rolle.name + (isSystem ? ' ğŸ”’' : '') + '</div>';
                html += '<div class="rolle-perms">' + (perms.length > 0 ? perms.join(', ') : 'Basis-Rechte') + '</div></div>';
                html += '<div>';
                html += '<button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="editRolle(\'' + rolle.id + '\')">âœï¸</button>';
                if (!isSystem) html += ' <button class="btn btn-danger" style="padding: 0.25rem 0.5rem;" onclick="deleteRolleConfirm(\'' + rolle.id + '\')">ğŸ—‘ï¸</button>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function showAddRolleModal() {
            currentEditRolleId = null;
            document.getElementById('rolle-modal-title').textContent = 'Neue Rolle erstellen';
            document.getElementById('rolle-name-input').value = '';
            // Reset alle Checkboxen
            document.getElementById('perm-viewAllMembers').checked = false;
            document.getElementById('perm-viewAllAttendance').checked = false;
            document.getElementById('perm-viewOwnRegister').checked = true;
            document.getElementById('perm-manageEvents').checked = false;
            document.getElementById('perm-manageMembers').checked = false;
            document.getElementById('perm-manageRoles').checked = false;
            document.getElementById('perm-manageAnzeigen').checked = false;
            document.getElementById('perm-createForumCategories').checked = false;
            document.getElementById('perm-isAdmin').checked = false;
            document.getElementById('perm-isRegisterleiter').checked = false;
            document.getElementById('rolle-modal').classList.add('active');
        }
        
        function editRolle(rollenId) {
            const rolle = rollenData.find(r => r.id === rollenId);
            if (!rolle) return;
            
            currentEditRolleId = rollenId;
            document.getElementById('rolle-modal-title').textContent = 'Rolle bearbeiten: ' + rolle.name;
            document.getElementById('rolle-name-input').value = rolle.name;
            document.getElementById('perm-viewAllMembers').checked = rolle.canViewAllMembers;
            document.getElementById('perm-viewAllAttendance').checked = rolle.canViewAllAttendance;
            document.getElementById('perm-viewOwnRegister').checked = rolle.canViewOwnRegister;
            document.getElementById('perm-manageEvents').checked = rolle.canManageEvents;
            document.getElementById('perm-manageMembers').checked = rolle.canManageMembers;
            document.getElementById('perm-manageRoles').checked = rolle.canManageRoles;
            document.getElementById('perm-manageAnzeigen').checked = rolle.canManageAnzeigen;
            document.getElementById('perm-createForumCategories').checked = rolle.canCreateForumCategories;
            document.getElementById('perm-isAdmin').checked = rolle.isAdmin;
            document.getElementById('perm-isRegisterleiter').checked = rolle.isRegisterleiter || false;
            document.getElementById('rolle-modal').classList.add('active');
        }
        
        function closeRolleModal() {
            document.getElementById('rolle-modal').classList.remove('active');
            currentEditRolleId = null;
        }
        
        async function saveRolle() {
            const name = document.getElementById('rolle-name-input').value.trim();
            if (!name) { showToast('Name erforderlich', true); return; }
            
            const rolle = {
                name: name,
                canViewAllMembers: document.getElementById('perm-viewAllMembers').checked,
                canViewAllAttendance: document.getElementById('perm-viewAllAttendance').checked,
                canViewOwnRegister: document.getElementById('perm-viewOwnRegister').checked,
                canManageEvents: document.getElementById('perm-manageEvents').checked,
                canManageMembers: document.getElementById('perm-manageMembers').checked,
                canManageRoles: document.getElementById('perm-manageRoles').checked,
                canManageAnzeigen: document.getElementById('perm-manageAnzeigen').checked,
                canCreateForumCategories: document.getElementById('perm-createForumCategories').checked,
                isAdmin: document.getElementById('perm-isAdmin').checked,
                isRegisterleiter: document.getElementById('perm-isRegisterleiter').checked
            };
            
            showLoading();
            try {
                let result;
                if (currentEditRolleId) {
                    result = await apiPost({ action: 'updateRolle', rollenId: currentEditRolleId, rolle: rolle });
                } else {
                    result = await apiPost({ action: 'addRolle', rolle: rolle });
                }
                if (result.error) { showToast(result.error, true); }
                else { showToast(result.message); closeRolleModal(); await loadRollen(); }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteRolleConfirm(rollenId) {
            const rolle = rollenData.find(r => r.id === rollenId);
            if (!confirm('Rolle "' + rolle.name + '" wirklich lÃ¶schen? Mitglieder mit dieser Rolle werden zu "Mitglied" zurÃ¼ckgesetzt.')) return;
            
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteRolle', rollenId: rollenId });
                if (result.error) showToast(result.error, true);
                else { showToast(result.message); await loadRollen(); }
            } catch (e) { showToast('Fehler', true); }
            hideLoading();
        }
        
        // ============================================================
        // REGISTER-ANFRAGEN
        // ============================================================
        let registerAnfragenData = [];
        
        async function loadRegisterAnfragen() {
            try {
                const result = await apiGet('getRegisterAnfragen');
                registerAnfragenData = result.anfragen || [];
                renderRegisterAnfragen();
                // Badge aktualisieren
                const badge = document.getElementById('anfragen-count');
                if (badge) badge.textContent = registerAnfragenData.length;
            } catch (e) { console.log('Anfragen laden Fehler:', e); }
        }
        
        function renderRegisterAnfragen() {
            const container = document.getElementById('register-anfragen-list');
            if (!container) return;
            
            if (registerAnfragenData.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine offenen Anfragen</div>';
                return;
            }
            
            let html = '';
            registerAnfragenData.forEach(anfrage => {
                html += '<div class="anfrage-item">';
                html += '<div class="anfrage-header"><strong>' + anfrage.memberName + '</strong></div>';
                html += '<div class="anfrage-change">ğŸµ ' + (anfrage.altesRegister || 'Kein Register') + ' â†’ ' + anfrage.neuesRegister + '</div>';
                html += '<div class="anfrage-actions">';
                html += '<button class="btn btn-primary" onclick="handleAnfrage(\'' + anfrage.id + '\', true)">âœ“ Genehmigen</button>';
                html += '<button class="btn btn-danger" onclick="handleAnfrage(\'' + anfrage.id + '\', false)">âœ— Ablehnen</button>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }
        
        async function handleAnfrage(requestId, approved) {
            showLoading();
            try {
                const result = await apiPost({ action: 'handleRegisterRequest', requestId: requestId, approved: approved });
                if (result.error) showToast(result.error, true);
                else { showToast(result.message); await loadRegisterAnfragen(); }
            } catch (e) { showToast('Fehler', true); }
            hideLoading();
        }
        
        // ============================================================
        // FORUM-BEREICHE
        // ============================================================
        let forumBereicheData = [];
        let currentForumBereichId = 'FORUM-ALLGEMEIN';
        
        async function loadForumBereiche() {
            try {
                const result = await apiGet('getForumBereiche');
                forumBereicheData = result.bereiche || [];
                renderForumBereicheList();
                renderForumTabs();
            } catch (e) { console.log('Forum-Bereiche laden Fehler:', e); }
        }
        
        function renderForumBereicheList() {
            const container = document.getElementById('forum-bereiche-list');
            if (!container) return;
            
            if (forumBereicheData.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Bereiche</div>';
                return;
            }
            
            let html = '';
            forumBereicheData.forEach(bereich => {
                const isSystem = bereich.id === 'FORUM-ALLGEMEIN';
                html += '<div class="bereich-item">';
                html += '<div><strong>' + bereich.name + '</strong>';
                html += '<div class="bereich-typ">' + getBereichTypLabel(bereich.typ) + '</div></div>';
                if (!isSystem) html += '<button class="btn btn-danger" style="padding: 0.25rem 0.5rem;" onclick="deleteForumBereichConfirm(\'' + bereich.id + '\')">ğŸ—‘ï¸</button>';
                html += '</div>';
            });
            container.innerHTML = html;
        }
        
        function getBereichTypLabel(typ) {
            const labels = { allgemein: 'ğŸŒ Allgemein', register: 'ğŸµ Register', admin: 'ğŸ”§ Admin', custom: 'ğŸ“ Benutzerdefiniert' };
            return labels[typ] || typ;
        }
        
        function renderForumTabs() {
            // FÃ¼r Mitglieder-Brett
            const memberContainer = document.getElementById('forum-tabs-member');
            // FÃ¼r Admin-Brett
            const adminContainer = document.getElementById('forum-tabs-admin');
            
            if (!memberContainer && !adminContainer) return;
            
            const permissions = currentUser.permissions || {};
            
            let html = '';
            forumBereicheData.forEach(bereich => {
                // Nur Admin-Bereich filtern - alle anderen Bereiche fÃ¼r alle sichtbar
                if (bereich.typ === 'admin' && !permissions.isAdmin) return;
                
                const isActive = bereich.id === currentForumBereichId ? 'active' : '';
                const isRegister = bereich.typ === 'register' ? 'register-tab' : '';
                html += '<button class="forum-tab ' + isActive + ' ' + isRegister + '" onclick="selectForumBereich(\'' + bereich.id + '\')">' + bereich.name + '</button>';
            });
            
            if (memberContainer) memberContainer.innerHTML = html;
            if (adminContainer) adminContainer.innerHTML = html;
        }
        
        function selectForumBereich(bereichId) {
            currentForumBereichId = bereichId;
            renderForumTabs();
            loadBrettPosts(currentUser.role === 'gericht' ? 'gericht' : 'member');
        }
        
        async function addNewForumBereich() {
            const name = document.getElementById('new-bereich-name').value.trim();
            const typ = document.getElementById('new-bereich-typ').value;
            
            if (!name) { showToast('Name erforderlich', true); return; }
            
            showLoading();
            try {
                const result = await apiPost({ action: 'addForumBereich', name: name, typ: typ, erstelltVon: currentUser.name });
                if (result.error) showToast(result.error, true);
                else { 
                    showToast(result.message); 
                    document.getElementById('new-bereich-name').value = '';
                    await loadForumBereiche(); 
                }
            } catch (e) { showToast('Fehler', true); }
            hideLoading();
        }
        
        async function deleteForumBereichConfirm(bereichId) {
            const bereich = forumBereicheData.find(b => b.id === bereichId);
            if (!confirm('Bereich "' + bereich.name + '" wirklich lÃ¶schen? Posts werden zum Allgemein-Bereich verschoben.')) return;
            
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteForumBereich', bereichId: bereichId });
                if (result.error) showToast(result.error, true);
                else { showToast(result.message); await loadForumBereiche(); }
            } catch (e) { showToast('Fehler', true); }
            hideLoading();
        }
        
        // ============================================================
        // REGISTER-WECHSEL FÃœR MITGLIEDER
        // ============================================================
        async function requestRegisterChange(neuesRegisterId) {
            if (!currentUser.memberId) { showToast('Fehler: Keine MemberId', true); return; }
            
            showLoading();
            try {
                const result = await apiPost({ action: 'requestRegisterChange', memberId: currentUser.memberId, neuesRegisterId: neuesRegisterId });
                if (result.error) showToast(result.error, true);
                else if (result.approved) {
                    showToast('Register geÃ¤ndert!');
                    currentUser.registerId = neuesRegisterId;
                    localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                    populateProfileSelects();
                } else {
                    showToast('Anfrage gesendet - Admin muss bestÃ¤tigen');
                }
            } catch (e) { showToast('Fehler', true); }
            hideLoading();
        }
        
        // ============================================================
        // WOCHENEND-ÃœBERSICHT
        // ============================================================
        let weekendAttendanceData = {};
        
        function populateWeekendSelect() {
            const select = document.getElementById('weekend-select');
            if (!select) return;
            
            // Sammle alle Wochen aus Events
            const weeks = new Set();
            eventsData.forEach(e => {
                if (e.week) weeks.add(e.week);
            });
            
            let html = '<option value="">-- Wochenende wÃ¤hlen --</option>';
            Array.from(weeks).sort().forEach(week => {
                html += '<option value="' + week + '">' + week + '</option>';
            });
            select.innerHTML = html;
        }
        
        async function loadWeekendOverview() {
            const week = document.getElementById('weekend-select').value;
            const container = document.getElementById('weekend-overview');
            const exportBtn = document.getElementById('weekend-export-btn');
            
            if (!week) {
                container.innerHTML = '';
                if (exportBtn) exportBtn.classList.add('hidden');
                return;
            }
            
            showLoading();
            if (exportBtn) exportBtn.classList.remove('hidden');
            
            // Events fÃ¼r dieses Wochenende filtern
            const weekEvents = eventsData.filter(e => e.week === week);
            
            if (weekEvents.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Auftritte fÃ¼r dieses Wochenende</div>';
                if (exportBtn) exportBtn.classList.add('hidden');
                hideLoading();
                return;
            }
            
            // Anwesenheitsdaten fÃ¼r alle Events laden
            try {
                for (const event of weekEvents) {
                    const result = await apiGet('getEventAttendance', { eventId: event.id });
                    // Konvertiere Objekt {name: boolean} zu Array [{name, status, comment}]
                    const attObj = result.attendance || {};
                    const attArray = [];
                    for (const name in attObj) {
                        attArray.push({
                            name: name,
                            status: attObj[name] ? 'anwesend' : 'abwesend',
                            comment: ''
                        });
                    }
                    weekendAttendanceData[event.id] = attArray;
                }
            } catch (e) {
                console.log('Weekend attendance error:', e);
            }
            
            renderWeekendOverview(weekEvents, week);
            hideLoading();
        }
        
        function renderWeekendOverview(weekEvents, week) {
            const container = document.getElementById('weekend-overview');
            
            // Gesamtstatistik berechnen
            let totalPresent = 0, totalAbsent = 0, totalUnknown = 0;
            weekEvents.forEach(event => {
                const att = weekendAttendanceData[event.id] || [];
                if (Array.isArray(att)) {
                    att.forEach(a => {
                        if (a.status === 'anwesend') totalPresent++;
                        else if (a.status === 'abwesend') totalAbsent++;
                    });
                    // Unbekannt = Mitglieder ohne Eintrag
                    const knownNames = att.map(a => a.name.toLowerCase());
                    allMembersData.forEach(m => {
                        if (!knownNames.includes(m.name.toLowerCase())) totalUnknown++;
                    });
                }
            });
            
            let html = '';
            
            // Zusammenfassung
            html += '<div class="weekend-summary">';
            html += '<div class="stat-box"><div class="number" style="color: var(--accent-green);">' + totalPresent + '</div><div class="label">Anwesend</div></div>';
            html += '<div class="stat-box"><div class="number" style="color: var(--accent-red);">' + totalAbsent + '</div><div class="label">Abwesend</div></div>';
            html += '<div class="stat-box"><div class="number">' + weekEvents.length + '</div><div class="label">Auftritte</div></div>';
            html += '</div>';
            
            // Events anzeigen
            weekEvents.forEach(event => {
                const att = weekendAttendanceData[event.id] || [];
                const present = att.filter(a => a.status === 'anwesend').length;
                const absent = att.filter(a => a.status === 'abwesend').length;
                
                // Register-Statistik
                const registerStats = {};
                registerData.forEach(r => {
                    registerStats[r.id] = { name: r.name, present: 0, total: 0 };
                });
                registerStats['none'] = { name: 'Ohne Register', present: 0, total: 0 };
                
                // Mitglieder pro Register zÃ¤hlen
                allMembersData.forEach(m => {
                    const regId = m.registerId || 'none';
                    if (registerStats[regId]) registerStats[regId].total++;
                });
                
                // Anwesende pro Register zÃ¤hlen
                att.filter(a => a.status === 'anwesend').forEach(a => {
                    const member = allMembersData.find(m => m.name.toLowerCase() === a.name.toLowerCase());
                    const regId = member ? (member.registerId || 'none') : 'none';
                    if (registerStats[regId]) registerStats[regId].present++;
                });
                
                html += '<div class="weekend-event-card" onclick="showWeekendEventDetail(\'' + event.id + '\')">';
                html += '<div class="event-name">' + event.name + '</div>';
                html += '<div class="event-info">ğŸ“ ' + (event.location || '-') + ' | ğŸ• ' + (event.time || '-') + ' | ' + (event.date || '') + '</div>';
                html += '<div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">';
                html += '<span style="color: var(--accent-green);">âœ“ ' + present + '</span>';
                html += '<span style="color: var(--accent-red);">âœ— ' + absent + '</span>';
                html += '</div>';
                
                // Register-Balken
                html += '<div class="register-bars">';
                Object.values(registerStats).filter(r => r.total > 0).forEach(r => {
                    const percent = r.total > 0 ? Math.round(r.present / r.total * 100) : 0;
                    html += '<div class="register-bar">';
                    html += '<div class="bar-label">' + r.name + '</div>';
                    html += '<div class="bar-container"><div class="bar-fill" style="width: ' + percent + '%;"></div></div>';
                    html += '<div class="bar-count">' + r.present + '/' + r.total + '</div>';
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function showWeekendEventDetail(eventId) {
            const event = eventsData.find(e => e.id === eventId);
            if (!event) return;
            
            const att = weekendAttendanceData[eventId] || [];
            const present = att.filter(a => a.status === 'anwesend');
            const absent = att.filter(a => a.status === 'abwesend');
            
            // Unbekannte Mitglieder (ohne Eintrag)
            const knownNames = att.map(a => a.name.toLowerCase());
            const unknown = allMembersData.filter(m => !knownNames.includes(m.name.toLowerCase()));
            
            document.getElementById('weekend-event-title').textContent = event.name;
            
            // Stats
            let statsHtml = '<div style="display: flex; gap: 1rem; justify-content: center;">';
            statsHtml += '<span style="color: var(--accent-green); font-size: 1.2rem;">âœ“ ' + present.length + ' anwesend</span>';
            statsHtml += '<span style="color: var(--accent-red); font-size: 1.2rem;">âœ— ' + absent.length + ' abwesend</span>';
            statsHtml += '<span style="color: var(--text-secondary); font-size: 1.2rem;">? ' + unknown.length + ' unbekannt</span>';
            statsHtml += '</div>';
            document.getElementById('weekend-event-stats').innerHTML = statsHtml;
            
            // Register-Statistik
            const registerStats = {};
            registerData.forEach(r => {
                registerStats[r.id] = { name: r.name, present: [], absent: [], unknown: [] };
            });
            registerStats['none'] = { name: 'Ohne Register', present: [], absent: [], unknown: [] };
            
            // Mitglieder nach Register gruppieren
            present.forEach(a => {
                const member = allMembersData.find(m => m.name.toLowerCase() === a.name.toLowerCase());
                const regId = member ? (member.registerId || 'none') : 'none';
                if (registerStats[regId]) registerStats[regId].present.push(a.name);
            });
            
            absent.forEach(a => {
                const member = allMembersData.find(m => m.name.toLowerCase() === a.name.toLowerCase());
                const regId = member ? (member.registerId || 'none') : 'none';
                if (registerStats[regId]) registerStats[regId].absent.push({ name: a.name, comment: a.comment });
            });
            
            unknown.forEach(m => {
                const regId = m.registerId || 'none';
                if (registerStats[regId]) registerStats[regId].unknown.push(m.name);
            });
            
            let regHtml = '';
            Object.values(registerStats).filter(r => r.present.length + r.absent.length + r.unknown.length > 0).forEach(r => {
                const total = r.present.length + r.absent.length + r.unknown.length;
                regHtml += '<div style="margin-bottom: 0.75rem; padding: 0.5rem; background: var(--bg-input); border-radius: 8px;">';
                regHtml += '<strong>' + r.name + '</strong>: ';
                regHtml += '<span style="color: var(--accent-green);">' + r.present.length + 'âœ“</span> / ';
                regHtml += '<span style="color: var(--accent-red);">' + r.absent.length + 'âœ—</span> / ';
                regHtml += '<span style="color: var(--text-secondary);">' + r.unknown.length + '?</span>';
                regHtml += ' (von ' + total + ')';
                regHtml += '</div>';
            });
            document.getElementById('weekend-event-registers').innerHTML = regHtml || '<div class="empty-state">Keine Register-Daten</div>';
            
            // Mitglieder-Liste
            let membersHtml = '';
            
            // Anwesende
            present.forEach(a => {
                const member = allMembersData.find(m => m.name.toLowerCase() === a.name.toLowerCase());
                const regName = member && member.registerId ? (registerData.find(r => r.id === member.registerId)?.name || '') : '';
                membersHtml += '<div class="member-attendance-row anwesend">';
                membersHtml += '<div><strong>' + a.name + '</strong>' + (regName ? ' <span style="color: var(--text-secondary); font-size: 0.8rem;">(' + regName + ')</span>' : '') + '</div>';
                membersHtml += '<div class="status-icon">âœ“</div>';
                membersHtml += '</div>';
            });
            
            // Abwesende
            absent.forEach(a => {
                const member = allMembersData.find(m => m.name.toLowerCase() === a.name.toLowerCase());
                const regName = member && member.registerId ? (registerData.find(r => r.id === member.registerId)?.name || '') : '';
                membersHtml += '<div class="member-attendance-row abwesend">';
                membersHtml += '<div><strong>' + a.name + '</strong>' + (regName ? ' <span style="color: var(--text-secondary); font-size: 0.8rem;">(' + regName + ')</span>' : '');
                if (a.comment) membersHtml += '<br><span style="font-size: 0.8rem; color: var(--text-secondary);">ğŸ’¬ ' + escapeHtml(a.comment) + '</span>';
                membersHtml += '</div>';
                membersHtml += '<div class="status-icon">âœ—</div>';
                membersHtml += '</div>';
            });
            
            // Unbekannte
            unknown.forEach(m => {
                const regName = m.registerId ? (registerData.find(r => r.id === m.registerId)?.name || '') : '';
                membersHtml += '<div class="member-attendance-row unknown">';
                membersHtml += '<div><strong>' + m.name + '</strong>' + (regName ? ' <span style="color: var(--text-secondary); font-size: 0.8rem;">(' + regName + ')</span>' : '') + '</div>';
                membersHtml += '<div class="status-icon">?</div>';
                membersHtml += '</div>';
            });
            
            document.getElementById('weekend-event-members').innerHTML = membersHtml || '<div class="empty-state">Keine Mitglieder</div>';
            
            document.getElementById('weekend-event-modal').classList.add('active');
        }
        
        function closeWeekendEventModal() {
            document.getElementById('weekend-event-modal').classList.remove('active');
        }
        
        // ============================================================
        // EVENT BEARBEITEN
        // ============================================================
        
        function renderEventsManageList() {
            const container = document.getElementById('events-manage-list');
            if (!container) return;
            
            if (eventsData.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Events</div>';
                return;
            }
            
            let html = '';
            eventsData.forEach(event => {
                html += '<div class="event-manage-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">';
                html += '<div><strong>' + event.name + '</strong><br><span style="font-size: 0.8rem; color: var(--text-secondary);">' + (event.date || '') + ' | ' + (event.week || '') + '</span></div>';
                html += '<button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="openEventEditModal(\'' + event.id + '\')">âœï¸</button>';
                html += '</div>';
            });
            container.innerHTML = html;
        }
        
        function openEventEditModal(eventId) {
            const event = eventsData.find(e => e.id === eventId);
            if (!event) return;
            
            document.getElementById('edit-event-id').value = eventId;
            document.getElementById('edit-event-name').value = event.name || '';
            document.getElementById('edit-event-week').value = event.week || '';
            document.getElementById('edit-event-date').value = event.date || '';
            document.getElementById('edit-event-location').value = event.location || '';
            document.getElementById('edit-event-time').value = event.time || '';
            
            document.getElementById('event-edit-modal').classList.add('active');
        }
        
        function closeEventEditModal() {
            document.getElementById('event-edit-modal').classList.remove('active');
        }
        
        async function saveEventEdit() {
            const eventId = document.getElementById('edit-event-id').value;
            const eventData = {
                name: document.getElementById('edit-event-name').value.trim(),
                week: document.getElementById('edit-event-week').value.trim(),
                date: document.getElementById('edit-event-date').value.trim(),
                location: document.getElementById('edit-event-location').value.trim(),
                time: document.getElementById('edit-event-time').value.trim()
            };
            
            if (!eventData.name) { showToast('Name erforderlich', true); return; }
            
            showLoading();
            try {
                const result = await apiPost({ action: 'updateEvent', eventId: eventId, event: eventData });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Event aktualisiert!');
                    closeEventEditModal();
                    await refreshData();
                    renderEventsManageList();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteEventFromModal() {
            const eventId = document.getElementById('edit-event-id').value;
            const event = eventsData.find(e => e.id === eventId);
            if (!confirm('Event "' + event.name + '" wirklich lÃ¶schen?')) return;
            
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteEvent', eventId: eventId });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Event gelÃ¶scht!');
                    closeEventEditModal();
                    await refreshData();
                    renderEventsManageList();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // PUSH BENACHRICHTIGUNGEN
        // ============================================================
        
        let pushSubscription = null;
        
        async function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                document.getElementById('push-not-supported')?.classList.remove('hidden');
                document.getElementById('push-settings-container')?.classList.add('hidden');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                pushSubscription = await registration.pushManager.getSubscription();
                
                if (pushSubscription) {
                    document.getElementById('push-enable-btn')?.classList.add('hidden');
                    document.getElementById('push-settings')?.classList.remove('hidden');
                    await loadPushSettings();
                }
            } catch (e) {
                console.log('Push init error:', e);
            }
        }
        
        async function enablePushNotifications() {
            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showToast('Benachrichtigungen wurden abgelehnt', true);
                    return;
                }
                
                const registration = await navigator.serviceWorker.ready;
                
                // VAPID Public Key - muss durch echten Key ersetzt werden
                const vapidPublicKey = 'YOUR_VAPID_PUBLIC_KEY_HERE';
                
                // FÃ¼r lokale Tests ohne echten VAPID Key
                if (vapidPublicKey === 'YOUR_VAPID_PUBLIC_KEY_HERE') {
                    // Simuliere Subscription fÃ¼r lokale Tests
                    showToast('Push aktiviert (Demo-Modus)');
                    document.getElementById('push-enable-btn').classList.add('hidden');
                    document.getElementById('push-settings').classList.remove('hidden');
                    savePushSettingsLocal();
                    return;
                }
                
                pushSubscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });
                
                // Subscription an Server senden
                if (currentUser && currentUser.memberId) {
                    await apiPost({
                        action: 'savePushSubscription',
                        memberId: currentUser.memberId,
                        subscription: pushSubscription.toJSON()
                    });
                }
                
                showToast('Benachrichtigungen aktiviert!');
                document.getElementById('push-enable-btn').classList.add('hidden');
                document.getElementById('push-settings').classList.remove('hidden');
                savePushSettingsLocal();
                
            } catch (e) {
                console.error('Push subscription error:', e);
                showToast('Fehler beim Aktivieren: ' + e.message, true);
            }
        }
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        async function loadPushSettings() {
            if (!currentUser || !currentUser.memberId) return;
            
            try {
                const result = await apiGet('getPushSettings', { memberId: currentUser.memberId });
                const settings = result.settings || {};
                
                document.getElementById('push-event-reminder').checked = settings.eventReminder !== false;
                document.getElementById('push-reminder-time').value = settings.reminderTime || '60';
                document.getElementById('push-forum-posts').checked = settings.forumPosts !== false;
                document.getElementById('push-register-posts').checked = settings.registerPosts !== false;
                
                // Reminder-Zeit nur anzeigen wenn Event-Reminder aktiv
                updateReminderTimeVisibility();
            } catch (e) {
                console.log('Push settings load error:', e);
            }
        }
        
        async function savePushSettingsLocal() {
            if (!currentUser || !currentUser.memberId) return;
            
            const settings = {
                eventReminder: document.getElementById('push-event-reminder').checked,
                reminderTime: document.getElementById('push-reminder-time').value,
                forumPosts: document.getElementById('push-forum-posts').checked,
                registerPosts: document.getElementById('push-register-posts').checked
            };
            
            updateReminderTimeVisibility();
            
            try {
                await apiPost({ action: 'savePushSettings', memberId: currentUser.memberId, settings: settings });
                showToast('Einstellungen gespeichert!');
            } catch (e) {
                console.log('Push settings save error:', e);
            }
        }
        
        function updateReminderTimeVisibility() {
            const reminderEnabled = document.getElementById('push-event-reminder').checked;
            const timeGroup = document.getElementById('reminder-time-group');
            if (timeGroup) {
                timeGroup.style.display = reminderEnabled ? 'block' : 'none';
            }
        }
        
        // ============================================================
        // PDF EXPORT WOCHENEND-ÃœBERSICHT
        // ============================================================
        
        async function exportWeekendPDF() {
            const week = document.getElementById('weekend-select').value;
            if (!week) { showToast('Bitte Wochenende wÃ¤hlen', true); return; }
            
            showLoading();
            
            const weekEvents = eventsData.filter(e => e.week === week);
            
            let content = '';
            content += '<html><head><meta charset="UTF-8"><title>Wochenend-Ãœbersicht ' + week + '</title>';
            content += '<style>';
            content += 'body { font-family: Arial, sans-serif; padding: 20px; }';
            content += 'h1 { color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 10px; }';
            content += 'h2 { color: #374151; margin-top: 30px; }';
            content += '.event-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 15px 0; page-break-inside: avoid; }';
            content += '.event-title { font-size: 18px; font-weight: bold; color: #1e40af; }';
            content += '.event-info { color: #666; margin: 5px 0; }';
            content += '.stats { display: flex; gap: 20px; margin: 10px 0; }';
            content += '.stat { padding: 5px 15px; border-radius: 5px; }';
            content += '.present { background: #d1fae5; color: #065f46; }';
            content += '.absent { background: #fee2e2; color: #991b1b; }';
            content += '.register-table { width: 100%; border-collapse: collapse; margin-top: 10px; }';
            content += '.register-table th, .register-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }';
            content += '.register-table th { background: #f3f4f6; }';
            content += '.member-list { columns: 2; column-gap: 20px; }';
            content += '.member-item { padding: 3px 0; }';
            content += '.member-item.present { color: #065f46; }';
            content += '.member-item.absent { color: #991b1b; }';
            content += '@media print { .event-card { page-break-inside: avoid; } }';
            content += '</style></head><body>';
            
            content += '<h1>ğŸº LKT Tracker - Wochenend-Ãœbersicht ' + week + '</h1>';
            content += '<p>Erstellt am: ' + new Date().toLocaleString('de-DE') + '</p>';
            
            // Gesamt-Statistik
            let totalPresent = 0, totalAbsent = 0;
            weekEvents.forEach(event => {
                const att = weekendAttendanceData[event.id] || [];
                totalPresent += att.filter(a => a.status === 'anwesend').length;
                totalAbsent += att.filter(a => a.status === 'abwesend').length;
            });
            
            content += '<div class="stats">';
            content += '<div class="stat present">âœ“ ' + totalPresent + ' Anwesend (gesamt)</div>';
            content += '<div class="stat absent">âœ— ' + totalAbsent + ' Abwesend (gesamt)</div>';
            content += '<div class="stat">' + weekEvents.length + ' Auftritte</div>';
            content += '</div>';
            
            // Events
            weekEvents.forEach(event => {
                const att = weekendAttendanceData[event.id] || [];
                const present = att.filter(a => a.status === 'anwesend');
                const absent = att.filter(a => a.status === 'abwesend');
                
                content += '<div class="event-card">';
                content += '<div class="event-title">' + event.name + '</div>';
                content += '<div class="event-info">ğŸ“ ' + (event.location || '-') + ' | ğŸ• ' + (event.time || '-') + ' | ' + (event.date || '') + '</div>';
                content += '<div class="stats">';
                content += '<div class="stat present">âœ“ ' + present.length + '</div>';
                content += '<div class="stat absent">âœ— ' + absent.length + '</div>';
                content += '</div>';
                
                // Register-Statistik
                const registerStats = {};
                registerData.forEach(r => { registerStats[r.id] = { name: r.name, present: 0, total: 0 }; });
                registerStats['none'] = { name: 'Ohne Register', present: 0, total: 0 };
                
                allMembersData.forEach(m => {
                    const regId = m.registerId || 'none';
                    if (registerStats[regId]) registerStats[regId].total++;
                });
                
                present.forEach(a => {
                    const member = allMembersData.find(m => m.name.toLowerCase() === a.name.toLowerCase());
                    const regId = member ? (member.registerId || 'none') : 'none';
                    if (registerStats[regId]) registerStats[regId].present++;
                });
                
                content += '<table class="register-table">';
                content += '<tr><th>Register</th><th>Anwesend</th><th>Gesamt</th><th>Quote</th></tr>';
                Object.values(registerStats).filter(r => r.total > 0).forEach(r => {
                    const quote = r.total > 0 ? Math.round(r.present / r.total * 100) : 0;
                    content += '<tr><td>' + r.name + '</td><td>' + r.present + '</td><td>' + r.total + '</td><td>' + quote + '%</td></tr>';
                });
                content += '</table>';
                
                // Teilnehmerliste
                content += '<h3>Teilnehmer</h3>';
                content += '<div class="member-list">';
                present.forEach(a => {
                    content += '<div class="member-item present">âœ“ ' + a.name + '</div>';
                });
                absent.forEach(a => {
                    content += '<div class="member-item absent">âœ— ' + a.name + (a.comment ? ' (' + a.comment + ')' : '') + '</div>';
                });
                content += '</div>';
                content += '</div>';
            });
            
            content += '</body></html>';
            
            // PDF Ã¶ffnen
            const printWindow = window.open('', '_blank');
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
            
            hideLoading();
        }
    </script>
</body>
</html>
