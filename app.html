<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LKT Tracker 2026</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent-yellow: #f5c518;
            --accent-gold: #ffd700;
            --accent-green: #4ade80;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Open Sans', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent-yellow); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 1rem; color: var(--text-secondary); }
        .header { background: linear-gradient(135deg, var(--bg-card) 0%, #0f0f23 100%); padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 3px solid var(--accent-yellow); }
        .header h1 { font-family: 'Bangers', cursive; font-size: 1.6rem; color: var(--accent-yellow); letter-spacing: 2px; }
        .header .user-info { display: inline-block; background: var(--accent-yellow); color: var(--bg-dark); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; margin-top: 0.5rem; }
        .header .user-info.gericht { background: var(--accent-gold); }
        .header .user-info.chef { background: var(--accent-blue); }
        .nav-tabs { display: flex; background: var(--bg-card); border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .nav-tab { flex: 1; min-width: max-content; padding: 0.75rem 0.5rem; text-align: center; cursor: pointer; transition: all 0.3s; border: none; background: none; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
        .nav-tab.active { color: var(--accent-yellow); border-bottom: 3px solid var(--accent-yellow); }
        .screen { display: none; padding: 1rem; }
        .screen.active { display: block; }
        .setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; text-align: center; }
        .setup-screen h1 { font-family: 'Bangers', cursive; font-size: 2.5rem; color: var(--accent-yellow); margin-bottom: 0.5rem; }
        .setup-screen .subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .setup-box { background: var(--bg-card); padding: 2rem; border-radius: 16px; width: 100%; max-width: 400px; }
        .role-buttons { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .role-btn { padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; background: transparent; color: var(--text-primary); cursor: pointer; transition: all 0.3s; text-align: left; }
        .role-btn:hover, .role-btn.selected { border-color: var(--accent-yellow); background: rgba(255, 215, 0, 0.1); }
        .role-btn .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .role-btn .title { font-weight: 700; font-size: 1.1rem; }
        .role-btn .desc { font-size: 0.85rem; color: var(--text-secondary); }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-dark); color: var(--text-primary); font-size: 1rem; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: var(--accent-yellow); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
        .btn-primary { background: var(--accent-yellow); color: var(--bg-dark); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-success { background: var(--accent-green); color: var(--bg-dark); }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; }
        .event-card { border-left: 4px solid var(--border-color); }
        .event-card.attended { border-left-color: var(--accent-green); }
        .event-card.absent { border-left-color: var(--accent-red); }
        .event-card.planned { border-left-color: var(--accent-blue); }
        .event-card .date { font-size: 0.8rem; color: var(--text-secondary); }
        .event-card .title { font-weight: 700; margin: 0.25rem 0; }
        .event-card .location { font-size: 0.85rem; color: var(--text-secondary); }
        .event-card .status { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem; }
        .event-card .status.present { background: rgba(74, 222, 128, 0.2); color: var(--accent-green); }
        .event-card .status.absent { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .event-card .status.planned { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .event-card .actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .event-card .actions .btn { flex: 1; padding: 0.5rem; font-size: 0.8rem; min-width: 80px; }
        .week-header { background: linear-gradient(90deg, var(--accent-yellow), transparent); color: var(--bg-dark); font-weight: 700; padding: 0.5rem 1rem; border-radius: 8px; margin: 1rem 0 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-card); padding: 1rem; border-radius: 12px; text-align: center; }
        .stat-card .number { font-size: 2rem; font-weight: 700; color: var(--accent-yellow); }
        .stat-card .label { font-size: 0.85rem; color: var(--text-secondary); }
        .leaderboard-item { display: flex; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .leaderboard-item .rank { width: 30px; height: 30px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 1rem; }
        .leaderboard-item:nth-child(1) .rank { background: gold; color: #000; }
        .leaderboard-item:nth-child(2) .rank { background: silver; color: #000; }
        .leaderboard-item:nth-child(3) .rank { background: #cd7f32; color: #fff; }
        .leaderboard-item .name { flex: 1; }
        .leaderboard-item .score { font-weight: 700; color: var(--accent-green); }
        .leaderboard-item .score.bad { color: var(--accent-red); }
        .anzeige-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid var(--accent-red); }
        .anzeige-card .header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .anzeige-card .vs { font-weight: 700; color: var(--accent-yellow); }
        .anzeige-card .date { font-size: 0.8rem; color: var(--text-secondary); }
        .anzeige-card .tatbestand { font-size: 0.9rem; color: var(--text-secondary); padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 0.5rem 0; }
        .anzeige-card .strafe { font-size: 0.85rem; color: var(--accent-red); font-weight: 600; }
        .info-box { background: rgba(245, 197, 24, 0.1); border: 1px solid var(--accent-yellow); border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .info-box p { font-size: 0.9rem; color: var(--text-secondary); }
        .section-header { margin: 1.5rem 0 1rem; }
        .section-header h2 { font-size: 1.1rem; color: var(--accent-yellow); border-bottom: 2px solid var(--accent-yellow); padding-bottom: 0.5rem; }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent-green); color: white; padding: 1rem 2rem; border-radius: 8px; opacity: 0; transition: opacity 0.3s; z-index: 9999; font-weight: 600; }
        .toast.show { opacity: 1; }
        .toast.error { background: var(--accent-red); }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--accent-red); color: white; text-align: center; padding: 0.5rem; font-size: 0.8rem; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s; }
        .offline-banner.show { transform: translateY(0); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 500; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 1rem; color: var(--accent-yellow); }
        .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .modal-actions .btn { flex: 1; }
        .config-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; z-index: 100; }
        .hidden { display: none !important; }
        #qr-reader { border: 2px solid var(--accent-yellow); border-radius: 12px; overflow: hidden; }
        .attendance-row { display: flex; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; gap: 0.75rem; }
        .attendance-row .member-name { flex: 1; font-weight: 600; font-size: 0.95rem; }
        .attendance-buttons { display: flex; gap: 0.5rem; }
        .att-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color); background: transparent; color: var(--text-secondary); font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
        .att-btn:hover { border-color: var(--accent-yellow); }
        .att-btn.present { background: var(--accent-green); border-color: var(--accent-green); color: white; }
        .att-btn.absent { background: var(--accent-red); border-color: var(--accent-red); color: white; }
        .filter-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filter-row select { flex: 1; min-width: 120px; }
        .tag { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; }
        .tag.bus { background: var(--accent-blue); color: white; }
        .tag.register { background: var(--accent-purple); color: white; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .list-item .name { font-weight: 600; }
        .list-item .actions { display: flex; gap: 0.5rem; }
        .plan-btn { padding: 0.3rem 0.6rem; font-size: 0.75rem; border-radius: 4px; }
        .plan-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .brett-post { background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid var(--accent-green); }
        .brett-post .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .brett-post .post-title { font-weight: 700; font-size: 1.1rem; color: var(--accent-yellow); }
        .brett-post .post-meta { font-size: 0.75rem; color: var(--text-secondary); }
        .brett-post .post-content { color: var(--text-primary); line-height: 1.5; margin: 0.75rem 0; white-space: pre-wrap; }
        .brett-post .post-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .kommentar { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; margin-left: 1rem; border-left: 2px solid var(--border-color); }
        .kommentar .kom-header { display: flex; justify-content: space-between; font-size: 0.8rem; }
        .kommentar .kom-autor { font-weight: 600; color: var(--accent-blue); }
        .kommentar .kom-date { color: var(--text-secondary); }
        .kommentar .kom-text { margin-top: 0.25rem; font-size: 0.9rem; }
        .kommentare-section { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); }
        .kommentar-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .kommentar-input input { flex: 1; padding: 0.5rem; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading"><div class="spinner"></div><div class="loading-text">Laden...</div></div>
    <div class="offline-banner" id="offline-banner">‚ö†Ô∏è Offline - Daten werden lokal gespeichert</div>
    
    <!-- Setup Screen -->
    <div class="setup-screen" id="setup-screen">
        <h1>üé∫ LKT TRACKER</h1>
        <p class="subtitle">Saison 2026</p>
        <div class="setup-box">
            <div id="setup-step-1" class="hidden"></div>
            <div id="setup-step-2" class="hidden">
                <h3 style="margin-bottom: 1rem;">Wer bist du?</h3>
                <div class="role-buttons">
                    <button class="role-btn" onclick="selectRole('member')">
                        <div class="icon">üé∫</div>
                        <div class="title">Mitglied</div>
                        <div class="desc">Anwesenheit tracken & Strafanzeigen erstellen</div>
                    </button>
                    <button class="role-btn" onclick="selectRole('gericht')">
                        <div class="icon">‚öñÔ∏è</div>
                        <div class="title">Hohes Gericht</div>
                        <div class="desc">Admin-Zugang mit speziellem PIN</div>
                    </button>
                </div>
            </div>
            <div id="setup-step-3" class="hidden">
                <h3 style="margin-bottom: 1rem;">üé∫ Mitglied Login</h3>
                <div class="input-group"><label>Dein Name</label><input type="text" id="member-name-input" placeholder="Max Mustermann"></div>
                <div class="input-group"><label>Deine PIN (4 Ziffern)</label><input type="number" id="member-pin-input" placeholder="1234" maxlength="4"></div>
                <button class="btn btn-primary btn-block" onclick="loginMember()">Einloggen</button>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem; text-align: center;">
                    Noch nicht registriert? <a href="#" onclick="showStep(4); return false;" style="color: var(--accent-yellow);">Hier registrieren</a>
                </p>
            </div>
            <div id="setup-step-4" class="hidden">
                <h3 style="margin-bottom: 1rem;">üé∫ Neu registrieren</h3>
                <div class="input-group"><label>Dein Name</label><input type="text" id="register-name-input" placeholder="Max Mustermann"></div>
                <div class="input-group"><label>W√§hle eine PIN (4 Ziffern)</label><input type="number" id="register-pin-input" placeholder="1234" maxlength="4"></div>
                <button class="btn btn-primary btn-block" onclick="registerMember()">Registrieren</button>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem; text-align: center;">
                    Bereits registriert? <a href="#" onclick="showStep(3); return false;" style="color: var(--accent-yellow);">Zum Login</a>
                </p>
            </div>
            <div id="setup-step-5" class="hidden">
                <h3 style="margin-bottom: 1rem;">‚öñÔ∏è Hohes Gericht Login</h3>
                <div class="input-group"><label>Gericht-PIN</label><input type="password" id="gericht-pin-input" placeholder="****"></div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">Nur f√ºr das Hohe Gericht</p>
                <button class="btn btn-primary btn-block" onclick="loginGericht()">Einloggen</button>
                <button class="btn btn-secondary btn-block" style="margin-top: 0.5rem;" onclick="showStep(2)">Zur√ºck</button>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="main-app" class="hidden">
        <div class="header">
            <h1>üé∫ LKT TRACKER 2026</h1>
            <div class="user-info" id="user-info">Mitglied</div>
        </div>
        
        <!-- Member Navigation -->
        <nav class="nav-tabs" id="member-nav">
            <button class="nav-tab active" data-tab="events">üìÖ Auftritte</button>
            <button class="nav-tab" data-tab="brett">üìã Brett</button>
            <button class="nav-tab" data-tab="scanner">üì∑ Scannen</button>
            <button class="nav-tab" data-tab="profile">üë§ Profil</button>
            <button class="nav-tab" data-tab="anzeige">‚öñÔ∏è Anzeige</button>
            <button class="nav-tab" data-tab="stats">üìä Stats</button>
        </nav>
        
        <!-- Gericht Navigation -->
        <nav class="nav-tabs hidden" id="gericht-nav">
            <button class="nav-tab active" data-tab="overview">üìä √úbersicht</button>
            <button class="nav-tab" data-tab="brett-gericht">üìã Brett</button>
            <button class="nav-tab" data-tab="attendance">‚úÖ Anwesenheit</button>
            <button class="nav-tab" data-tab="members">üë• Mitglieder</button>
            <button class="nav-tab" data-tab="anzeigen">‚öñÔ∏è Anzeigen</button>
            <button class="nav-tab" data-tab="rankings">üèÜ Ranglisten</button>
            <button class="nav-tab" data-tab="settings">‚öôÔ∏è Einstellungen</button>
        </nav>
        
        <!-- Member Screens -->
        <div id="member-screens">
            <!-- Events Tab -->
            <div id="events-tab" class="screen active">
                <div class="section-header"><h2>Deine Auftritte</h2></div>
                <div id="events-list"></div>
            </div>
            
            <!-- Schwarzes Brett Tab -->
            <div id="brett-tab" class="screen">
                <div class="section-header"><h2>üìã Schwarzes Brett</h2></div>
                <div class="card" id="new-post-form">
                    <h3 style="margin-bottom: 0.75rem; color: var(--accent-yellow);">‚úèÔ∏è Neuer Beitrag</h3>
                    <div class="input-group"><input type="text" id="post-titel" placeholder="Titel"></div>
                    <div class="input-group"><textarea id="post-inhalt" rows="3" placeholder="Was gibt's Neues?"></textarea></div>
                    <button class="btn btn-primary btn-block" onclick="submitBrettPost()">üì§ Ver√∂ffentlichen</button>
                </div>
                <div id="brett-posts-member"></div>
            </div>
            
            <!-- Scanner Tab -->
            <div id="scanner-tab" class="screen">
                <div class="section-header"><h2>üì∑ QR-Code Scannen</h2></div>
                <div class="info-box"><p>üì± Scanne den QR-Code beim Auftritt!</p></div>
                <div id="qr-reader" style="width: 100%; max-width: 400px; margin: 1rem auto;"></div>
                <button class="btn btn-primary btn-block" id="start-scan-btn" onclick="startScanner()">üì∑ Scanner starten</button>
                <button class="btn btn-secondary btn-block hidden" id="stop-scan-btn" onclick="stopScanner()">‚èπ Scanner stoppen</button>
                <div id="scan-success" class="hidden" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem;">‚úÖ</div>
                    <p style="font-size: 1.2rem; font-weight: 700; margin-top: 1rem;" id="success-text">Eingecheckt!</p>
                </div>
                <!-- Bus Selection Modal for Scan -->
                <div class="modal-overlay" id="bus-select-modal">
                    <div class="modal">
                        <h3>üöå Bus ausw√§hlen</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">W√§hle deinen Bus f√ºr diesen Auftritt:</p>
                        <div class="input-group">
                            <select id="checkin-bus-select"><option value="">-- Kein Bus --</option></select>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="cancelBusSelect()">Abbrechen</button>
                            <button class="btn btn-primary" onclick="confirmBusSelect()">Einchecken</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Tab (NEW) -->
            <div id="profile-tab" class="screen">
                <div class="section-header"><h2>üë§ Mein Profil</h2></div>
                <div class="card">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">üé∫</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="profile-name">-</div>
                    </div>
                    <div class="input-group">
                        <label>Mein fester Bus</label>
                        <select id="profile-bus"><option value="">-- Kein fester Bus --</option></select>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Optional - wird beim Einchecken vorausgef√ºllt</p>
                    </div>
                    <div class="input-group">
                        <label>Mein Register</label>
                        <select id="profile-register"><option value="">-- Register w√§hlen --</option></select>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="saveProfile()">üíæ Profil speichern</button>
                </div>
                <button class="btn btn-danger btn-block" style="margin-top: 1rem;" onclick="logout()">üö™ Ausloggen</button>
            </div>
            
            <!-- Anzeige Tab -->
            <div id="anzeige-tab" class="screen">
                <div class="section-header"><h2>‚öñÔ∏è Strafanzeige erstatten</h2></div>
                <div class="info-box" style="background: rgba(239,68,68,0.1); border-color: var(--accent-red);">
                    <p>üö® Entsprechend der Satzung des Vereins wird es dem Anzeigenden erm√∂glicht, einen Vorschlag f√ºr ein angemessenes Strafma√ü vorzuschlagen.</p>
                </div>
                <div class="input-group"><label>Name des Beschuldigten *</label><input type="text" id="anzeige-beschuldigter" placeholder="Wer hat was verbrochen?"></div>
                <div class="input-group"><label>Tatbestand *</label><textarea id="anzeige-tatbestand" rows="3" placeholder="Was ist passiert? Wann, wo?"></textarea></div>
                <div class="input-group"><label>Zeugen</label><input type="text" id="anzeige-zeugen" placeholder="Namen der Zeugen (optional)"></div>
                <div class="input-group"><label>Strafvorschlag *</label><input type="text" id="anzeige-strafe" placeholder="z.B. 1 Kasten Bier"></div>
                <button class="btn btn-danger btn-block" onclick="submitAnzeige()">‚öñÔ∏è Anzeige einreichen</button>
            </div>
            
            <!-- Stats Tab -->
            <div id="stats-tab" class="screen">
                <div class="section-header"><h2>Deine Statistik</h2></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="number" id="my-attended">0</div><div class="label">Teilgenommen</div></div>
                    <div class="stat-card"><div class="number" id="my-missed">0</div><div class="label">Verpasst</div></div>
                </div>
                <div class="stat-card" style="text-align: center;">
                    <div class="number" id="my-rate">0%</div><div class="label">Anwesenheitsquote</div>
                </div>
            </div>
        </div>
        
        <!-- Gericht Screens -->
        <div id="gericht-screens" class="hidden">
            <!-- Overview Tab -->
            <div id="overview-tab" class="screen active">
                <div class="section-header"><h2>üìä √úbersicht</h2></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="number" id="total-members">0</div><div class="label">Mitglieder</div></div>
                    <div class="stat-card"><div class="number" id="total-events">0</div><div class="label">Auftritte</div></div>
                    <div class="stat-card"><div class="number" id="total-checkins">0</div><div class="label">Check-ins</div></div>
                    <div class="stat-card"><div class="number" id="total-anzeigen">0</div><div class="label">Anzeigen</div></div>
                </div>
                <div class="stat-card" style="text-align: center;">
                    <div class="number" id="overall-rate">0%</div><div class="label">Gesamte Anwesenheitsquote</div>
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="refreshData()">üîÑ Daten aktualisieren</button>
                <button class="btn btn-secondary btn-block" style="margin-top: 0.5rem;" onclick="exportReportPDF()">üìÑ Saison-Report PDF</button>
                <div class="section-header"><h2>üöå Bus-Statistik</h2></div>
                <div id="bus-stats-list"></div>
                <button class="btn btn-secondary btn-block" onclick="exportBusStatsPDF()">üìÑ Bus-Statistik PDF</button>
                <div class="section-header"><h2>üéµ Register-Statistik</h2></div>
                <div id="register-stats-list"></div>
                <button class="btn btn-secondary btn-block" onclick="exportRegisterStatsPDF()">üìÑ Register-Statistik PDF</button>
            </div>
            
            <!-- Schwarzes Brett Tab (Gericht) -->
            <div id="brett-tab-gericht" class="screen">
                <div class="section-header"><h2>üìã Schwarzes Brett</h2></div>
                <div class="card">
                    <h3 style="margin-bottom: 0.75rem; color: var(--accent-yellow);">‚úèÔ∏è Neuer Beitrag</h3>
                    <div class="input-group"><input type="text" id="post-titel-gericht" placeholder="Titel"></div>
                    <div class="input-group"><textarea id="post-inhalt-gericht" rows="3" placeholder="Wichtige Mitteilung..."></textarea></div>
                    <button class="btn btn-primary btn-block" onclick="submitBrettPostGericht()">üì§ Ver√∂ffentlichen</button>
                </div>
                <div id="brett-posts-gericht"></div>
            </div>
            
            <!-- Attendance Tab -->
            <div id="attendance-tab" class="screen">
                <div class="section-header"><h2>‚úÖ Anwesenheitsverwaltung</h2></div>
                <div class="input-group">
                    <label>Auftritt ausw√§hlen</label>
                    <select id="attendance-event-select" onchange="loadEventAttendance()"><option value="">-- Auftritt w√§hlen --</option></select>
                </div>
                <div class="filter-row">
                    <select id="att-filter-register" onchange="renderAttendanceTable()"><option value="">Alle Register</option></select>
                    <select id="att-filter-week" onchange="renderAttendanceTable()"><option value="">Alle Wochenenden</option></select>
                </div>
                <div id="attendance-table-container" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                        <div>
                            <span style="color: var(--accent-green);">‚úì <span id="att-count-present">0</span></span> | 
                            <span style="color: var(--accent-red);">‚úó <span id="att-count-absent">0</span></span> | 
                            <span style="color: var(--accent-blue);">üìÖ <span id="att-count-planned">0</span></span> |
                            <span style="color: var(--text-secondary);">? <span id="att-count-unknown">0</span></span>
                        </div>
                        <button class="btn btn-secondary" onclick="saveAllAttendance()" style="padding: 0.5rem 1rem;">üíæ Speichern</button>
                    </div>
                    <div id="attendance-table" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- Members Tab -->
            <div id="members-tab" class="screen">
                <div class="section-header"><h2>üë• Mitglieder</h2></div>
                <div class="filter-row">
                    <select id="member-filter-register" onchange="filterMembersList()"><option value="">Alle Register</option></select>
                    <select id="member-filter-bus" onchange="filterMembersList()"><option value="">Alle Busse</option></select>
                </div>
                <button class="btn btn-secondary btn-block" style="margin-bottom: 1rem;" onclick="exportAllMembersPDF()">üìÑ Alle Mitglieder als PDF</button>
                <div id="members-list"></div>
            </div>
            
            <!-- Anzeigen Tab -->
            <div id="anzeigen-tab" class="screen">
                <div class="section-header"><h2>‚öñÔ∏è Strafanzeigen</h2></div>
                <button class="btn btn-secondary btn-block" style="margin-bottom: 1rem;" onclick="exportAnzeigenPDF()">üìÑ Anzeigen als PDF</button>
                <div id="anzeigen-list"></div>
            </div>
            
            <!-- Rankings Tab -->
            <div id="rankings-tab" class="screen">
                <div class="section-header"><h2>üèÜ Top 10 Flei√üigste</h2></div>
                <div id="top-attenders"></div>
                <div class="section-header"><h2>üò¥ Top 10 Faulste</h2></div>
                <div id="top-absent"></div>
            </div>
            
            <!-- Settings Tab (NEW) -->
            <div id="settings-tab" class="screen">
                <div class="section-header"><h2>‚öôÔ∏è Vereinseinstellungen</h2></div>
                
                <!-- Busse verwalten -->
                <div class="card">
                    <h3 style="color: var(--accent-blue); margin-bottom: 1rem;">üöå Busse verwalten</h3>
                    <div id="busse-list"></div>
                    <div class="input-group" style="margin-top: 1rem;">
                        <input type="text" id="new-bus-name" placeholder="Neuer Bus-Name (z.B. Bus 1)">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addNewBus()">+ Bus hinzuf√ºgen</button>
                </div>
                
                <!-- Register verwalten -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">üéµ Register verwalten</h3>
                    <div id="register-list"></div>
                    <div class="input-group" style="margin-top: 1rem;">
                        <input type="text" id="new-register-name" placeholder="Neues Register (z.B. Klarinette)">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addNewRegister()">+ Register hinzuf√ºgen</button>
                </div>
                
                <!-- Events verwalten -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 1rem;">üìÖ Veranstaltungen verwalten</h3>
                    <div class="input-group"><label>Name *</label><input type="text" id="new-event-name" placeholder="z.B. Extraauftritt"></div>
                    <div class="input-group"><label>Woche</label><input type="text" id="new-event-week" placeholder="z.B. WE 3 oder Extra"></div>
                    <div class="input-group"><label>Datum</label><input type="text" id="new-event-date" placeholder="TT.MM.JJJJ"></div>
                    <div class="input-group"><label>Ort</label><input type="text" id="new-event-location" placeholder="z.B. Vereinsheim"></div>
                    <div class="input-group"><label>Uhrzeit</label><input type="text" id="new-event-time" placeholder="z.B. 20:00"></div>
                    <button class="btn btn-primary btn-block" onclick="addNewEvent()">+ Event hinzuf√ºgen</button>
                    <div class="section-header"><h2>QR-Code f√ºr Event</h2></div>
                    <div class="input-group">
                        <select id="qr-event-select" onchange="showEventQR()"><option value="">-- Event f√ºr QR w√§hlen --</option></select>
                    </div>
                    <div id="event-qr-display" class="hidden" style="text-align: center; padding: 1rem;">
                        <div id="event-qr-canvas"></div>
                        <p style="margin-top: 0.5rem; font-weight: 700;" id="event-qr-label"></p>
                        <p style="font-size: 0.8rem; color: var(--text-secondary);" id="event-qr-sublabel"></p>
                        <button class="btn btn-secondary" onclick="downloadEventQR()">üì• QR herunterladen</button>
                    </div>
                </div>
                
                <button class="btn btn-danger btn-block" style="margin-top: 2rem;" onclick="logout()">üö™ Ausloggen</button>
            </div>
        </div>
    </div>
    
    <!-- Comment Modal -->
    <div class="modal-overlay" id="comment-modal">
        <div class="modal">
            <h3>Grund f√ºr Abwesenheit</h3>
            <div class="input-group"><textarea id="comment-input" rows="3" placeholder="Optional: Warum kannst du nicht?"></textarea></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveAbsent()">Speichern</button>
            </div>
        </div>
    </div>
    
    <!-- Member Detail Modal -->
    <div class="modal-overlay" id="member-detail-modal">
        <div class="modal" style="max-width: 500px;">
            <h3 id="member-detail-name">Mitglied</h3>
            <div style="margin: 0.5rem 0;">
                <span class="tag bus" id="member-detail-bus"></span>
                <span class="tag register" id="member-detail-register"></span>
            </div>
            <div class="stats-grid" style="margin: 1rem 0;">
                <div class="stat-card"><div class="number" id="member-detail-present">0</div><div class="label">Dabei</div></div>
                <div class="stat-card"><div class="number" id="member-detail-absent">0</div><div class="label">Gefehlt</div></div>
            </div>
            <div class="stat-card" style="text-align: center; margin-bottom: 1rem;">
                <div class="number" id="member-detail-rate">0%</div><div class="label">Anwesenheitsquote</div>
            </div>
            <div class="input-group" id="member-role-group">
                <label>Rolle √§ndern</label>
                <select id="member-detail-role">
                    <option value="mitglied">Mitglied</option>
                    <option value="chef">Chef (sieht alles au√üer Strafen)</option>
                    <option value="gericht">Hohes Gericht (voller Zugriff)</option>
                </select>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveMemberRole()" id="save-role-btn">Rolle speichern</button>
            <div class="section-header"><h2>Auftritte</h2></div>
            <div id="member-detail-events" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeMemberDetail()">Schlie√üen</button>
                <button class="btn btn-primary" onclick="exportMemberPDF()">üìÑ PDF</button>
            </div>
        </div>
    </div>
    
    <button class="config-btn" onclick="showConfig()">‚öôÔ∏è</button>
    <div class="toast" id="toast"></div>

    <script>
        // ============================================================
        // CONFIG & STATE
        // ============================================================
        const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbzl7-8o6KFvshHn37HaLe5U9WSLfPE1b1wlxFTHv6FNIC9C2nTF5189Cui-Aanx3fOt/exec';
        let API_URL = localStorage.getItem('lkt-api-url') || DEFAULT_API_URL;
        let currentUser = JSON.parse(localStorage.getItem('lkt-user') || 'null');
        let isOfflineMode = localStorage.getItem('lkt-offline') === 'true';
        
        // Data cache
        let eventsData = [];
        let attendanceData = {};
        let commentsData = {};
        let statsData = {};
        let busseData = [];
        let registerData = [];
        let geplantData = {};
        let allMembersData = [];
        let allMemberStats = {};
        let allAnzeigenData = [];
        let brettPostsData = [];
        let kommentareData = {};
        
        let currentAbsentEventId = null;
        let currentAttendanceEventId = null;
        let attendanceByMember = {};
        let geplantByMember = {};
        let pendingScanEventId = null;
        let currentDetailMember = null;
        
        let offlineQueue = JSON.parse(localStorage.getItem('lkt-offline-queue') || '[]');
        
        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            updateOnlineStatus();
            window.addEventListener('online', onOnline);
            window.addEventListener('offline', updateOnlineStatus);
            
            if (currentUser) {
                showMainApp();
            } else {
                hideLoading();
                showStep(2);
            }
        }
        
        function onOnline() {
            updateOnlineStatus();
            if (offlineQueue.length > 0 && navigator.onLine) syncOfflineQueue();
        }
        
        function updateOnlineStatus() {
            const banner = document.getElementById('offline-banner');
            if (!navigator.onLine) {
                banner.classList.add('show');
                banner.innerHTML = '‚ö†Ô∏è Offline - ' + offlineQueue.length + ' Aktion(en) warten';
            } else {
                if (offlineQueue.length > 0) {
                    banner.classList.add('show');
                    banner.innerHTML = 'üîÑ Synchronisiere...';
                    banner.style.background = '#4ade80';
                } else {
                    banner.classList.remove('show');
                    banner.style.background = '#ef4444';
                }
            }
        }
        
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
        
        // ============================================================
        // OFFLINE QUEUE
        // ============================================================
        function addToOfflineQueue(action) {
            offlineQueue.push({ ...action, timestamp: Date.now(), id: Date.now() + '-' + Math.random().toString(36).substr(2, 9) });
            localStorage.setItem('lkt-offline-queue', JSON.stringify(offlineQueue));
            updateOnlineStatus();
        }
        
        async function syncOfflineQueue() {
            if (offlineQueue.length === 0 || !navigator.onLine) return;
            showToast('Synchronisiere ' + offlineQueue.length + ' Aktion(en)...');
            const queue = [...offlineQueue];
            let successCount = 0;
            for (const item of queue) {
                try {
                    const result = await apiPost(item.action);
                    if (!result.error) {
                        offlineQueue = offlineQueue.filter(q => q.id !== item.id);
                        successCount++;
                    }
                } catch (e) { console.error('Sync error:', e); }
            }
            localStorage.setItem('lkt-offline-queue', JSON.stringify(offlineQueue));
            updateOnlineStatus();
            if (successCount > 0) { showToast('‚úì ' + successCount + ' synchronisiert!'); loadData(); }
        }
        
        // ============================================================
        // API FUNCTIONS
        // ============================================================
        async function apiGet(action, params = {}) {
            let url = API_URL + '?action=' + action;
            for (const [key, value] of Object.entries(params)) {
                url += '&' + key + '=' + encodeURIComponent(value);
            }
            const response = await fetch(url);
            return await response.json();
        }
        
        async function apiPost(data) {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
            return await response.json();
        }
        
        // ============================================================
        // SETUP & LOGIN
        // ============================================================
        function showStep(step) {
            for (let i = 1; i <= 5; i++) document.getElementById('setup-step-' + i).classList.add('hidden');
            document.getElementById('setup-step-' + step).classList.remove('hidden');
        }
        
        function selectRole(role) { showStep(role === 'member' ? 3 : 5); }
        
        async function registerMember() {
            const name = document.getElementById('register-name-input').value.trim();
            const pin = document.getElementById('register-pin-input').value.trim();
            if (!name || !pin || pin.length !== 4) { showToast('Name und 4-stellige PIN erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'registerMember', name: name, pin: pin });
                if (result.error) { showToast(result.error, true); hideLoading(); return; }
                currentUser = { role: 'member', name: name, pin: pin };
                localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                showToast('Erfolgreich registriert!');
                showMainApp();
            } catch (e) { showToast('Fehler: ' + e.message, true); hideLoading(); }
        }
        
        async function loginMember() {
            const name = document.getElementById('member-name-input').value.trim();
            const pin = document.getElementById('member-pin-input').value.trim();
            if (!name || !pin || pin.length !== 4) { showToast('Name und 4-stellige PIN erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiGet('getMemberAttendance', { name: name });
                if (result.error) { showToast('Name nicht gefunden', true); hideLoading(); return; }
                if (String(result.pin) !== String(pin)) { showToast('Falscher PIN', true); hideLoading(); return; }
                
                // Rolle bestimmt die Ansicht
                const rolle = result.rolle || 'mitglied';
                if (rolle === 'gericht' || rolle === 'chef') {
                    currentUser = { role: 'gericht', name: result.name, pin: pin, actualRole: rolle, busId: result.busId, registerId: result.registerId };
                } else {
                    currentUser = { role: 'member', name: result.name, pin: pin, actualRole: 'mitglied', busId: result.busId, registerId: result.registerId };
                }
                
                localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                showToast('Willkommen, ' + result.name + '!');
                showMainApp();
            } catch (e) { showToast('Fehler: ' + e.message, true); hideLoading(); }
        }
        
        function loginGericht() {
            const pin = document.getElementById('gericht-pin-input').value.trim();
            
            if (pin === '8356') {
                currentUser = { role: 'gericht', name: 'Hohes Gericht', actualRole: 'gericht' };
            } else {
                showToast('Falscher PIN', true); return;
            }
            localStorage.setItem('lkt-user', JSON.stringify(currentUser));
            showToast('Willkommen, Hohes Gericht!');
            showMainApp();
        }
        
        function logout() {
            if (!confirm('Wirklich ausloggen?')) return;
            localStorage.removeItem('lkt-user');
            currentUser = null;
            location.reload();
        }
        
        // ============================================================
        // MAIN APP
        // ============================================================
        async function showMainApp() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            attendanceData = {};
            commentsData = {};
            
            const userInfo = document.getElementById('user-info');
            
            if (currentUser.role === 'gericht') {
                if (currentUser.actualRole === 'chef') {
                    userInfo.textContent = 'üëî ' + currentUser.name + ' (Chef)';
                    userInfo.classList.add('chef');
                } else {
                    userInfo.textContent = '‚öñÔ∏è ' + currentUser.name;
                    userInfo.classList.add('gericht');
                }
                document.getElementById('member-nav').classList.add('hidden');
                document.getElementById('gericht-nav').classList.remove('hidden');
                document.getElementById('member-screens').classList.add('hidden');
                document.getElementById('gericht-screens').classList.remove('hidden');
                
                // Hide Anzeigen for Chef
                if (currentUser.actualRole === 'chef') {
                    document.querySelector('[data-tab="anzeigen"]').classList.add('hidden');
                }
                
                initGerichtNav();
            } else {
                userInfo.textContent = 'üë§ ' + currentUser.name;
                initMemberNav();
                eventsData = getOfflineEvents();
                loadLocalAttendance();
                renderMemberView();
            }
            
            hideLoading();
            loadData();
        }
        
        function initMemberNav() {
            const tabs = document.querySelectorAll('#member-nav .nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('#member-screens .screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                    
                    // Scanner-Handling bei Tab-Wechsel
                    if (tab.dataset.tab === 'scanner') {
                        if (scannerRunning) {
                            resumeScanner();
                        } else {
                            // Automatisch starten beim ersten Besuch
                            setTimeout(initScanner, 300);
                        }
                    } else {
                        pauseScanner();
                    }
                });
            });
        }
        
        function initGerichtNav() {
            const tabs = document.querySelectorAll('#gericht-nav .nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('#gericht-screens .screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });
        }
        
        // ============================================================
        // DATA LOADING
        // ============================================================
        async function loadData() {
            try {
                // Load busse and register first
                if (navigator.onLine && !isOfflineMode) {
                    try {
                        const busseResult = await apiGet('getBusse');
                        busseData = busseResult.busse || [];
                        const registerResult = await apiGet('getRegister');
                        registerData = registerResult.register || [];
                    } catch (e) { console.log('Could not load busse/register'); }
                }
                
                // Load events
                if (!isOfflineMode && navigator.onLine) {
                    try {
                        const eventsResult = await apiGet('getEvents');
                        if (eventsResult.events) eventsData = eventsResult.events;
                    } catch (e) { eventsData = getOfflineEvents(); }
                }
                if (eventsData.length === 0) eventsData = getOfflineEvents();
                
                if (currentUser.role === 'member') {
                    if (!isOfflineMode && navigator.onLine) {
                        try {
                            const attResult = await apiGet('getMemberAttendance', { name: currentUser.name });
                            if (!attResult.error) {
                                attendanceData = attResult.attendance || {};
                                commentsData = attResult.comments || {};
                                currentUser.busId = attResult.busId;
                                currentUser.registerId = attResult.registerId;
                                localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                                saveLocalAttendance();
                            }
                            // Load geplante teilnahme
                            const geplantResult = await apiGet('getGeplanteTeilnahme');
                            geplantData = geplantResult.geplant || {};
                        } catch (e) { loadLocalAttendance(); }
                        if (offlineQueue.length > 0) syncOfflineQueue();
                    } else { loadLocalAttendance(); }
                    renderMemberView();
                    populateProfileSelects();
                    loadBrettPosts('member');
                } else {
                    if (!isOfflineMode && navigator.onLine) {
                        try { statsData = await apiGet('getStats'); } catch (e) {}
                    }
                    renderGerichtView();
                }
            } catch (e) {
                console.error('loadData error:', e);
                if (eventsData.length === 0) eventsData = getOfflineEvents();
            }
        }
        
        async function refreshData() { showLoading(); await loadData(); hideLoading(); showToast('Daten aktualisiert'); }
        
        // ============================================================
        // MEMBER VIEW
        // ============================================================
        function renderMemberView() {
            renderEventsList();
            updateMemberStats();
            document.getElementById('profile-name').textContent = currentUser.name;
        }
        
        function renderEventsList() {
            const container = document.getElementById('events-list');
            let html = '';
            let currentWeek = '';
            
            eventsData.forEach(event => {
                if (event.week !== currentWeek) {
                    currentWeek = event.week;
                    html += '<div class="week-header">' + currentWeek + '</div>';
                }
                
                const status = attendanceData[event.id];
                const isAttended = status === true;
                const isAbsent = status === false;
                const isPlanned = geplantData[event.id] && geplantData[event.id][currentUser.name];
                
                let cardClass = 'card event-card';
                if (isAttended) cardClass += ' attended';
                else if (isAbsent) cardClass += ' absent';
                else if (isPlanned) cardClass += ' planned';
                
                html += '<div class="' + cardClass + '">';
                html += '<div class="date">' + (event.date || '') + ' ‚Ä¢ ' + (event.time || '') + '</div>';
                html += '<div class="title">' + event.name + '</div>';
                html += '<div class="location">üìç ' + (event.location || 'TBA') + '</div>';
                
                if (isAttended) html += '<span class="status present">‚úì Teilgenommen</span>';
                if (isAbsent) html += '<span class="status absent">‚úó Nicht dabei</span>';
                if (isPlanned && !isAttended && !isAbsent) html += '<span class="status planned">üìÖ Geplant</span>';
                
                html += '<div class="actions">';
                if (!isAttended && !isAbsent) {
                    html += '<button class="btn plan-btn ' + (isPlanned ? 'active' : 'btn-secondary') + '" onclick="toggleGeplant(\'' + event.id + '\')">' + (isPlanned ? 'üìÖ Geplant' : 'üìÖ Planen') + '</button>';
                    html += '<button class="btn btn-danger" onclick="markAbsentEvent(\'' + event.id + '\')">‚úó Absagen</button>';
                } else {
                    html += '<button class="btn btn-secondary" onclick="resetEvent(\'' + event.id + '\')">‚Ü© Zur√ºcksetzen</button>';
                }
                html += '</div></div>';
            });
            
            container.innerHTML = html || '<div class="empty-state">Keine Auftritte</div>';
        }
        
        function updateMemberStats() {
            const attended = Object.values(attendanceData).filter(v => v === true).length;
            const absent = Object.values(attendanceData).filter(v => v === false).length;
            const total = attended + absent;
            const rate = total > 0 ? Math.round(attended / total * 100) : 0;
            document.getElementById('my-attended').textContent = attended;
            document.getElementById('my-missed').textContent = absent;
            document.getElementById('my-rate').textContent = rate + '%';
        }
        
        // ============================================================
        // GEPLANTE TEILNAHME
        // ============================================================
        async function toggleGeplant(eventId) {
            const current = geplantData[eventId] && geplantData[eventId][currentUser.name];
            const newValue = !current;
            
            if (!geplantData[eventId]) geplantData[eventId] = {};
            geplantData[eventId][currentUser.name] = newValue;
            renderEventsList();
            
            if (navigator.onLine && !isOfflineMode) {
                try {
                    await apiPost({ action: 'setGeplanteTeilnahme', name: currentUser.name, eventId: eventId, geplant: newValue });
                } catch (e) { console.error('Geplant error:', e); }
            }
        }
        
        // ============================================================
        // PROFILE
        // ============================================================
        function populateProfileSelects() {
            const busSelect = document.getElementById('profile-bus');
            const regSelect = document.getElementById('profile-register');
            const checkinBusSelect = document.getElementById('checkin-bus-select');
            
            busSelect.innerHTML = '<option value="">-- Kein fester Bus --</option>';
            checkinBusSelect.innerHTML = '<option value="">-- Kein Bus --</option>';
            busseData.forEach(b => {
                busSelect.innerHTML += '<option value="' + b.id + '">' + b.name + '</option>';
                checkinBusSelect.innerHTML += '<option value="' + b.id + '">' + b.name + '</option>';
            });
            
            regSelect.innerHTML = '<option value="">-- Register w√§hlen --</option>';
            registerData.forEach(r => {
                regSelect.innerHTML += '<option value="' + r.id + '">' + r.name + '</option>';
            });
            
            if (currentUser.busId) busSelect.value = currentUser.busId;
            if (currentUser.registerId) regSelect.value = currentUser.registerId;
        }
        
        async function saveProfile() {
            const busId = document.getElementById('profile-bus').value;
            const registerId = document.getElementById('profile-register').value;
            showLoading();
            try {
                const result = await apiPost({ action: 'updateMemberProfile', name: currentUser.name, busId: busId, registerId: registerId });
                if (result.error) { showToast(result.error, true); }
                else {
                    currentUser.busId = busId;
                    currentUser.registerId = registerId;
                    localStorage.setItem('lkt-user', JSON.stringify(currentUser));
                    showToast('Profil gespeichert!');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // MEMBER ACTIONS
        // ============================================================
        function saveLocalAttendance() {
            if (!currentUser || !currentUser.name) return;
            localStorage.setItem('lkt-attendance-' + currentUser.name, JSON.stringify(attendanceData));
            localStorage.setItem('lkt-comments-' + currentUser.name, JSON.stringify(commentsData));
        }
        
        function loadLocalAttendance() {
            if (!currentUser || !currentUser.name) return;
            const local = localStorage.getItem('lkt-attendance-' + currentUser.name);
            const localComments = localStorage.getItem('lkt-comments-' + currentUser.name);
            if (local) attendanceData = { ...attendanceData, ...JSON.parse(local) };
            if (localComments) commentsData = { ...commentsData, ...JSON.parse(localComments) };
        }
        
        function markAbsentEvent(eventId) {
            currentAbsentEventId = eventId;
            document.getElementById('comment-input').value = '';
            document.getElementById('comment-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('comment-modal').classList.remove('active');
            currentAbsentEventId = null;
        }
        
        async function saveAbsent() {
            if (!currentAbsentEventId) return;
            const comment = document.getElementById('comment-input').value.trim();
            const eventId = currentAbsentEventId;
            closeModal();
            
            attendanceData[eventId] = false;
            commentsData[eventId] = comment;
            saveLocalAttendance();
            renderMemberView();
            
            if (navigator.onLine && !isOfflineMode) {
                try {
                    await apiPost({ action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment });
                    showToast('Als abwesend markiert');
                } catch (e) {
                    addToOfflineQueue({ action: { action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment } });
                    showToast('üì¥ Offline gespeichert');
                }
            } else {
                addToOfflineQueue({ action: { action: 'markAbsent', name: currentUser.name, eventId: eventId, comment: comment } });
            }
        }
        
        async function resetEvent(eventId) {
            if (!confirm('Status zur√ºcksetzen?')) return;
            delete attendanceData[eventId];
            delete commentsData[eventId];
            saveLocalAttendance();
            renderMemberView();
            showToast('Zur√ºckgesetzt');
            
            if (navigator.onLine && !isOfflineMode) {
                try { await apiPost({ action: 'resetAttendance', name: currentUser.name, eventId: eventId }); }
                catch (e) { addToOfflineQueue({ action: { action: 'resetAttendance', name: currentUser.name, eventId: eventId } }); }
            } else {
                addToOfflineQueue({ action: { action: 'resetAttendance', name: currentUser.name, eventId: eventId } });
            }
        }
        
        // ============================================================
        // QR SCANNER
        // ============================================================
        let html5QrCode = null;
        let scannerRunning = false;
        
        function initScanner() {
            // Scanner beim ersten Mal automatisch starten
            if (!html5QrCode && !scannerRunning) {
                startScanner();
            }
        }
        
        function startScanner() {
            if (scannerRunning) return;
            
            document.getElementById('start-scan-btn').classList.add('hidden');
            document.getElementById('stop-scan-btn').classList.remove('hidden');
            document.getElementById('scan-success').classList.add('hidden');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                () => {}
            ).then(() => {
                scannerRunning = true;
            }).catch(err => {
                console.error('Scanner error:', err);
                showToast('Kamera-Zugriff fehlgeschlagen', true);
                stopScanner();
            });
        }
        
        function stopScanner() {
            if (html5QrCode && scannerRunning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    scannerRunning = false;
                }).catch(() => {
                    scannerRunning = false;
                });
            }
            document.getElementById('start-scan-btn').classList.remove('hidden');
            document.getElementById('stop-scan-btn').classList.add('hidden');
        }
        
        function pauseScanner() {
            // Scanner nur pausieren, nicht komplett stoppen
            if (html5QrCode && scannerRunning) {
                try {
                    html5QrCode.pause(true);
                } catch (e) {}
            }
        }
        
        function resumeScanner() {
            // Scanner fortsetzen wenn er l√§uft
            if (html5QrCode && scannerRunning) {
                try {
                    html5QrCode.resume();
                } catch (e) {}
            }
        }
        
        async function onScanSuccess(decodedText) {
            if (decodedText.startsWith('LKT-EVENT:')) {
                const eventId = decodedText.replace('LKT-EVENT:', '');
                const event = eventsData.find(e => e.id === eventId);
                
                if (event) {
                    if (attendanceData[eventId] === true) {
                        showToast('Bereits eingecheckt!', true);
                        return;
                    }
                    pauseScanner(); // Nur pausieren w√§hrend Check-in
                    
                    // Check if member has fixed bus
                    if (currentUser.busId) {
                        // Has fixed bus - check in directly
                        await checkInEvent(eventId, currentUser.busId);
                        showScanSuccess(event.name);
                    } else {
                        // No fixed bus - show bus selection
                        pendingScanEventId = eventId;
                        document.getElementById('checkin-bus-select').value = '';
                        document.getElementById('bus-select-modal').classList.add('active');
                    }
                } else {
                    showToast('Unbekannter Auftritt', true);
                }
            }
        }
        
        function cancelBusSelect() {
            document.getElementById('bus-select-modal').classList.remove('active');
            pendingScanEventId = null;
            resumeScanner(); // Scanner wieder fortsetzen
        }
        
        async function confirmBusSelect() {
            const busId = document.getElementById('checkin-bus-select').value;
            const eventId = pendingScanEventId;
            document.getElementById('bus-select-modal').classList.remove('active');
            
            if (eventId) {
                const event = eventsData.find(e => e.id === eventId);
                await checkInEvent(eventId, busId);
                showScanSuccess(event ? event.name : 'Auftritt');
            }
            pendingScanEventId = null;
        }
        
        async function checkInEvent(eventId, busId) {
            attendanceData[eventId] = true;
            delete commentsData[eventId];
            saveLocalAttendance();
            renderMemberView();
            
            if (navigator.onLine && !isOfflineMode) {
                try {
                    await apiPost({ action: 'checkIn', name: currentUser.name, eventId: eventId, busId: busId || '' });
                    showToast('‚úì Eingecheckt!');
                } catch (e) {
                    addToOfflineQueue({ action: { action: 'checkIn', name: currentUser.name, eventId: eventId, busId: busId || '' } });
                    showToast('üì¥ Offline gespeichert');
                }
            } else {
                addToOfflineQueue({ action: { action: 'checkIn', name: currentUser.name, eventId: eventId, busId: busId || '' } });
            }
        }
        
        function showScanSuccess(eventName) {
            document.getElementById('success-text').textContent = eventName + ' - Eingecheckt!';
            document.getElementById('scan-success').classList.remove('hidden');
            pauseScanner(); // Nur pausieren
            
            setTimeout(() => {
                document.getElementById('scan-success').classList.add('hidden');
                document.querySelectorAll('#member-nav .nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-tab="events"]').classList.add('active');
                document.querySelectorAll('#member-screens .screen').forEach(s => s.classList.remove('active'));
                document.getElementById('events-tab').classList.add('active');
            }, 2000);
        }
        
        // ============================================================
        // ANZEIGEN
        // ============================================================
        async function submitAnzeige() {
            const beschuldigter = document.getElementById('anzeige-beschuldigter').value.trim();
            const tatbestand = document.getElementById('anzeige-tatbestand').value.trim();
            const zeugen = document.getElementById('anzeige-zeugen').value.trim();
            const strafe = document.getElementById('anzeige-strafe').value.trim();
            
            if (!beschuldigter || !tatbestand || !strafe) { showToast('Pflichtfelder ausf√ºllen!', true); return; }
            showLoading();
            try {
                const result = await apiPost({
                    action: 'submitAnzeige', melder: currentUser.name, beschuldigter: beschuldigter,
                    tatbestand: tatbestand, zeugen: zeugen, strafe: strafe
                });
                if (result.error) { showToast(result.error, true); }
                else {
                    showToast('Anzeige eingereicht!');
                    document.getElementById('anzeige-beschuldigter').value = '';
                    document.getElementById('anzeige-tatbestand').value = '';
                    document.getElementById('anzeige-zeugen').value = '';
                    document.getElementById('anzeige-strafe').value = '';
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // GERICHT VIEW
        // ============================================================
        async function renderGerichtView() {
            populateAttendanceEventSelect();
            populateQREventSelect();
            populateFilters();
            renderBusseList();
            renderRegisterList();
            
            document.getElementById('total-members').textContent = statsData.totalMembers || 0;
            document.getElementById('total-events').textContent = statsData.totalEvents || 0;
            document.getElementById('total-checkins').textContent = statsData.totalAttended || 0;
            document.getElementById('total-anzeigen').textContent = statsData.totalAnzeigen || 0;
            document.getElementById('overall-rate').textContent = (statsData.attendanceRate || 0) + '%';
            
            try {
                const membersResult = await apiGet('getMembers');
                allMembersData = membersResult.members || [];
                allMemberStats = statsData.memberStats || {};
                allMembersData.forEach(m => { if (!allMemberStats[m.name]) allMemberStats[m.name] = { attended: 0, absent: 0 }; });
                renderMembersList(allMembersData);
                
                if (currentUser.actualRole !== 'chef') {
                    const anzeigeResult = await apiGet('getAnzeigen');
                    allAnzeigenData = anzeigeResult.anzeigen || [];
                    renderAnzeigenList(allAnzeigenData);
                }
                
                renderRankings(statsData.topAttenders || [], statsData.topAbsent || []);
                
                // Load bus and register stats
                const busStatsResult = await apiGet('getBusStats');
                renderBusStats(busStatsResult.busStats || []);
                
                const regStatsResult = await apiGet('getRegisterStats');
                renderRegisterStats(regStatsResult.registerStats || []);
                
                // Load Brett
                loadBrettPosts('gericht');
            } catch (e) { console.error('Gericht view error:', e); }
        }
        
        function populateFilters() {
            const regFilter = document.getElementById('att-filter-register');
            const memberRegFilter = document.getElementById('member-filter-register');
            const memberBusFilter = document.getElementById('member-filter-bus');
            const weekFilter = document.getElementById('att-filter-week');
            
            let regHtml = '<option value="">Alle Register</option>';
            registerData.forEach(r => { regHtml += '<option value="' + r.id + '">' + r.name + '</option>'; });
            regFilter.innerHTML = regHtml;
            memberRegFilter.innerHTML = regHtml;
            
            let busHtml = '<option value="">Alle Busse</option>';
            busseData.forEach(b => { busHtml += '<option value="' + b.id + '">' + b.name + '</option>'; });
            memberBusFilter.innerHTML = busHtml;
            
            const weeks = [...new Set(eventsData.map(e => e.week))];
            let weekHtml = '<option value="">Alle Wochenenden</option>';
            weeks.forEach(w => { weekHtml += '<option value="' + w + '">' + w + '</option>'; });
            weekFilter.innerHTML = weekHtml;
        }
        
        function populateAttendanceEventSelect() {
            const select = document.getElementById('attendance-event-select');
            let html = '<option value="">-- Auftritt w√§hlen --</option>';
            let currentWeek = '';
            eventsData.forEach(event => {
                if (event.week !== currentWeek) {
                    if (currentWeek !== '') html += '</optgroup>';
                    currentWeek = event.week;
                    html += '<optgroup label="' + currentWeek + '">';
                }
                html += '<option value="' + event.id + '">' + (event.date || '') + ' - ' + event.name + '</option>';
            });
            if (currentWeek !== '') html += '</optgroup>';
            select.innerHTML = html;
        }
        
        function populateQREventSelect() {
            const select = document.getElementById('qr-event-select');
            let html = '<option value="">-- Event w√§hlen --</option>';
            eventsData.forEach(e => { html += '<option value="' + e.id + '">' + (e.date || '') + ' - ' + e.name + '</option>'; });
            select.innerHTML = html;
        }
        
        // ============================================================
        // ATTENDANCE MANAGEMENT
        // ============================================================
        async function loadEventAttendance() {
            const eventId = document.getElementById('attendance-event-select').value;
            const container = document.getElementById('attendance-table-container');
            
            if (!eventId) { container.classList.add('hidden'); return; }
            
            currentAttendanceEventId = eventId;
            container.classList.remove('hidden');
            document.getElementById('attendance-table').innerHTML = '<div style="text-align: center; padding: 2rem;">Laden...</div>';
            
            attendanceByMember = {};
            geplantByMember = {};
            
            try {
                const result = await apiGet('getEventAttendance', { eventId: eventId });
                if (result.attendance) attendanceByMember = result.attendance;
                
                const geplantResult = await apiGet('getGeplanteTeilnahme', { eventId: eventId });
                geplantByMember = geplantResult.geplant || {};
            } catch (e) { console.log('Could not load attendance'); }
            
            renderAttendanceTable();
        }
        
        function renderAttendanceTable() {
            const container = document.getElementById('attendance-table');
            const regFilter = document.getElementById('att-filter-register').value;
            
            let filteredMembers = allMembersData;
            if (regFilter) filteredMembers = filteredMembers.filter(m => m.registerId === regFilter);
            
            let html = '';
            filteredMembers.forEach(member => {
                const isPresent = attendanceByMember[member.name] === true;
                const isAbsent = attendanceByMember[member.name] === false;
                const isPlanned = geplantByMember[member.name] === true;
                
                let tags = '';
                if (member.busId) {
                    const bus = busseData.find(b => b.id === member.busId);
                    if (bus) tags += '<span class="tag bus">' + bus.name + '</span>';
                }
                if (member.registerId) {
                    const reg = registerData.find(r => r.id === member.registerId);
                    if (reg) tags += '<span class="tag register">' + reg.name + '</span>';
                }
                
                let statusText = '';
                if (isPlanned && !isPresent && !isAbsent) statusText = '<span style="color: var(--accent-blue); font-size: 0.75rem; margin-left: 0.5rem;">üìÖ Geplant</span>';
                
                html += '<div class="attendance-row">';
                html += '<div class="member-name">' + member.name + tags + statusText + '</div>';
                html += '<div class="attendance-buttons">';
                html += '<button class="att-btn ' + (isPresent ? 'present' : '') + '" onclick="setMemberAttendance(\'' + member.name.replace(/'/g, "\\'") + '\', true)">‚úì</button>';
                html += '<button class="att-btn ' + (isAbsent ? 'absent' : '') + '" onclick="setMemberAttendance(\'' + member.name.replace(/'/g, "\\'") + '\', false)">‚úó</button>';
                html += '</div></div>';
            });
            
            container.innerHTML = html || '<div class="empty-state">Keine Mitglieder</div>';
            updateAttendanceCounts();
        }
        
        function setMemberAttendance(memberName, isPresent) {
            const current = attendanceByMember[memberName];
            if ((isPresent && current === true) || (!isPresent && current === false)) {
                delete attendanceByMember[memberName];
            } else {
                attendanceByMember[memberName] = isPresent;
            }
            renderAttendanceTable();
        }
        
        function updateAttendanceCounts() {
            let present = 0, absent = 0, planned = 0, unknown = 0;
            allMembersData.forEach(member => {
                const status = attendanceByMember[member.name];
                if (status === true) present++;
                else if (status === false) absent++;
                else {
                    if (geplantByMember[member.name]) planned++;
                    else unknown++;
                }
            });
            document.getElementById('att-count-present').textContent = present;
            document.getElementById('att-count-absent').textContent = absent;
            document.getElementById('att-count-planned').textContent = planned;
            document.getElementById('att-count-unknown').textContent = unknown;
        }
        
        async function saveAllAttendance() {
            if (!currentAttendanceEventId) { showToast('Kein Auftritt ausgew√§hlt', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'saveEventAttendance', eventId: currentAttendanceEventId, attendance: attendanceByMember });
                if (result.error) showToast(result.error, true);
                else showToast('‚úì Anwesenheit gespeichert!');
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // MEMBERS LIST
        // ============================================================
        function renderMembersList(members) {
            const container = document.getElementById('members-list');
            if (members.length === 0) { container.innerHTML = '<div class="empty-state">Keine Mitglieder</div>'; return; }
            
            let html = '';
            members.forEach(m => {
                const stats = allMemberStats[m.name] || { attended: 0, absent: 0 };
                const total = stats.attended + stats.absent;
                const rate = total > 0 ? Math.round(stats.attended / total * 100) : 0;
                
                let tags = '';
                if (m.busId) {
                    const bus = busseData.find(b => b.id === m.busId);
                    if (bus) tags += '<span class="tag bus">' + bus.name + '</span>';
                }
                if (m.registerId) {
                    const reg = registerData.find(r => r.id === m.registerId);
                    if (reg) tags += '<span class="tag register">' + reg.name + '</span>';
                }
                
                html += '<div class="card" style="cursor: pointer;" onclick="showMemberDetail(\'' + m.name.replace(/'/g, "\\'") + '\')">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 700;">' + m.name + tags + '</div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary);">‚úì ' + stats.attended + ' | ‚úó ' + stats.absent + ' | ' + rate + '%</div></div>';
                html += '<div style="display: flex; gap: 0.5rem;">';
                html += '<button class="btn btn-danger" style="padding: 0.5rem 0.75rem;" onclick="event.stopPropagation(); deleteMember(\'' + m.name.replace(/'/g, "\\'") + '\')">üóëÔ∏è</button>';
                html += '</div></div></div>';
            });
            container.innerHTML = html;
        }
        
        function filterMembersList() {
            const regFilter = document.getElementById('member-filter-register').value;
            const busFilter = document.getElementById('member-filter-bus').value;
            
            let filtered = allMembersData;
            if (regFilter) filtered = filtered.filter(m => m.registerId === regFilter);
            if (busFilter) filtered = filtered.filter(m => m.busId === busFilter);
            
            renderMembersList(filtered);
        }
        
        async function showMemberDetail(name) {
            currentDetailMember = name;
            showLoading();
            try {
                const result = await apiGet('getMemberAttendance', { name: name });
                if (result.error) { showToast(result.error, true); hideLoading(); return; }
                
                const attendance = result.attendance || {};
                let present = 0, absent = 0;
                Object.values(attendance).forEach(s => { if (s === true) present++; else if (s === false) absent++; });
                
                const member = allMembersData.find(m => m.name === name);
                let busTag = '', regTag = '';
                if (member && member.busId) {
                    const bus = busseData.find(b => b.id === member.busId);
                    if (bus) busTag = 'üöå ' + bus.name;
                }
                if (member && member.registerId) {
                    const reg = registerData.find(r => r.id === member.registerId);
                    if (reg) regTag = 'üéµ ' + reg.name;
                }
                
                let eventsHtml = '';
                eventsData.forEach(event => {
                    const status = attendance[event.id];
                    if (status === true) {
                        eventsHtml += '<div class="card event-card attended" style="padding: 0.5rem; margin-bottom: 0.5rem;">';
                        eventsHtml += '<div style="font-size: 0.8rem; color: var(--text-secondary);">' + (event.date || '') + '</div>';
                        eventsHtml += '<div style="font-weight: 600;">' + event.name + '</div>';
                        eventsHtml += '<span class="status present">‚úì Dabei</span></div>';
                    } else if (status === false) {
                        eventsHtml += '<div class="card event-card absent" style="padding: 0.5rem; margin-bottom: 0.5rem;">';
                        eventsHtml += '<div style="font-size: 0.8rem; color: var(--text-secondary);">' + (event.date || '') + '</div>';
                        eventsHtml += '<div style="font-weight: 600;">' + event.name + '</div>';
                        eventsHtml += '<span class="status absent">‚úó Gefehlt</span></div>';
                    }
                });
                
                const total = present + absent;
                const rate = total > 0 ? Math.round(present / total * 100) : 0;
                
                document.getElementById('member-detail-name').textContent = name;
                document.getElementById('member-detail-bus').textContent = busTag;
                document.getElementById('member-detail-bus').style.display = busTag ? 'inline-block' : 'none';
                document.getElementById('member-detail-register').textContent = regTag;
                document.getElementById('member-detail-register').style.display = regTag ? 'inline-block' : 'none';
                document.getElementById('member-detail-present').textContent = present;
                document.getElementById('member-detail-absent').textContent = absent;
                document.getElementById('member-detail-rate').textContent = rate + '%';
                document.getElementById('member-detail-events').innerHTML = eventsHtml || '<div class="empty-state">Keine Eintr√§ge</div>';
                
                // Set current role
                if (member) document.getElementById('member-detail-role').value = member.rolle || 'mitglied';
                
                // Show/hide role editing based on user role
                const canEditRole = currentUser.actualRole === 'gericht';
                document.getElementById('member-role-group').style.display = canEditRole ? 'block' : 'none';
                document.getElementById('save-role-btn').style.display = canEditRole ? 'block' : 'none';
                
                document.getElementById('member-detail-modal').classList.add('active');
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        function closeMemberDetail() {
            document.getElementById('member-detail-modal').classList.remove('active');
            currentDetailMember = null;
        }
        
        async function saveMemberRole() {
            if (!currentDetailMember) return;
            const role = document.getElementById('member-detail-role').value;
            showLoading();
            try {
                const result = await apiPost({ action: 'updateMemberRole', name: currentDetailMember, role: role });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Rolle aktualisiert!');
                    const member = allMembersData.find(m => m.name === currentDetailMember);
                    if (member) member.rolle = role;
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteMember(name) {
            if (!confirm(name + ' wirklich l√∂schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteMember', name: name });
                if (result.error) showToast(result.error, true);
                else { showToast(result.message); await refreshData(); }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // BUSSE & REGISTER MANAGEMENT
        // ============================================================
        function renderBusseList() {
            const container = document.getElementById('busse-list');
            if (busseData.length === 0) { container.innerHTML = '<div class="empty-state">Keine Busse</div>'; return; }
            let html = '';
            busseData.forEach(b => {
                html += '<div class="list-item"><span class="name">üöå ' + b.name + '</span>';
                html += '<button class="btn btn-danger" style="padding: 0.3rem 0.5rem; font-size: 0.8rem;" onclick="deleteBus(\'' + b.id + '\')">üóëÔ∏è</button></div>';
            });
            container.innerHTML = html;
        }
        
        function renderRegisterList() {
            const container = document.getElementById('register-list');
            if (registerData.length === 0) { container.innerHTML = '<div class="empty-state">Keine Register</div>'; return; }
            let html = '';
            registerData.forEach(r => {
                html += '<div class="list-item"><span class="name">üéµ ' + r.name + '</span>';
                html += '<button class="btn btn-danger" style="padding: 0.3rem 0.5rem; font-size: 0.8rem;" onclick="deleteRegister(\'' + r.id + '\')">üóëÔ∏è</button></div>';
            });
            container.innerHTML = html;
        }
        
        async function addNewBus() {
            const name = document.getElementById('new-bus-name').value.trim();
            if (!name) { showToast('Bus-Name erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'addBus', name: name });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Bus hinzugef√ºgt!');
                    document.getElementById('new-bus-name').value = '';
                    const busseResult = await apiGet('getBusse');
                    busseData = busseResult.busse || [];
                    renderBusseList();
                    populateFilters();
                    populateProfileSelects();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteBus(id) {
            if (!confirm('Bus wirklich l√∂schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteBus', id: id });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Bus gel√∂scht!');
                    busseData = busseData.filter(b => b.id !== id);
                    renderBusseList();
                    populateFilters();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function addNewRegister() {
            const name = document.getElementById('new-register-name').value.trim();
            if (!name) { showToast('Register-Name erforderlich', true); return; }
            showLoading();
            try {
                const result = await apiPost({ action: 'addRegister', name: name });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Register hinzugef√ºgt!');
                    document.getElementById('new-register-name').value = '';
                    const regResult = await apiGet('getRegister');
                    registerData = regResult.register || [];
                    renderRegisterList();
                    populateFilters();
                    populateProfileSelects();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deleteRegister(id) {
            if (!confirm('Register wirklich l√∂schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteRegister', id: id });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Register gel√∂scht!');
                    registerData = registerData.filter(r => r.id !== id);
                    renderRegisterList();
                    populateFilters();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // EVENTS MANAGEMENT
        // ============================================================
        async function addNewEvent() {
            const name = document.getElementById('new-event-name').value.trim();
            if (!name) { showToast('Event-Name erforderlich', true); return; }
            
            const eventData = {
                name: name,
                week: document.getElementById('new-event-week').value.trim(),
                date: document.getElementById('new-event-date').value.trim(),
                location: document.getElementById('new-event-location').value.trim(),
                time: document.getElementById('new-event-time').value.trim()
            };
            
            showLoading();
            try {
                const result = await apiPost({ action: 'addEvent', event: eventData });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Event hinzugef√ºgt!');
                    document.getElementById('new-event-name').value = '';
                    document.getElementById('new-event-week').value = '';
                    document.getElementById('new-event-date').value = '';
                    document.getElementById('new-event-location').value = '';
                    document.getElementById('new-event-time').value = '';
                    await refreshData();
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        // ============================================================
        // STATISTICS DISPLAY
        // ============================================================
        function renderBusStats(stats) {
            const container = document.getElementById('bus-stats-list');
            if (stats.length === 0) { container.innerHTML = '<div class="empty-state">Keine Bus-Statistiken</div>'; return; }
            let html = '';
            stats.forEach(s => {
                const total = s.attended + s.absent;
                const rate = total > 0 ? Math.round(s.attended / total * 100) : 0;
                html += '<div class="card"><div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 700;">üöå ' + s.name + '</div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary);">‚úì ' + s.attended + ' | ‚úó ' + s.absent + '</div></div>';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-yellow);">' + rate + '%</div>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function renderRegisterStats(stats) {
            const container = document.getElementById('register-stats-list');
            if (stats.length === 0) { container.innerHTML = '<div class="empty-state">Keine Register-Statistiken</div>'; return; }
            let html = '';
            stats.forEach(s => {
                const total = s.attended + s.absent;
                const rate = total > 0 ? Math.round(s.attended / total * 100) : 0;
                html += '<div class="card"><div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 700;">üéµ ' + s.name + ' <span style="font-size: 0.8rem; color: var(--text-secondary);">(' + s.memberCount + ' Mitglieder)</span></div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary);">‚úì ' + s.attended + ' | ‚úó ' + s.absent + '</div></div>';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-yellow);">' + rate + '%</div>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function renderAnzeigenList(anzeigen) {
            const container = document.getElementById('anzeigen-list');
            if (anzeigen.length === 0) { container.innerHTML = '<div class="empty-state">Keine Anzeigen</div>'; return; }
            let html = '';
            anzeigen.forEach(a => {
                html += '<div class="anzeige-card"><div class="header">';
                html += '<span class="vs">' + a.melder + ' ‚öîÔ∏è ' + a.beschuldigter + '</span>';
                html += '<span class="date">' + a.datum + '</span></div>';
                html += '<div class="tatbestand">' + a.tatbestand + '</div>';
                if (a.zeugen) html += '<div style="font-size: 0.8rem; color: var(--text-secondary);">Zeugen: ' + a.zeugen + '</div>';
                html += '<div class="strafe">Strafvorschlag: ' + a.strafe + '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function renderRankings(topAttenders, topAbsent) {
            const attendersContainer = document.getElementById('top-attenders');
            const absentContainer = document.getElementById('top-absent');
            
            if (topAttenders.length === 0) {
                attendersContainer.innerHTML = '<div class="empty-state">Keine Daten</div>';
            } else {
                attendersContainer.innerHTML = topAttenders.map((m, i) => 
                    '<div class="leaderboard-item"><div class="rank">' + (i + 1) + '</div><div class="name">' + m.name + '</div><div class="score">' + m.attended + ' ‚úì</div></div>'
                ).join('');
            }
            
            if (topAbsent.length === 0) {
                absentContainer.innerHTML = '<div class="empty-state">Keine Daten</div>';
            } else {
                absentContainer.innerHTML = topAbsent.map((m, i) => 
                    '<div class="leaderboard-item"><div class="rank">' + (i + 1) + '</div><div class="name">' + m.name + '</div><div class="score bad">' + m.absent + ' ‚úó</div></div>'
                ).join('');
            }
        }
        
        // ============================================================
        // QR CODE GENERATION
        // ============================================================
        function showEventQR() {
            const eventId = document.getElementById('qr-event-select').value;
            if (!eventId) { document.getElementById('event-qr-display').classList.add('hidden'); return; }
            
            const event = eventsData.find(e => e.id === eventId);
            if (!event) return;
            
            const qrData = 'LKT-EVENT:' + eventId;
            const container = document.getElementById('event-qr-canvas');
            
            try {
                const qr = qrcode(0, 'M');
                qr.addData(qrData);
                qr.make();
                container.innerHTML = qr.createImgTag(6, 8);
                
                document.getElementById('event-qr-display').classList.remove('hidden');
                document.getElementById('event-qr-label').textContent = event.name;
                document.getElementById('event-qr-sublabel').textContent = (event.date || '') + ' ‚Ä¢ ' + (event.time || '') + ' ‚Ä¢ ' + (event.location || '');
            } catch (e) { showToast('QR-Fehler', true); }
        }
        
        function downloadEventQR() {
            const img = document.querySelector('#event-qr-canvas img');
            if (!img) return;
            const link = document.createElement('a');
            link.download = 'LKT_QR_' + document.getElementById('qr-event-select').value + '.png';
            link.href = img.src;
            link.click();
        }
        
        // ============================================================
        // SCHWARZES BRETT
        // ============================================================
        async function loadBrettPosts(view) {
            try {
                const result = await apiGet('getBrettPosts');
                brettPostsData = result.posts || [];
                
                // Load all comments
                const komResult = await apiGet('getKommentare');
                kommentareData = {};
                (komResult.kommentare || []).forEach(k => {
                    if (!kommentareData[k.postId]) kommentareData[k.postId] = [];
                    kommentareData[k.postId].push(k);
                });
                
                renderBrettPosts(view);
            } catch (e) { console.error('Brett load error:', e); }
        }
        
        function renderBrettPosts(view) {
            const container = document.getElementById(view === 'gericht' ? 'brett-posts-gericht' : 'brett-posts-member');
            if (!container) return;
            
            if (brettPostsData.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Beitr√§ge</div>';
                return;
            }
            
            const canDelete = currentUser.role === 'gericht';
            let html = '';
            
            brettPostsData.forEach(post => {
                const date = new Date(post.erstelltAm);
                const dateStr = date.toLocaleDateString('de-DE') + ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const kommentare = kommentareData[post.id] || [];
                
                html += '<div class="brett-post" id="post-' + post.id + '">';
                html += '<div class="post-header">';
                html += '<div class="post-title">' + escapeHtml(post.titel) + '</div>';
                if (canDelete) {
                    html += '<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deletePost(\'' + post.id + '\')">üóëÔ∏è</button>';
                }
                html += '</div>';
                html += '<div class="post-meta">üë§ ' + escapeHtml(post.autor) + ' ‚Ä¢ ' + dateStr + '</div>';
                html += '<div class="post-content">' + escapeHtml(post.inhalt) + '</div>';
                
                // Kommentare
                html += '<div class="kommentare-section">';
                html += '<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üí¨ ' + kommentare.length + ' Kommentar' + (kommentare.length !== 1 ? 'e' : '') + '</div>';
                
                kommentare.forEach(k => {
                    const kDate = new Date(k.erstelltAm);
                    const kDateStr = kDate.toLocaleDateString('de-DE') + ' ' + kDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    html += '<div class="kommentar">';
                    html += '<div class="kom-header"><span class="kom-autor">' + escapeHtml(k.autor) + '</span><span class="kom-date">' + kDateStr + '</span></div>';
                    html += '<div class="kom-text">' + escapeHtml(k.text) + '</div>';
                    html += '</div>';
                });
                
                // Kommentar-Eingabe
                html += '<div class="kommentar-input">';
                html += '<input type="text" id="kom-input-' + post.id + '" placeholder="Kommentar schreiben..." onkeypress="if(event.key===\'Enter\')addComment(\'' + post.id + '\')">';
                html += '<button class="btn btn-primary" style="padding: 0.5rem 0.75rem;" onclick="addComment(\'' + post.id + '\')">üí¨</button>';
                html += '</div>';
                html += '</div>'; // kommentare-section
                html += '</div>'; // brett-post
            });
            
            container.innerHTML = html;
        }
        
        async function submitBrettPost() {
            const titel = document.getElementById('post-titel').value.trim();
            const inhalt = document.getElementById('post-inhalt').value.trim();
            if (!titel || !inhalt) { showToast('Titel und Inhalt erforderlich', true); return; }
            
            showLoading();
            try {
                const result = await apiPost({ action: 'addBrettPost', autor: currentUser.name, titel: titel, inhalt: inhalt });
                if (result.error) { showToast(result.error, true); }
                else {
                    showToast('Beitrag ver√∂ffentlicht!');
                    document.getElementById('post-titel').value = '';
                    document.getElementById('post-inhalt').value = '';
                    await loadBrettPosts('member');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function submitBrettPostGericht() {
            const titel = document.getElementById('post-titel-gericht').value.trim();
            const inhalt = document.getElementById('post-inhalt-gericht').value.trim();
            if (!titel || !inhalt) { showToast('Titel und Inhalt erforderlich', true); return; }
            
            showLoading();
            try {
                const result = await apiPost({ action: 'addBrettPost', autor: currentUser.name, titel: titel, inhalt: inhalt });
                if (result.error) { showToast(result.error, true); }
                else {
                    showToast('Beitrag ver√∂ffentlicht!');
                    document.getElementById('post-titel-gericht').value = '';
                    document.getElementById('post-inhalt-gericht').value = '';
                    await loadBrettPosts('gericht');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function deletePost(postId) {
            if (!confirm('Beitrag wirklich l√∂schen?')) return;
            showLoading();
            try {
                const result = await apiPost({ action: 'deleteBrettPost', postId: postId });
                if (result.error) showToast(result.error, true);
                else {
                    showToast('Beitrag gel√∂scht');
                    await loadBrettPosts(currentUser.role === 'gericht' ? 'gericht' : 'member');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
            hideLoading();
        }
        
        async function addComment(postId) {
            const input = document.getElementById('kom-input-' + postId);
            const text = input.value.trim();
            if (!text) return;
            
            try {
                const result = await apiPost({ action: 'addKommentar', postId: postId, autor: currentUser.name, text: text });
                if (result.error) { showToast(result.error, true); }
                else {
                    input.value = '';
                    // Kommentar lokal hinzuf√ºgen f√ºr schnelle Anzeige
                    if (!kommentareData[postId]) kommentareData[postId] = [];
                    kommentareData[postId].push({ id: result.id, postId: postId, autor: currentUser.name, text: text, erstelltAm: new Date().toISOString() });
                    renderBrettPosts(currentUser.role === 'gericht' ? 'gericht' : 'member');
                }
            } catch (e) { showToast('Fehler: ' + e.message, true); }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============================================================
        // PDF EXPORTS
        // ============================================================
        function exportReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Saison-Report 2026', 105, 30, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let y = 55;
            doc.text('Mitglieder: ' + (statsData.totalMembers || 0), 20, y);
            doc.text('Auftritte: ' + (statsData.totalEvents || 0), 105, y);
            y += 10;
            doc.text('Check-ins: ' + (statsData.totalAttended || 0), 20, y);
            doc.text('Abwesenheiten: ' + (statsData.totalAbsent || 0), 105, y);
            y += 10;
            doc.text('Anwesenheitsquote: ' + (statsData.attendanceRate || 0) + '%', 20, y);
            
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('LKT Tracker 2026 - Erstellt: ' + new Date().toLocaleDateString('de-DE'), 105, 285, { align: 'center' });
            
            doc.save('LKT_Saison_Report_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportBusStatsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Bus-Statistik 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            doc.setFillColor(59, 130, 246);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('Bus', 20, y);
            doc.text('Dabei', 100, y);
            doc.text('Gefehlt', 130, y);
            doc.text('Quote', 165, y);
            
            y += 15;
            doc.setTextColor(0, 0, 0);
            
            busseData.forEach(bus => {
                const total = bus.attended + bus.absent;
                const rate = total > 0 ? Math.round(bus.attended / total * 100) : 0;
                doc.text(bus.name, 20, y);
                doc.text(String(bus.attended || 0), 105, y);
                doc.text(String(bus.absent || 0), 135, y);
                doc.text(rate + '%', 167, y);
                y += 8;
            });
            
            doc.save('LKT_Bus_Statistik_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportRegisterStatsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Register-Statistik 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            doc.setFillColor(139, 92, 246);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('Register', 20, y);
            doc.text('Mitglieder', 80, y);
            doc.text('Dabei', 115, y);
            doc.text('Gefehlt', 145, y);
            doc.text('Quote', 175, y);
            
            y += 15;
            doc.setTextColor(0, 0, 0);
            
            registerData.forEach(reg => {
                const total = reg.attended + reg.absent;
                const rate = total > 0 ? Math.round(reg.attended / total * 100) : 0;
                doc.text(reg.name, 20, y);
                doc.text(String(reg.memberCount || 0), 90, y);
                doc.text(String(reg.attended || 0), 120, y);
                doc.text(String(reg.absent || 0), 150, y);
                doc.text(rate + '%', 177, y);
                y += 8;
            });
            
            doc.save('LKT_Register_Statistik_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportAllMembersPDF() {
            if (allMembersData.length === 0) { showToast('Keine Mitglieder', true); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Mitglieder-√úbersicht 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            doc.setFillColor(26, 26, 46);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(10);
            doc.text('Name', 20, y);
            doc.text('Dabei', 100, y);
            doc.text('Gefehlt', 130, y);
            doc.text('Quote', 165, y);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            const sortedMembers = allMembersData.map(m => {
                const stats = allMemberStats[m.name] || { attended: 0, absent: 0 };
                const total = stats.attended + stats.absent;
                const rate = total > 0 ? Math.round(stats.attended / total * 100) : 0;
                return { ...m, ...stats, rate };
            }).sort((a, b) => b.attended - a.attended);
            
            sortedMembers.forEach((m, i) => {
                if (y > 270) { doc.addPage(); y = 20; }
                if (i % 2 === 0) { doc.setFillColor(245, 245, 245); doc.rect(15, y - 4, 180, 8, 'F'); }
                doc.setTextColor(0, 0, 0);
                doc.text(m.name.substring(0, 30), 20, y);
                doc.setTextColor(74, 222, 128);
                doc.text(String(m.attended), 105, y);
                doc.setTextColor(239, 68, 68);
                doc.text(String(m.absent), 135, y);
                doc.setTextColor(0, 0, 0);
                doc.text(m.rate + '%', 167, y);
                y += 8;
            });
            
            doc.save('LKT_Alle_Mitglieder_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportMemberPDF() {
            if (!currentDetailMember) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text(currentDetailMember, 105, 30, { align: 'center' });
            
            const present = parseInt(document.getElementById('member-detail-present').textContent);
            const absent = parseInt(document.getElementById('member-detail-absent').textContent);
            const rate = document.getElementById('member-detail-rate').textContent;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let y = 55;
            doc.text('Dabei: ' + present + '  |  Gefehlt: ' + absent + '  |  Quote: ' + rate, 105, y, { align: 'center' });
            
            doc.save('LKT_' + currentDetailMember.replace(/\s/g, '_') + '_Report.pdf');
            showToast('PDF erstellt!');
        }
        
        function exportAnzeigenPDF() {
            if (allAnzeigenData.length === 0) { showToast('Keine Anzeigen', true); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LUMPENKAPELLE TALDORF', 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.text('Strafanzeigen 2026', 105, 30, { align: 'center' });
            
            let y = 55;
            allAnzeigenData.forEach((a, i) => {
                if (y > 240) { doc.addPage(); y = 20; }
                doc.setFillColor(255, 240, 240);
                doc.setDrawColor(239, 68, 68);
                doc.rect(15, y - 5, 180, 40, 'FD');
                doc.setTextColor(239, 68, 68);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Anzeige #' + (i + 1), 20, y + 2);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(a.melder + ' vs. ' + a.beschuldigter, 20, y + 12);
                doc.setFontSize(9);
                doc.text('Tatbestand: ' + (a.tatbestand || '').substring(0, 70), 20, y + 22);
                doc.setTextColor(239, 68, 68);
                doc.setFont(undefined, 'bold');
                doc.text('Strafe: ' + a.strafe, 20, y + 32);
                y += 50;
            });
            
            doc.save('LKT_Strafanzeigen_2026.pdf');
            showToast('PDF erstellt!');
        }
        
        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + (isError ? 'error' : 'success');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        
        function showConfig() {
            const newUrl = prompt('API URL (leer lassen f√ºr Standard):', API_URL);
            if (newUrl !== null) {
                API_URL = newUrl || DEFAULT_API_URL;
                localStorage.setItem('lkt-api-url', API_URL);
                showToast('API URL aktualisiert');
            }
        }
        
        function getOfflineEvents() {
            return [
                { id: 'WE1-1', week: 'WE 1', date: '09.01.2026', name: 'Narrenbaumstellen Taldorf', location: 'LK Taldorf', time: '' },
                { id: 'WE1-2', week: 'WE 1', date: '10.01.2026', name: 'Narrenbaumstellen Taldorf', location: 'LK Taldorf', time: '' },
                { id: 'WE1-3', week: 'WE 1', date: '11.01.2026', name: 'Narrenbaumstellen Taldorf', location: 'LK Taldorf', time: '' },
                { id: 'WE2-1', week: 'WE 2', date: '16.01.2026', name: 'Jugendball Bitzenhofen', location: 'NZ Bitzenhofen', time: '21:00' },
                { id: 'WE2-2', week: 'WE 2', date: '16.01.2026', name: 'Elchball', location: 'MV Ettenkirch', time: '00:30' },
                { id: 'WE2-3', week: 'WE 2', date: '17.01.2026', name: 'Umzug Neuravensburg', location: 'NZ Neuravensburg B√§ren', time: '13:30' },
                { id: 'WE2-4', week: 'WE 2', date: '17.01.2026', name: 'Butzlumpa-Ball', location: 'LaJu KO/LK Butzlumpa', time: '21:00' },
                { id: 'WE2-5', week: 'WE 2', date: '17.01.2026', name: 'M√§dla-Ball', location: 'LK Leupolz', time: '23:00' },
                { id: 'WE2-6', week: 'WE 2', date: '18.01.2026', name: 'Umzug Langenargen', location: 'NZ Dammglonker', time: '13:00' },
                { id: 'WE3-1', week: 'WE 3', date: '23.01.2026', name: 'Urknall-Ball', location: 'LK Allgaier Urband', time: '20:00' },
                { id: 'WE3-2', week: 'WE 3', date: '23.01.2026', name: 'Interne Veranstaltung', location: 'LK F√∂tzlesbrass', time: '00:00' },
                { id: 'WE3-3', week: 'WE 3', date: '24.01.2026', name: 'Jubil√§umsumzug Erbisreute', location: 'Erbisreuter Dorfnarren', time: '13:00' },
                { id: 'WE3-4', week: 'WE 3', date: '25.01.2026', name: 'Narrensprung Kluftern', location: 'NZ Kluftern', time: '13:30' },
                { id: 'WE4-1', week: 'WE 4', date: '30.01.2026', name: 'Zirkusball', location: 'LK Mecka', time: '23:30' },
                { id: 'WE4-2', week: 'WE 4', date: '31.01.2026', name: 'Narrenbaumstellen Bitzenhofen', location: 'NZ Bitzenhofen', time: '13:00' },
                { id: 'WE5-1', week: 'WE 5', date: '07.02.2026', name: 'D√§mmerumzug Hergensweiler', location: 'NZ Federfuxer', time: '16:00' },
                { id: 'WE5-2', week: 'WE 5', date: '07.02.2026', name: 'Apr√©s-Ski Ball', location: 'NZ Ettenkirch', time: '23:30' },
                { id: 'WE5-3', week: 'WE 5', date: '08.02.2026', name: 'Umzug Meersburg', location: 'NZ Meersburg', time: '13:00' },
                { id: 'HF-1', week: 'Hauptfasnet', date: '11.02.2026', name: 'Weiberball', location: 'L√∂wen Urnau', time: '22:00' },
                { id: 'HF-2', week: 'Hauptfasnet', date: '12.02.2026', name: 'Golm', location: 'Berggasthof Golm', time: '11:00' },
                { id: 'HF-3', week: 'Hauptfasnet', date: '13.02.2026', name: 'Kindergartenbefreiung', location: 'Taldorf', time: '09:00' },
                { id: 'HF-4', week: 'Hauptfasnet', date: '13.02.2026', name: 'Sch√ºlerbefreiung', location: 'Wilhelmsschule RV', time: '10:00' },
                { id: 'HF-5', week: 'Hauptfasnet', date: '13.02.2026', name: 'OWB', location: 'OWB Ravensburg', time: '11:30' },
                { id: 'HF-6', week: 'Hauptfasnet', date: '13.02.2026', name: 'Narrenbaumstellen Bavendorf', location: 'NV Bavendorf', time: '14:00' },
                { id: 'HF-7', week: 'Hauptfasnet', date: '14.02.2026', name: 'Narrensprung Aitrach', location: 'NZ Aitrach', time: '13:30' },
                { id: 'HF-8', week: 'Hauptfasnet', date: '14.02.2026', name: 'Ball Aitrach', location: 'NZ Aitrach', time: '23:30' },
                { id: 'HF-9', week: 'Hauptfasnet', date: '15.02.2026', name: 'Narrensprung Brochenzell', location: 'NZ Brochenzell', time: '14:00' },
                { id: 'HF-10', week: 'Hauptfasnet', date: '16.02.2026', name: 'Rosenmontagssprung Fulda', location: 'Wolkenkratzer Fulda', time: '13:30' },
                { id: 'HF-11', week: 'Hauptfasnet', date: '17.02.2026', name: 'Heimfahrt Fulda', location: '', time: '' },
            ];
        }
    </script>
</body>
</html>
